<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Mysql/高级特性/索引与查询优化">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">索引与查询优化 | 花裤衩Wiki</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://huakucha.com/img/fav.png"><meta data-rh="true" name="twitter:image" content="https://huakucha.com/img/fav.png"><meta data-rh="true" property="og:url" content="https://huakucha.com/docs/Mysql/高级特性/索引与查询优化"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="索引与查询优化 | 花裤衩Wiki"><meta data-rh="true" name="description" content="都有哪些维度可以进行数据库调优?大体上说:"><meta data-rh="true" property="og:description" content="都有哪些维度可以进行数据库调优?大体上说:"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://huakucha.com/docs/Mysql/高级特性/索引与查询优化"><link data-rh="true" rel="alternate" href="https://huakucha.com/docs/Mysql/高级特性/索引与查询优化" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://huakucha.com/docs/Mysql/高级特性/索引与查询优化" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://QZ9YPBGUYT-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="花裤衩Wiki RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="花裤衩Wiki Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="花裤衩Wiki JSON Feed">




<link rel="search" type="application/opensearchdescription+xml" title="花裤衩Wiki" href="/opensearch.xml">

<link rel="preconnect" href="https://fonts.gstatic.com">
<link rel="stylesheet" href="https://fonts.font.im/css?family=Raleway:500,700&amp;display=swap"><link rel="stylesheet" href="/assets/css/styles.864d50a7.css">
<link rel="preload" href="/assets/js/runtime~main.bf86732a.js" as="script">
<link rel="preload" href="/assets/js/main.98457ee6.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a href="#" class="skipToContent_D8pK">跳到主要内容</a></div><div class="announcementBar_s0pr" style="background-color:#fafbfc;color:#091E42" role="banner"><div class="announcementBarPlaceholder_qxfj"></div><div class="content_zf74 announcementBarContent_dpRF">🌟欢迎来到花裤衩的博客🌟</div><button type="button" aria-label="关闭" class="clean-btn close closeButton_ZdWa announcementBarClose_iXyO"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="花裤衩的博客" class="themedImage_Pn4p themedImage--light_PnYV"><img src="/img/logo.svg" alt="花裤衩的博客" class="themedImage_Pn4p themedImage--dark_eYgw"></div><b class="navbar__title text--truncate">花裤衩</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">基础知识🤖</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/currency">并发编程</a></li><li><a class="dropdown__link" href="/docs/networrk-basic">计算机网络</a></li><li><a class="dropdown__link" href="/docs/linuxCommand">Linux</a></li><li><a class="dropdown__link" href="/docs/dataStructure">数据结构与算法</a></li><li><a class="dropdown__link" href="/docs/leetCode">LeetCode</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/mysql">MySQL</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">后端框架👨‍💻</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/spring">Spring</a></li><li><a class="dropdown__link" href="/docs/springCloud">SpringCloud</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">方法论🚧</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/distribute/protol">分布式理论</a></li><li><a class="dropdown__link" href="/docs/distribute/basicTech">分布式技术点</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">中间件🚀</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/middleware/basicMiddleware">基础中间件</a></li><li><a class="dropdown__link" href="/docs/middleware/job">定时任务</a></li><li><a class="dropdown__link" href="/docs/middleware/cache">缓存</a></li><li><a class="dropdown__link" href="/docs/middleware/searchEngine">搜索引擎</a></li><li><a class="dropdown__link" href="/docs/middleware/messageQueue">消息队列</a></li><li><a class="dropdown__link" href="/docs/middleware/database">数据库</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">底层⛽️</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/JVM">JVM</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">前端技术👩‍💻</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/front/Vue">Vue</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">其他工具👹</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/Gradle">Gradle</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">物料中心👏</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/website/BE">后端产品</a></li><li><a class="dropdown__link" href="/website/COM">其他产品</a></li><li><a class="dropdown__link" href="/website/FE">前端产品</a></li></ul></div><a class="navbar__item navbar__link" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a href="https://blog.huakucha.top" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">关于<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_2l9O"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/MagicalZhu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_MW0i colorModeToggle_x44X"><button class="clean-btn toggleButton_yw5v toggleButtonDisabled_BJd7" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_SFTY"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_ekgs"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_H2mL"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_eExm docsWrapper_W2AM"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_ntye" type="button"></button><div class="docPage_qMb8"><aside class="theme-doc-sidebar-container docSidebarContainer_rpaz"><div class="sidebar_mhZE"><nav class="menu thin-scrollbar menu_Y1UP menuWithAnnouncementBar_fPny"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/mysql">简介</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/mysql基础与高级">MySQL基础与高级</a><button aria-label="打开/收起侧边栏菜单「MySQL基础与高级」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/基础知识">基础知识</a><button aria-label="打开/收起侧边栏菜单「基础知识」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/数据库管理">数据库管理</a><button aria-label="打开/收起侧边栏菜单「数据库管理」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/架构与引擎">架构与引擎</a><button aria-label="打开/收起侧边栏菜单「架构与引擎」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/存储结构与索引">存储结构与索引</a><button aria-label="打开/收起侧边栏菜单「存储结构与索引」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/性能优化">性能优化</a><button aria-label="打开/收起侧边栏菜单「性能优化」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/性能分析工具">性能分析工具</a><button aria-label="打开/收起侧边栏菜单「性能分析工具」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Mysql/高级特性/性能监控工具">性能监控工具</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Mysql/高级特性/索引与查询优化">索引与查询优化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Mysql/高级特性/数据库设计规范">数据库设计规范</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Mysql/高级特性/数据库其他调优策略">数据库其他调优策略</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/事务与锁">事务与锁</a><button aria-label="打开/收起侧边栏菜单「事务与锁」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/运维">运维</a><button aria-label="打开/收起侧边栏菜单「运维」" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Mysql/MySQL参数与命令">MySQL参数与命令</a></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_JQG6"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_Iseg"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_RiV8"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Alpn" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_SLhD"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/mysql基础与高级"><span itemprop="name">MySQL基础与高级</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/性能优化"><span itemprop="name">性能优化</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">索引与查询优化</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_IbkY theme-doc-toc-mobile tocMobile_bxCs"><button type="button" class="clean-btn tocCollapsibleButton_p7nN">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>索引与查询优化</h1></header><blockquote><p>都有哪些维度可以进行数据库调优?大体上说:</p><ol><li>索引失效或没有充分利用到索引 – 建立/优化索引</li><li>关联太多的 JOIN (设计缺陷或不得已的需求) - sql 优化</li><li>服务器调优及各个参数的设置(缓冲、线程池等) - 调整 my.cnf</li><li>数据过多 – 分库分表</li></ol></blockquote><p>关于数据库调优的策略比较散,不同的 DBMS 都不一样。但是大方向主要分为<code>物理查询优化</code>和<code>逻辑查询优化</code>两块:</p><ol><li>物理查询优化: 通过<code>索引</code>或者 <code>表连接方式</code>等技术来进行优化,重点就是索引的使用</li><li>逻辑查询优化: 通过 sql<code>等价变化</code>来提升查询效率,也就是换种效率更高一点的 sql 查询</li></ol><p><strong>相关的博客内容</strong></p><ol><li><a href="https://juejin.cn/post/6844903967193825294#heading-0" target="_blank" rel="noopener noreferrer">MySQL索引问题</a></li><li><a href="https://juejin.cn/post/6844903692966215693#heading-0" target="_blank" rel="noopener noreferrer">MySQL实验</a></li><li><a href="https://blog.csdn.net/weixin_37692493/article/details/115050308" target="_blank" rel="noopener noreferrer">MySQLSQL排序优化</a></li><li><a href="https://juejin.cn/post/6844904073955639304" target="_blank" rel="noopener noreferrer">联合索引在B+树上的存储结构及数据查找方式</a></li><li><a href="https://juejin.cn/post/6844904072089174023" target="_blank" rel="noopener noreferrer">MySQL索引底层数据结构及原理深入分析</a></li><li><a href="https://juejin.cn/post/7090478072117329934" target="_blank" rel="noopener noreferrer">MySQL索引分类</a></li></ol><h2 class="anchor anchorWithStickyNavbar_loeA" id="数据准备">数据准备<a class="hash-link" href="#数据准备" title="标题的直接链接">​</a></h2><p><strong>1.建表</strong></p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token identifier">class</span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        </span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">11</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain">    </span><span class="token operator" style="color:rgb(12, 150, 155)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">KEY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">AUTO_INCREMENT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token identifier">className</span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token plain">     </span><span class="token keyword" style="color:rgb(12, 150, 155)">VARCHAR</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">30</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">NULL</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token identifier">address</span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token plain">       </span><span class="token keyword" style="color:rgb(12, 150, 155)">VARCHAR</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">40</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">NULL</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token identifier">monitor</span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token plain">       </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">NULL</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">ENGINE</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token keyword" style="color:rgb(12, 150, 155)">INNODB</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">AUTO_INCREMENT</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token identifier">student</span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token plain">        </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">11</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">KEY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">AUTO_INCREMENT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token identifier">stuno</span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token plain">         </span><span class="token operator" style="color:rgb(12, 150, 155)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">NULL</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token identifier">name</span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">VARCHAR</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">20</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">NULL</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token identifier">age</span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token plain">   </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">3</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain">      </span><span class="token keyword" style="color:rgb(12, 150, 155)">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">NULL</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token identifier">classId</span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">11</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">ENGINE</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token keyword" style="color:rgb(12, 150, 155)">INNODB</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">AUTO_INCREMENT</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.创建函数</strong></p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- 设置信任函数创建</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">set</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">global</span><span class="token plain"> log_bin_trust_function_creators</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal"># 随机产生字符串</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FUNCTION</span><span class="token plain"> rand_string</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">n </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">RETURNS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">VARCHAR</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">255</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">DECLARE</span><span class="token plain"> chars_str </span><span class="token keyword" style="color:rgb(12, 150, 155)">VARCHAR</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">100</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">DEFAULT</span><span class="token plain">      </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">DECLARE</span><span class="token plain"> return_str </span><span class="token keyword" style="color:rgb(12, 150, 155)">VARCHAR</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">255</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">DEFAULT</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">DECLARE</span><span class="token plain"> i </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHILE</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(12, 150, 155)">&lt;</span><span class="token plain"> n </span><span class="token keyword" style="color:rgb(12, 150, 155)">DO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">SET</span><span class="token plain"> return_str </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain">CONCAT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">return_str</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">SUBSTRING</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">chars_str</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">FLOOR</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token operator" style="color:rgb(12, 150, 155)">+</span><span class="token plain">RAND</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token number" style="color:rgb(170, 9, 130)">52</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">SET</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(12, 150, 155)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">END</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHILE</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">RETURN</span><span class="token plain"> return_str</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">END</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal"># 随机产生班级编号</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FUNCTION</span><span class="token plain"> rand_num </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">from_num </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">to_num </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">RETURNS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">11</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">DECLARE</span><span class="token plain"> i </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">SET</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> FLOOR</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">from_num </span><span class="token operator" style="color:rgb(12, 150, 155)">+</span><span class="token plain">RAND</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">to_num </span><span class="token operator" style="color:rgb(12, 150, 155)">-</span><span class="token plain"> from_num</span><span class="token operator" style="color:rgb(12, 150, 155)">+</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">RETURN</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">END</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>3.创建存储过程</strong></p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal"># 往stu表中插入数据的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">PROCEDURE</span><span class="token plain"> insert_stu</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">START</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> max_num </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">DECLARE</span><span class="token plain"> i </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">SET</span><span class="token plain"> autocommit </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">#设置手动提交事务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">REPEAT</span><span class="token plain"> </span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">#循环</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      </span><span class="token keyword" style="color:rgb(12, 150, 155)">SET</span><span class="token plain"> i</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain">i</span><span class="token operator" style="color:rgb(12, 150, 155)">+</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">#赋值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      </span><span class="token keyword" style="color:rgb(12, 150, 155)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">INTO</span><span class="token plain"> student </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">stuno</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> name </span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">age </span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">classId </span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">VALUES</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token keyword" style="color:rgb(12, 150, 155)">START</span><span class="token operator" style="color:rgb(12, 150, 155)">+</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">         rand_string</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">6</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">         rand_num</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">50</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">         rand_num</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">1000</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      UNTIL i </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> max_num</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">END</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">REPEAT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">COMMIT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">#提交事务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">END</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal"># 往class表添加随机数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">PROCEDURE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token identifier">insert_class</span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"> max_num </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">DECLARE</span><span class="token plain"> i </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">SET</span><span class="token plain"> autocommit </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        </span><span class="token keyword" style="color:rgb(12, 150, 155)">REPEAT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      </span><span class="token keyword" style="color:rgb(12, 150, 155)">SET</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(12, 150, 155)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      </span><span class="token keyword" style="color:rgb(12, 150, 155)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">INTO</span><span class="token plain"> class </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"> classname</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">monitor </span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">VALUES</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">rand_string</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">8</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">         rand_string</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">         rand_num</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">100000</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      UNTIL i </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> max_num</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        </span><span class="token keyword" style="color:rgb(12, 150, 155)">END</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">REPEAT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">COMMIT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">END</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>4.调用存储过程</strong></p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token plain"> </span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">#执行存储过程，往class表添加1万条数据 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">CALL</span><span class="token plain"> insert_class</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">10000</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"> </span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">#执行存储过程，往stu表添加50万条数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">CALL</span><span class="token plain"> insert_stu</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">100000</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">500000</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_loeA" id="索引匹配与失效">索引匹配与失效<a class="hash-link" href="#索引匹配与失效" title="标题的直接链接">​</a></h2><blockquote><p>MySQL 中<strong>提高性能</strong>的最有效的方式就是对数据库<code>设计合理的索引</code>,索引提供了高效的访问数据的方法,并且可以加快查询的速度,因此索引对查询的速度有很重要的影响</p><ul><li>使用索引可以<code>快速的定位</code>表中的记录,从而提高查询的速度和数据库的性能</li><li>如果查询的时候没有使用索引,查询语句就会<code>扫描表中的所有记录</code>,在数据量大的时候,这样的查询效率会很低</li></ul><p>大多数情况下(默认)都采用<code>B+Tree</code>来构建索引</p></blockquote><ol><li>用不用索引是由<code>优化器</code>决定的,优化器是基于<code>cost 开销</code>,而不是基于<code>规则</code>,也不是基于<code>语义</code>。所以说哪种开销小,优化器就使用哪种执行计划。另外,sql 语句是否使用索引,和<strong>数据库版本、数据量、数据选择度</strong>都有关系</li><li><mark>某些失效的情况,也可以使用一些方法让它变得可以使用索引</mark></li></ol><h3 class="anchor anchorWithStickyNavbar_loeA" id="1全值匹配法则">1.全值匹配法则<a class="hash-link" href="#1全值匹配法则" title="标题的直接链接">​</a></h3><ul><li>概述<ul><li><code>where 条件字段按照顺序在索引中都可以匹配到</code></li><li>需要注意的是,理论上<code>索引对顺序是敏感的</code>,但是<mark>查询优化器会<strong>在不影响 SQL 执行结果的情况下,自动调整 where 子句的条件顺序以使用适合的索引</strong></mark></li></ul></li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>示范使用非全值匹配与全值匹配的区别</div><div class="admonitionContent_vXIg"><p><strong>系统中经常使用下面的 sql</strong></p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- 这里的 sql_no_cache 是放置从查询缓存中取数据,MySQL8.0 已经没 Query Cache 了</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">select</span><span class="token plain"> SQL_NO_CACHE </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">from</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">where</span><span class="token plain"> age</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">30</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">select</span><span class="token plain"> SQL_NO_CACHE </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">from</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">where</span><span class="token plain"> age</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">30</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">and</span><span class="token plain"> classId</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">4</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">select</span><span class="token plain"> SQL_NO_CACHE </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">from</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">where</span><span class="token plain"> age</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">30</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">and</span><span class="token plain"> classId</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">4</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">and</span><span class="token plain"> name </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;abcd&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><br><p><strong>1.首先看下没有创建索引前的执行速度</strong></p><p>可以看到查询速度在 0.11s 左右</p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token plain">mysql</span><span class="token operator" style="color:rgb(12, 150, 155)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">select</span><span class="token plain"> SQL_NO_CACHE </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">from</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">where</span><span class="token plain"> age</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">30</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">and</span><span class="token plain"> classId</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">4</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">and</span><span class="token plain"> name </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;abcd&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">Empty </span><span class="token keyword" style="color:rgb(12, 150, 155)">set</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token plain"> warning </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">0.11</span><span class="token plain"> sec</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><br><p><strong>2.我们分别看下创建 age、age+classId、age+classId、age+classId+name索引的执行速度</strong></p><p>我们可以看到,当 where 条件列都包含在联合索引(age+classId+name)中的时候,查询速度是最快的</p><p><img loading="lazy" alt="image-20220802095845079" src="/assets/images/image-20220802095845079-67dd328455bddfe213c336ee40468745.png" width="2160" height="890" class="img_CujE"></p><br><p><strong>3.我们也可以看到不同索引下的sql 执行分析</strong></p><p>在全值匹配的时候,我们可以看到:</p><ul><li>key_len = 93,使用了全部的索引列(因为数据库使用的是 <code>utf8mb4</code> 编码,占用 4 字节)</li><li>row 最少,且 filtered 是最高的</li></ul><p><img loading="lazy" alt="image-20220802100223980" src="/assets/images/image-20220802100223980-6a865be92a02dd6e3f1e8ef49db0403a.png" width="3334" height="1318" class="img_CujE"></p><br><p><strong>4.我们在条件列中添加一个没有索引的字段隔断了索引列</strong></p><p>可以看到优化器还是用上了联合索引 <em>idx_age_cid_name</em>,是因为查询优化器会自动调整条件列的顺序以满足索引</p><p><img loading="lazy" alt="image-20220802101159880" src="/assets/images/image-20220802101159880-11472b3254b998d8f80ab57eba10846d.png" width="3526" height="306" class="img_CujE"></p></div></div><h3 class="anchor anchorWithStickyNavbar_loeA" id="2最左侧列匹配法则">2.最左侧列匹配法则<a class="hash-link" href="#2最左侧列匹配法则" title="标题的直接链接">​</a></h3><ul><li>在 MySQL 中建立<strong>联合索引</strong>时会遵守<code>最佳左前缀原则</code></li><li><strong>在检索数据时从联合索引的最左边开始匹配</strong>,<strong>如果左边的值未确定，那么无法使用此索引</strong><ul><li><code>如果条件列中没有联合索引列的第一个字段,那么不会使用联合索引</code></li><li><code>如果条件列中少了联合索引列的中间字段,那么只能使用联合索引列前面的字段</code></li></ul></li><li><mark><strong>注意:</strong></mark>MySQL 可以为多个字段建立联合索引,但对联合索引来说:<code>过滤条件使用索引必须按照索引建立时索引列的顺序依次满足,一旦某个索引列不满足,该索引列后面的索引列都无法被使用</code></li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>试验最左前缀</div><div class="admonitionContent_vXIg"><p><strong>首先定义一个联合索引 (age, classId, name),完整的索引列 key_len=93</strong></p><p><strong>1. 查询语句中只包含了索引列后面两个字段(classId,name)</strong></p><p>由于条件列中没有联合索引列的第一个字段,所以无法使用该联合索引</p><p><img loading="lazy" alt="image-20220802123235069" src="/assets/images/image-20220802123235069-a20a77711f1e6bd14fbe31dbf9f7a707.png" width="2638" height="344" class="img_CujE"></p><br><p><strong>2.查询语句中包含了前面两个字段(age,classId)</strong></p><p>条件列中包含了联合索引列的第一、第二个字段,可以使用索引,但不是全值匹配,所以只能使用部分的联合索引(age+classId)</p><p><img loading="lazy" alt="image-20220802123542870" src="/assets/images/image-20220802123542870-81a8b20c03d7b7eeb64b8320071a3023.png" width="2788" height="376" class="img_CujE"></p><br><p><strong>3.查询语句中不包含中间的字段(age,name)</strong></p><p>条件列中不包含联合索引列的中间字段,所以联合索引只能使用中间字段前面的部分索引列(age),我们通过 <strong>key_len=5 </strong>也可以很明显的看出来只用了一个 age(int null)的索引列</p><p><img loading="lazy" alt="image-20220802124008591" src="/assets/images/image-20220802124008591-198e20a01a222fcf49971aca10b66a49.png" width="3014" height="368" class="img_CujE"></p></div></div><h3 class="anchor anchorWithStickyNavbar_loeA" id="3主键插入顺序">3.主键插入顺序<a class="hash-link" href="#3主键插入顺序" title="标题的直接链接">​</a></h3><blockquote><p>对于一个使用<code>InnoDB</code>存储引擎的表来说,在我们没有显式的创建索引时,表中的数据实际上都是存储在<code>聚簇索引</code>的叶子节点的,而记录又是存储在数据页中的,数据页和记录又是按照记录<code>主键值从小到大</code>的顺序进行排序</p><ul><li>如果我们<code>插入</code>的记录的<code>主键值是依次增大的话</code>,那我们每次插满一个数据页就换到下一个数据页继续插</li><li>如果我们插入的<code>主键值忽大忽小,没有顺序</code>,那么就比较麻烦,就可能的出现<code>页分裂</code></li></ul></blockquote><p>比如我们一个数据页的叶子节点存储的记录已经满了,此时插入一个中间数据,那么就会出现<strong>页分裂</strong>(将当前页分裂为两个,然后把本页中的一些记录移动到新创建的这个页中),这样会发生<code>性能损耗</code></p><p>如果想<code>尽量避免</code>这样无谓的性能损耗，最好让插入的记录的<code>主键值依次递增</code> ,让主键具有 <code>AUTO_INCREMENT</code> ，让存储引擎自己为表生成主键,而不是手动插入</p><h3 class="anchor anchorWithStickyNavbar_loeA" id="4索引列的计算函数导致索引失效">4.索引列的计算、函数导致索引失效<a class="hash-link" href="#4索引列的计算函数导致索引失效" title="标题的直接链接">​</a></h3><blockquote><p>因为函数作用于索引,存储引擎就无法默认的通过索引定位记录的位置了,可能函数计算的结果与默认索引定位的结果并不一致,那就只能扫描全表来确定了,简单来说就是不要干预利用索引查询的步骤</p></blockquote><ul><li><code>不要在索引列上做任何操作,包括计算，函数，自动或者手动类型转换,会导致索引失效而转向全表扫描</code></li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>操作索引列失效的试验</div><div class="admonitionContent_vXIg"><p><strong>首先对 name 创建一个索引,用于试验</strong></p><p><strong>1.没有对索引列name进行操作</strong></p><p>可以看到我们使用到了索引<em>idx_name</em></p><p><img loading="lazy" alt="image-20220802132834804" src="/assets/images/image-20220802132834804-5db894c862dfb063087ece25e544084f.png" width="2460" height="330" class="img_CujE"></p><br><p><strong>2.对索引列name进行操作</strong></p><p>很明显,我们对 name 进行了计算之后,索引<em>idx_name</em> 失效了。优化器一看到索引列被操作了,那么就放弃使用索引</p><p><img loading="lazy" alt="image-20220802132929343" src="/assets/images/image-20220802132929343-22f300db22786db36f8b773ac5946be7.png" width="2534" height="328" class="img_CujE"></p></div></div><h3 class="anchor anchorWithStickyNavbar_loeA" id="5类型转换自动或手动导致索引失效">5.类型转换(自动或手动)导致索引失效<a class="hash-link" href="#5类型转换自动或手动导致索引失效" title="标题的直接链接">​</a></h3><ul><li><code>索引类型与条件列的类型需要一致,类型不一致会导致索引失效</code>,因为这个相当于在索引列上作用了一个隐式的转换函数</li><li><mark>代码编写实体类的时候,需要注意属性类型与数据库字段类型一致!</mark></li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>自动类型转换的试验</div><div class="admonitionContent_vXIg"><p><strong>首先对 name 创建一个索引,用于试验</strong></p><p><strong>1.索引列 name 的隐式(自动)转换</strong></p><p>可以看到,并没有能使用索引<em>idx_name</em>。优化器根据语句推算出可能使用<em>idx_name</em>,但是后面发现类型不匹配,只能转而扫描全表</p><p><img loading="lazy" alt="image-20220802133309829" src="/assets/images/image-20220802133309829-627469f69f0c83b9a0c391fd697a1db0.png" width="2512" height="328" class="img_CujE"></p></div></div><h3 class="anchor anchorWithStickyNavbar_loeA" id="6范围条件右边的列索引失效">6.范围条件右边的列索引失效<a class="hash-link" href="#6范围条件右边的列索引失效" title="标题的直接链接">​</a></h3><blockquote><p>范围列以及前面的查询条件可以确定一个<code>有序</code>的范围区间,但是后面的索引列是<code>无序的</code>,无法使用索引定位,只能对所有的该索引列进行扫描</p></blockquote><ul><li><strong>概述</strong><ul><li><code>范围列可以用到索引（必须是最左前缀），但是范围列后面的列无法用到索引</code>,所以<strong>设计索引的时候一般将确定的列放在索引的最左侧</strong><ul><li><mark>实际开发中应该尽量将索引列中可能使用范围查询的列定义在最后面</mark></li></ul></li></ul></li><li><strong>说明</strong><ul><li>这里的范围包括<code>&lt; 、 &lt;= 、&gt; 、 &gt;= 、&lt;&gt;等</code></li><li>这的右侧指的是<code>定义联合索引时索引列的顺序</code></li></ul></li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>范围查询后索引失效试验</div><div class="admonitionContent_vXIg"><p><strong>首先创建一个联合索引(age,name,classId),如果完全使用索引,那么 key_len=93</strong></p><p><strong>1.查询语句中第一个字段是等值,后面一个是范围查询</strong> </p><p>可以看到,ken_len=88,即只用了索引列<strong>age和 name</strong>。即使我们把 classId 与 name 的位置交换,也无法消除索引失效,因为定义的索引时字段列位置就是: age-&gt;name-&gt;classId</p><p><img loading="lazy" alt="image-20220802141700230" src="/assets/images/image-20220802141700230-f1e8bc144a20b5077a6db6bdb2e07d60.png" width="3004" height="314" class="img_CujE"></p><p><strong>2.查询语句中第一个字段是范围查询,后面的值等值</strong> </p><p>可以看到,最左侧的索引列age 使用了索引,后面都没有使用上</p><p><img loading="lazy" alt="image-20220802150908358" src="/assets/images/image-20220802150908358-f8d66fc001303bdead12b71fcf180293.png" width="3004" height="316" class="img_CujE"></p></div></div><h3 class="anchor anchorWithStickyNavbar_loeA" id="7不等于-或者--导致索引失效">7.不等于(!= 或者 &lt; &gt;)导致索引失效<a class="hash-link" href="#7不等于-或者--导致索引失效" title="标题的直接链接">​</a></h3><blockquote><p>索引需要的是确定的值,不等于就意味着所有的记录都可能是不等于条件值的,那么这种情况还需要一个一个的回表获取完整的数据(Select *), 所以优化器任务不如直接全表扫描</p></blockquote><ul><li><code>在使用不等于的场景下，可能无法使用索引导致全表扫描</code></li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>不等于导致索引失效</div><div class="admonitionContent_vXIg"><p><strong>创建一个索引(name),查询语句中条件列时不等于</strong></p><p><img loading="lazy" alt="image-20220802151819303" src="/assets/images/image-20220802151819303-197c3f56f04a140c64acddf1859e95ca.png" width="2530" height="388" class="img_CujE"></p></div></div><h3 class="anchor anchorWithStickyNavbar_loeA" id="8is-null-和-is-not-null">8.IS NULL 和 IS NOT NULL<a class="hash-link" href="#8is-null-和-is-not-null" title="标题的直接链接">​</a></h3><blockquote><p>IS NULL 只需要记录值是 NULL,通过索引可以定位到哪些是 NULL。但是 IS NOT NULL 则需要全表扫描判断是否不等于 NULL</p></blockquote><ul><li><code>IS NULL 可以使用索引,IS NOT NULL 无法使用索引</code><ul><li>和 NOT NULL类似的,<code>NOT LIKE、NOT IN...</code>也无法使用索引</li></ul></li><li><mark>最好在设计数据的时候讲字段设置 NOT NULL 约束,比如 INT 类型的默认值是 0,字符串类型的默认值是空字符串</mark></li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>IS NUll 和 IS NOT NUll区别</div><div class="admonitionContent_vXIg"><p><strong>创建一个索引(age), 查询语句分别带有 is null 和 is not null</strong></p><p>可以看到,查询带有is not null的话,索引失效了</p><p><img loading="lazy" alt="image-20220802152927979" src="/assets/images/image-20220802152927979-fc2b7f4170e9b86b1908c3752c744b98.png" width="2766" height="676" class="img_CujE"></p></div></div><h3 class="anchor anchorWithStickyNavbar_loeA" id="9like以通配符开头索引">9.Like以通配符%开头索引<a class="hash-link" href="#9like以通配符开头索引" title="标题的直接链接">​</a></h3><blockquote><p>因为如果以%开头,那么所有记录都可能满足查询条件,所以引擎需要全表扫描。但如果以确定的开头,那么就只有确定的那些数据满足条件,即<strong>可以通过索引确定这些满足条件的数据</strong></p></blockquote><ul><li>在使用模糊查询的时候,如果匹配字符串的时,<code>第一个字符是%</code>,那么索引不会起作用</li><li><strong>[阿里开发规则]<!-- -->: 页面搜索进制做模糊或者全模糊,如果业务需要,请使用搜索引擎</strong> </li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>模糊匹配索引失效示例</div><div class="admonitionContent_vXIg"><p><strong>首先创建一个索引(name)</strong></p><p><strong>1.查询语句中%在最左侧</strong></p><p>可以看到,当通配符%位于最左侧的时候,索引失效了</p><p><img loading="lazy" alt="image-20220802154813730" src="/assets/images/image-20220802154813730-04a4c08fc6115242fbc6a8aa74b4fa34.png" width="2516" height="364" class="img_CujE"></p><br><p><strong>2.查询语句中%不在最左侧</strong></p><p>可以看到使用了索引</p><p><img loading="lazy" alt="image-20220802155002240" src="/assets/images/image-20220802155002240-1fc4a3d30db088e36103e1bd0bc49511.png" width="2712" height="654" class="img_CujE"></p></div></div><h3 class="anchor anchorWithStickyNavbar_loeA" id="10or-前后存在非索引的列">10.OR 前后存在非索引的列<a class="hash-link" href="#10or-前后存在非索引的列" title="标题的直接链接">​</a></h3><blockquote><p>虽然有一个条件满足索引列,但是其他的没有对应的索引,就意味着需要扫描全面。既然要扫描全表了,那么满足索引列的那个索引就失去了意义(反正都要全表扫描咯,干嘛还要用索引呢?),<strong>所以就不使用索引咯</strong></p></blockquote><ul><li><code>用 OR 分开的条件，如果 OR 前(后)的条件中的列有索引，而后(前)的列中没有索引，那么涉及的索引都不会被用到</code></li><li><mark>如果 OR 前后都有索引的话,就会将两个索引都用上 </mark>, <strong>当然由于是 OR,为了保证数据的准确性,那么需要将两个索引进行合并匹配查询</strong></li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>OR 前/后存在非索引列</div><div class="admonitionContent_vXIg"><p><strong>创建一个 age 的索引,查询语句中,OR 前有索引,后面没有索引</strong></p><p><img loading="lazy" alt="image-20220802164301269" src="/assets/images/image-20220802164301269-0b771794e7aaf5539a6e01291459ec94.png" width="2570" height="342" class="img_CujE"></p></div></div><h3 class="anchor anchorWithStickyNavbar_loeA" id="11数据库和表的字符集统一使用utf8mb4">11.数据库和表的字符集统一使用utf8mb4<a class="hash-link" href="#11数据库和表的字符集统一使用utf8mb4" title="标题的直接链接">​</a></h3><p>统一使用 utf8mb4 的兼容性很好,统一字符集可以避免字符集转换而产生的乱码,不同的<code>字符集</code>进行比较前需要进行<code>转换</code>导致索引失效(这个就是)</p><h3 class="anchor anchorWithStickyNavbar_loeA" id="12-order-by时规则不一致索引失效">12. order by时规则不一致,索引失效<a class="hash-link" href="#12-order-by时规则不一致索引失效" title="标题的直接链接">​</a></h3><ol><li><p><code>对于联合索引进行排序时,如果各个索引列的排序方式不同,那么索引会失效</code></p><ul><li><p>即要某个列升序,又要对某个列降序,这个与索引的排序方式相矛盾,导致只能</p></li><li><mark>但是在 MySQL8.0 中支持降序索引,可以利用降序索引实现排序字段排序方式不一致</mark></li></ul></li><li><p><code>排序列包含多个索引列</code></p><ul><li>排序列包含多个索引列,那么至少有有一个索引列无法被使用,就需要回表得到所有的记录,然后全表扫描在内存中排序<ul><li><strong>那么前面的索引就失去了意义,而且还需要回表,所以干脆直接扫描全表(ALL)</strong></li></ul></li></ul></li><li><p><code>排序列中缺少联合索引的部分字段(不满足最左侧列匹配)</code></p><ul><li><mark>可以使用覆盖索引处理</mark></li></ul></li><li><p><code>形成扫描区间(where 句)的索引列与排序列不一致</code></p><ul><li>扫描区间的记录中不包含排序列,所以无法按照排序列进行排序,而是需要利用主键回表得到完整的记录后,在内存中进行排序(当然此时也无法使用排序列作为索引)</li></ul></li></ol><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>order by索引失效试验</div><div class="admonitionContent_vXIg"><p><strong>1.建立索引(age,classId,stuno)</strong></p><p><img loading="lazy" alt="image-20220803141859622" src="/assets/images/image-20220803141859622-ec3c286d4fe6abcf756ac2516317348c.png" width="2804" height="354" class="img_CujE"></p><br><p><strong>2.重建索引(age asc,classId desc,stuno)</strong></p><p>可以看到,利用到了索引</p><p><img loading="lazy" alt="image-20220803142450933" src="/assets/images/image-20220803142450933-0d070dc168386016884dd6a9aa5755e4.png" width="2860" height="344" class="img_CujE"></p></div></div><h3 class="anchor anchorWithStickyNavbar_loeA" id="小结">小结<a class="hash-link" href="#小结" title="标题的直接链接">​</a></h3><blockquote><p><code>总结</code>: <strong>索引条件需要是确定的,正向的值(反向的话需要遍历看下是否不满足反向值),否则就需要全表扫描。联合索引前面的满足,后面的索引失效,根据最左侧列匹配原则,后面的索引无法使用,前面的可以使用。</strong></p><p><code>口诀</code>:</p><ol><li><p>全值匹配法则 + 最左侧列匹配法则 =&gt; 带头大哥不能死,中间兄弟不能断</p></li><li><p>索引列的计算、函数 + 类型转换 + 统一字符集 =&gt; 索引列上少操作 + 索引类型要一致</p></li><li><p>不等于(&lt; &gt;,!=) + IS NOT NULL + OR 前后存在非索引的列 =&gt; 不等空值还有 OR + 负向查询会失效</p></li><li><p>范围查询右侧 + like以通配符%开头 =&gt; 范围之后全失效 + Like百分要靠右</p></li></ol><p><code>说明</code>: <code>如果 MySQL 估计使用索引比全表扫描更慢，则不使用索引</code></p></blockquote><div class="theme-admonition theme-admonition-tip alert alert--success admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>建议</div><div class="admonitionContent_vXIg"><ol><li>对于单列索引,尽量选择针对当前 query 过滤性好的索引</li><li>在选择联合索引的时候, 当前 query 中过滤性最好的字段最好放在索引列的最左侧</li><li>在选择联合索引的时候, 索引列中尽可能包含当前 query 中 where 子句中的条件列</li><li>在选择联合索引的时候, 如果某个字段可能出现范围查询的时候, 尽可能将这个字段放在索引列的最后</li></ol></div></div><h2 class="anchor anchorWithStickyNavbar_loeA" id="关联查询优化">关联查询优化<a class="hash-link" href="#关联查询优化" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_loeA" id="数据准备-1">数据准备<a class="hash-link" href="#数据准备-1" title="标题的直接链接">​</a></h3><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal"># 分类</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token identifier">type</span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    id   </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">UNSIGNED</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">KEY</span><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">AUTO_INCREMENT</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    card  </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain">   </span><span class="token keyword" style="color:rgb(12, 150, 155)">UNSIGNED</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal"># 图书</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">TABLE</span><span class="token plain"> book </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    bookid  </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">UNSIGNED</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">KEY</span><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">AUTO_INCREMENT</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    card    </span><span class="token keyword" style="color:rgb(12, 150, 155)">INT</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">UNSIGNED</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">INTO</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token identifier">type</span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">card</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">values</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"> Floor</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">+</span><span class="token plain"> rand</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token number" style="color:rgb(170, 9, 130)">20</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">INTO</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token identifier">book</span><span class="token identifier punctuation" style="color:rgb(153, 76, 195)">`</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">card</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">values</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"> Floor</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">+</span><span class="token plain"> rand</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token number" style="color:rgb(170, 9, 130)">20</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_loeA" id="连接过程简介">连接过程简介<a class="hash-link" href="#连接过程简介" title="标题的直接链接">​</a></h3><blockquote><p>我们可以用连接查询连接任意数量的表,但如果我们没有任何的条件,这些表产生的笛卡尔积是非常大的。</p><p>举个🌰 : 有A、B、C 三张表,且每张表各有 100 条数据,那么对这三张表进行连接查询,且没有使用连接条件的话,就会得到 100 x 100 x 100 = 100,0000 条记录,相当可怕!</p><ol><li></li></ol></blockquote><p>对于连接查询来说,使用过滤条件对查询进行过滤很有必要, 过滤条件可以分为下面两种:</p><ol><li><p><code>涉及单表的条件</code> : 我们也叫做<code>搜索条件</code>,即这个查询条件只针对单个表</p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal"># 这里的 t1.m1&gt; 1 and t2.n2 &lt; &#x27;d&#x27; 都是单表的查询条件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">from</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">t2 </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">where</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">m1</span><span class="token operator" style="color:rgb(12, 150, 155)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">and</span><span class="token plain"> t2</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">n2 </span><span class="token operator" style="color:rgb(12, 150, 155)">&lt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;d&#x27;</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><code>涉及两表的条件</code> : 查询条件涉及到两张表</p></li></ol><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>分析连接过程</div><div class="admonitionContent_vXIg"><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">from</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">t2 </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">where</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">m1</span><span class="token operator" style="color:rgb(12, 150, 155)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">and</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">m1</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain">t2</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">m2 </span><span class="token operator" style="color:rgb(12, 150, 155)">and</span><span class="token plain">  t2</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">n2 </span><span class="token operator" style="color:rgb(12, 150, 155)">&lt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;d&#x27;</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>步骤 1: 首先确定第一个需要查询的表,也就是驱动表</strong></p><p><strong>优化器会选择一种执行成本最低的访问方法去执行单表查询语句</strong>, 我们假设 t1 是驱动表,由于此时 t1 没有索引,所以对 t1 的访问方法是 <strong>ALL</strong>,也就是说此时会以全表扫描的方式查询去 t1 表所有的记录</p><p><strong>步骤二:从步骤一种获取到的每一条记录,都需要去 t2 表去查询匹配的记录</strong></p><p>这里查询匹配的记录,指的就是<code>符合过滤条件的记录</code>,<strong>由于是根据 t1 表中的记录去 t2 中查询匹配的记录,所以 t2 也叫做被驱动表</strong>,所以这里的涉及两个表的过滤条件就是 <strong>t1.m1=t2.m2</strong></p><mark>需要注意的是,不是先将驱动表的数据全部取出再去被驱动表中匹配,而是取出一条驱动表的数据就立刻去被驱动表中匹配</mark><br><p><strong>整个的查询过程如图:</strong></p><p><img loading="lazy" alt="image-20220811232958353" src="/assets/images/image-20220811232958353-c3764355b43837a1c34e45f44f0f7f41.png" width="3236" height="1194" class="img_CujE"></p></div></div><h3 class="anchor anchorWithStickyNavbar_loeA" id="内外连接">内外连接<a class="hash-link" href="#内外连接" title="标题的直接链接">​</a></h3><ul><li><strong>内外连接本质</strong><ul><li><strong>外连接的本质需求就是,针对驱动表中的某条记录,即使在被驱动表中没有找到与之匹配的记录,也仍需要将该驱动表的记录放在结果集中</strong></li><li>内连接的本质需要是,针对驱动表中的某条记录,如果在被驱动表中没有找到与之匹配的记录,则丢弃该条记录</li></ul></li><li><strong>根据查询条件的位置,可以分为两类</strong><ul><li><code>WHERE 子句</code><ul><li>不论是内连接还是外连接,只要是不符合 WHERE 过滤条件的,都不会放在结果集中</li></ul></li><li><code>ON 子句</code><ul><li>对于外连接来说,<strong>如果<code>无法在被驱动表</code>中匹配 ON 子句的过滤条件,那么<code>该记录依旧会被放在结果集</code>中,但是对应被驱动表的各字段值为 <code>NULL</code></strong></li></ul></li></ul></li><li>我们需要注意的是,<mark>ON 子句是专门为外连接驱动表的记录在被驱动表中找不到对应的记录这个场景提出的</mark>,<strong>如果我们将 ON 子句放在内连接中,MySQL 会将它像 WHERE 子句一样对待</strong></li></ul><h4 class="anchor anchorWithStickyNavbar_loeA" id="采用外连接">采用外连接<a class="hash-link" href="#采用外连接" title="标题的直接链接">​</a></h4><ul><li><mark>建议: 左外连接中,左边放小表;右外连接中,右边放小表。即小表驱动大表</mark></li><li><code>驱动表数量确定时,我们需要尽可能通过索引减少加快被驱动表的查询</code></li><li>外连接分为左外连接和右外连接<ol><li><strong>左外连接</strong><ul><li>左表数据一定都有,LEFT JOIN 条件<code>用于确定如何从右表搜索记录,所以右表一定要建立连接</code></li></ul></li><li><strong>右外连接</strong><ul><li>右表数据一定都有,RIGHT JOIN 条件<code>用于确定如何从左表搜索记录,所以左表一定要建立连接</code></li></ul></li></ol></li><li><strong>连接查询中不一定左侧的就是驱动表,右侧的就是被驱动表。需要根据实际查看哪张表是被驱动表</strong>,</li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>左外连接查询优化试验</div><div class="admonitionContent_vXIg"><p><strong>1.关联表都没有索引的情况下</strong></p><p>可以看到 左驱动表 type 是全表扫描,右被驱动表 book 也是全表扫描,由于被驱动表没有使用索引,所以 InnoDB 分配了块<em>join buffer</em>的内存存储驱动表的数据以加快查询</p><p>也需要明白,关联查询类似于嵌套循环,外层数量确定时,我们就需要减少内部查询的数量、加快内部查询的速度</p><p><img loading="lazy" alt="image-20220802231409645" src="/assets/images/image-20220802231409645-aa5fb8bffbc74c0195aa2fa196f52812.png" width="3046" height="394" class="img_CujE"></p><p><strong>2.被驱动表 book 建立索引以及为驱动表建立索引</strong></p><p>可以看到为<strong>被驱动包建立索引</strong>之后,book 表的 type 变成了 ref,使用了索引。同时 rows 的数量从 52-&gt; 2,表示连外层“大致循环 104 次”</p><p><img loading="lazy" alt="image-20220802233615582" src="/assets/images/image-20220802233615582-90865b1a0894d7e1c32e8e493f86a3e2.png" width="3024" height="948" class="img_CujE"></p></div></div><h4 class="anchor anchorWithStickyNavbar_loeA" id="采用内连接">采用内连接<a class="hash-link" href="#采用内连接" title="标题的直接链接">​</a></h4><ol><li><p><code>对于内连接来说,查询优化器会自动选择驱动表 </code></p></li><li><p><code>如果表的连接条件中只有一个字段作为索引,则有索引的表会被作为被驱动表</code></p></li><li><p><code>如果两个表都有索引的话,会选择小表作为驱动表</code></p></li></ol><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>内连接查询优化试验</div><div class="admonitionContent_vXIg"><p><strong>驱动比较与被驱动表都没有任何的索引条件</strong></p><p>此时 type 是驱动表,book 是被驱动表</p><p><img loading="lazy" alt="image-20220803004108627" src="/assets/images/image-20220803004108627-f9341bf95ddcfcf35f40497350cf50f0.png" width="3030" height="416" class="img_CujE"></p><br><p><strong>1.为 type 表建立索引,book 表没有索引</strong></p><p>我们看到:</p><ul><li>之前都没有索引的时候,book 是被驱动表</li><li>当为 type 表的 card 加上索引后,type 表变成了被驱动表 =&gt; <code>MySQL 选择加索引的表作为被驱动表</code></li></ul><p>这个说明<strong>内连接会自动选择驱动、被驱动表</strong></p><p><img loading="lazy" alt="image-20220803004305930" src="/assets/images/image-20220803004305930-49984ef3984eff4d2df864322853e3fb.png" width="2798" height="520" class="img_CujE"></p><br><p><strong>2.在上面的基础上,为 book 建立索引</strong></p><p>我们看到,<strong>type 表由上一步的被驱动表又重新变成了驱动表</strong></p><p><img loading="lazy" alt="image-20220803004414411" src="/assets/images/image-20220803004414411-3b39cef62eea7cd63bd46726cb02df9d.png" width="2794" height="530" class="img_CujE"></p><p><strong>3.我们向 type 表中插入20 条数据</strong></p><p>插入数据后,type 表时大表,book表是小表,基于<strong>小表驱动大表</strong>的原则,此时 book 表又变成了驱动表</p><p><img loading="lazy" alt="image-20220803004642219" src="/assets/images/image-20220803004642219-f09310ccdd40a69dd4fb91eb188555cd.png" width="2852" height="720" class="img_CujE"></p></div></div><h3 class="anchor anchorWithStickyNavbar_loeA" id="join-语句原理">join 语句原理<a class="hash-link" href="#join-语句原理" title="标题的直接链接">​</a></h3><blockquote><p>join 方式连接多个表,<strong>本质就是各个表之间数据的循环匹配</strong>。</p><p>MySQL5.5 版本之前,MySQL 只支持一种表间关联方式,就是<code>嵌套循环(Nested Loop Join)</code>。如果关联表的数据量大,则 join 关联的执行时间会非常长</p><p>在MySQL5.5 之后的版本中,MySQL 引入了<code>Block Nested-Loop join 算法</code>来优化嵌套执行</p></blockquote><h4 class="anchor anchorWithStickyNavbar_loeA" id="驱动表与被驱动表">驱动表与被驱动表<a class="hash-link" href="#驱动表与被驱动表" title="标题的直接链接">​</a></h4><mark>驱动表就是主表,被驱动表就是从表</mark><p><strong>1、对于内连接来说</strong></p><p>A 表虽然在前面,但不一定是驱动表,查询优化器会决定哪张表是驱动表,哪张表是被驱动表</p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> A </span><span class="token keyword" style="color:rgb(12, 150, 155)">INNER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">JOIN</span><span class="token plain"> B </span><span class="token keyword" style="color:rgb(12, 150, 155)">ON</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.对于外连接来说</strong></p><ul><li>通常会认为 A 表是驱动表,B 表是被驱动表。<ul><li>即左连接左侧是驱动表,右连接右侧是驱动表</li><li>但并不一定是这样的,需要依据表的<strong>大小</strong>做判断,适当时<code>左连接会&quot;转为&quot;右连接</code></li></ul></li></ul><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> A </span><span class="token keyword" style="color:rgb(12, 150, 155)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">JOIN</span><span class="token plain"> B </span><span class="token keyword" style="color:rgb(12, 150, 155)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> B </span><span class="token keyword" style="color:rgb(12, 150, 155)">RIGHT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">JOIN</span><span class="token plain"> A </span><span class="token keyword" style="color:rgb(12, 150, 155)">ON</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>测试</div><div class="admonitionContent_vXIg"><p><strong>1.准备测试数据</strong></p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">/*</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">    a.f1 是索引</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">    b 表没有索引</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">TABLE</span><span class="token plain"> a </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    f1 </span><span class="token keyword" style="color:rgb(12, 150, 155)">int</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    f2 </span><span class="token keyword" style="color:rgb(12, 150, 155)">int</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">INDEX</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">INTO</span><span class="token plain"> a </span><span class="token keyword" style="color:rgb(12, 150, 155)">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">2</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">2</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">3</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">3</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">4</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">4</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">5</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">5</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">6</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">6</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">TABLE</span><span class="token plain"> b </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    f1 </span><span class="token keyword" style="color:rgb(12, 150, 155)">int</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    f2 </span><span class="token keyword" style="color:rgb(12, 150, 155)">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">INTO</span><span class="token plain"> b </span><span class="token keyword" style="color:rgb(12, 150, 155)">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">3</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">3</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">4</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">4</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">5</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">5</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">6</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">6</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">7</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">7</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">8</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">8</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2.分别查看下面的 sql 语句执行</strong></p><p><img loading="lazy" alt="image-20220803094515030" src="/assets/images/image-20220803094515030-7d6c58d37eb4c2700559ac6bb7886a66.png" width="3272" height="1238" class="img_CujE"></p></div></div><h4 class="anchor anchorWithStickyNavbar_loeA" id="简单嵌套循环连接">简单嵌套循环连接<a class="hash-link" href="#简单嵌套循环连接" title="标题的直接链接">​</a></h4><blockquote><p>简单嵌套循环连接: Simple Nested-Loop join</p></blockquote><ul><li>这种算法很简单,从表 A 种取出一条数据,然后立即将表 B 加载到内存中进行遍历,然后将匹配到的数据放在结果集 中,然后从表 A 中去下一条数据,并重新将表 B 加载到内存中进行遍历匹配<ul><li><strong>需要注意,这里说的结果集值是一个抽象的概念,并不是说将所有记录都先查询出来放在一个地方(内存或磁盘)</strong></li><li><code>驱动表每一条记录都会与被驱动表的记录进行判断</code></li></ul></li></ul><p>可以看到这种方式的效率很低,假设 A 表 100 条数据,B 表1000 条数据:</p><ul><li>外表扫描全表次数: 1</li><li>内表扫描全表次数: A</li><li>读取记录数: A+A*B</li><li>JOIN 比较次数: A*B</li><li>回表读取记录次数: 0</li></ul><p>但是我们也能从中看到,A 表的影响因子较大,所以需要<strong>小表驱动大表</strong></p><p><img loading="lazy" alt="image-20220812235348679" src="/assets/images/image-20220812235348679-1728fcf2084aebfc0492e0c3ba1524a2.png" width="2844" height="900" class="img_CujE"></p><h4 class="anchor anchorWithStickyNavbar_loeA" id="索引嵌套循环连接">索引嵌套循环连接<a class="hash-link" href="#索引嵌套循环连接" title="标题的直接链接">​</a></h4><blockquote><p>索引嵌套循环连接: Index Nested-Loop join</p></blockquote><p>优化思路主要是为了<code>减少内表数据的匹配次数</code>,所以要求被驱动表上<code>必须有索引</code>才可以</p><p>通过外表匹配条件直接与内表<code>索引</code>进行匹配,<strong>避免与内表每条记录进行比较,这样极大的减少了对内表的匹配次数</strong></p><p>驱动表每条记录通过被驱动表的索引进行匹配,因为索引的成本相对固定,所以优化器<code>一般选择小表作为驱动表(外表),从而进一步提升 join 的效率</code></p><ul><li>外表扫描全表次数: 1</li><li>内表扫描全表次数: 0</li><li>读取记录数: A + B(match index)</li><li>JOIN 比较次数: A * 索引高度</li><li>回表读取记录次数: <!-- -->[B(match)]<!-- --> if possible </li></ul><p><img loading="lazy" alt="image-20220803101031857" src="/assets/images/image-20220803101031857-4d02b84a0c1d2c81532e02942956ee42.png" width="1680" height="906" class="img_CujE"></p><h4 class="anchor anchorWithStickyNavbar_loeA" id="块嵌套循环连接">块嵌套循环连接<a class="hash-link" href="#块嵌套循环连接" title="标题的直接链接">​</a></h4><h5 class="anchor anchorWithStickyNavbar_loeA" id="概述">概述<a class="hash-link" href="#概述" title="标题的直接链接">​</a></h5><blockquote><p>块嵌套循环连接: Block Nested-Loop join</p><p>如果存在索引,那么会使用 Index Nested-Loop join 的方式进行 join</p><p><code>如果连接查询的多表关联条件没有索引</code>,被驱动表要扫描的次数就太多了,每次访问被驱动表,其表中的记录会全部的加载内存中,然后驱动表中的每条记录与之进行匹配(复杂度 n^2^),这样大大的增加了 IO 的次数,<strong>为了减少 IO 的次数,就出现了Block Nested-Loop join的方式</strong></p></blockquote><ol><li><p>不再是逐条的获取<strong>驱动表</strong>的数据,而是<code>一块一块的获取驱动表的数据</code>,引入了<code>join buffer缓冲区</code>,将<code>驱动表</code>join 相关的部分数据列(<strong>大小受 join buffer 的限制</strong>)缓存到 join buffer 中,然后全表扫描<code>被驱动表</code>,<code>被驱动表的每条记录一次性和 join buffer 中所有驱动表的记录进行匹配(内存中)</code>,<strong>将简单嵌套循环的多次比较合并成一次,降低了对被驱动表的访问频率</strong></p></li><li><mark>一对关联表就需要一个 join buffer</mark></li></ol><p><img loading="lazy" alt="image-20220813001553964" src="/assets/images/image-20220813001553964-85817454d47a88c039aece12736f8357.png" width="2256" height="722" class="img_CujE"></p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>说明</div><div class="admonitionContent_vXIg"><ol><li><mark>这里缓存的不仅仅是关联表的列,SELECT 子句中的列也会被缓存起来</mark></li><li><p>在一个有 <code>N 个 join 关联的查询中</code>,会分配 <code>N-1</code> 个 join buffer,所以查询的时候尽量减少不必要的字段,可以让 join buffer 可以存放更多的列</p></li></ol></div></div><h5 class="anchor anchorWithStickyNavbar_loeA" id="参数设置">参数设置<a class="hash-link" href="#参数设置" title="标题的直接链接">​</a></h5><blockquote><p>块嵌套循环连接受到相关参数的影响,主要是</p></blockquote><ol><li><code>block_nested_loop</code><ul><li>通过<code>show variables like &#x27;%optimizer_switch%&#x27;</code>查看该状态</li><li>默认是开启的</li></ul></li><li><code>join_buffer_size</code><ul><li>驱动表一次性能加载多少,就需要看 join_buffer 的参数值的多少</li><li>默认情况下,<code>join_buffer_size=256k(262144 B)</code></li><li><strong>join_buffer_size的最大值在 32 位系统可以申请4G,在 64位操作系统可以申请大于 4G</strong></li></ul></li></ol><p><img loading="lazy" alt="image-20220803104800779" src="/assets/images/image-20220803104800779-93ae5ad062867e54b0df86c71d86aaae.png" width="1418" height="290" class="img_CujE"></p><h4 class="anchor anchorWithStickyNavbar_loeA" id="小结-1">小结<a class="hash-link" href="#小结-1" title="标题的直接链接">​</a></h4><ol><li><p>整体效率比较: <strong>Index &gt; Block &gt; Simple</strong></p></li><li><p><strong>永远用小结果集驱动大结果集</strong>(本质就是<code>减少外层循环的数量</code>),小的度量是通过 <code>表行数 * 每行大小</code>  </p><ul><li>即两个表<code>按照各自的条件过滤，过滤完成之后，计算参与的各个字段的总数据量</code>，数据量小的那个，就是“小结果集”，应该作为驱动表</li></ul><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- 推荐的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">b</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">t2</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">from</span><span class="token plain"> t1 straight_join t2 </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">on</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">t1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">b</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain">t2</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">b</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">where</span><span class="token plain"> t2</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">id </span><span class="token operator" style="color:rgb(12, 150, 155)">&lt;</span><span class="token number" style="color:rgb(170, 9, 130)">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">/*</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">    不推荐的</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">    此时是将 t2 作为驱动表,但是对 t2 表是查询所有的字段,如果存储到 join_buffer 中,</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">    那么就导致join_buffer 一次能加载的数据很少</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">b</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">t2</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">from</span><span class="token plain"> t2 straight_join t1</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">on</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">t1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">b</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain">t2</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">b</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">where</span><span class="token plain"> t2</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">id </span><span class="token operator" style="color:rgb(12, 150, 155)">&lt;</span><span class="token number" style="color:rgb(170, 9, 130)">100</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><ol start="3"><li><p><strong>为被驱动表匹配的条件增加索引(减少内表的循环匹配次数)</strong></p></li><li><p><strong>增加 join_buffer_size 的大小(外表一次性缓存的数据越多,那么内表的加载次数越少,扫描次数也越少)</strong></p></li><li><p><strong>减少驱动表不必要的查询字段(字段越少,join buffer 能缓存的数据就越多)</strong></p></li></ol><h2 class="anchor anchorWithStickyNavbar_loeA" id="子查询优化">子查询优化<a class="hash-link" href="#子查询优化" title="标题的直接链接">​</a></h2><blockquote><p>MySQL从4.1版本开始支持子查询，使用子查询可以进行 SELECT 语句的嵌套查询，即一个SELECT查询的结果作为另一个SELECT语句的条件。</p><p><strong>子查询可以一次性完成很多逻辑上需要多个步骤才能完成的 SQL 操作</strong></p></blockquote><p>子查询可以帮助我们通过一个 SQL 语句实现比较复杂的查询,但子查询的执行效率不高</p><ol><li><p>执行子查询时，MySQL需要为内层查询语句的查询结果<code>建立一个临时表</code> , 然后外层查询语句从临时表中查询记录,查询完毕后，再<code>撤销这些临时表</code>。这样会消耗过多的CPU和IO资源，产生大量的慢查询</p></li><li><p>子查询的结果集存储的临时表，不论是内存临时表还是磁盘临时表都<code>没有临时表</code>，所以查询性能会受到一定的影响</p></li><li><p>对于返回结果集比较大的子查询，其对查询性能的影响也就越大</p></li><li><mark>可以使用连接(JOIN)查询代替子查询,连接查询<strong>不需要建立临时表,速度比子查询快,而且查询中如果使用索引,性能会更高</strong></mark></li></ol><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>查询班长的信息示例</div><div class="admonitionContent_vXIg"><p><strong>1.使用子查询的方式</strong></p><p><img loading="lazy" alt="image-20220803130231171" src="/assets/images/image-20220803130231171-a09702387c06d88f768c0866b2d0fb27.png" width="3500" height="848" class="img_CujE"></p><br><p><strong>2.使用多表查询</strong></p><p><img loading="lazy" alt="image-20220803131052908" src="/assets/images/image-20220803131052908-a741026737e01abfa2250eedc4bb4852.png" width="3118" height="444" class="img_CujE"></p></div></div><div class="theme-admonition theme-admonition-tip alert alert--success admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>结论</div><div class="admonitionContent_vXIg"><p>尽量不要使用NOT IN 或者 NOT EXISTS，用 <em>LEFT JOIN xxx ON xx WHERE xx IS NULL</em>替代</p></div></div><h2 class="anchor anchorWithStickyNavbar_loeA" id="排序优化">排序优化<a class="hash-link" href="#排序优化" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_loeA" id="优化建议">优化建议<a class="hash-link" href="#优化建议" title="标题的直接链接">​</a></h3><ol><li><p>可以在 WHERE 子句和 ORDER BY 子句中使用索引</p><ul><li>在 WHERE 子句中是为了<code>避免全表扫描</code></li><li>在 ORDER BY 子句中是为了<code>避免使用FileSort 排序</code></li></ul></li><li><p>尽量使用 Index 完成 ORDER BY 排序</p><ul><li><p><strong>如果 WHERE 和 ORDER BY 后面是相同的列就使用单索引列</strong> </p></li><li><p><strong>如果不同就使用联合索引</strong></p></li></ul></li><li><p><strong>无法使用 Index 时，需要对 FileSort 方式进行调优</strong></p></li></ol><h3 class="anchor anchorWithStickyNavbar_loeA" id="测试">测试<a class="hash-link" href="#测试" title="标题的直接链接">​</a></h3><blockquote><p>删除 student表和 class 表中已经创建的索引信息</p></blockquote><p><strong>1.过程一</strong></p><p><img loading="lazy" alt="image-20220803133334382" src="/assets/images/image-20220803133334382-df9c39f372d58800078ae95072050ff8.png" width="2788" height="720" class="img_CujE"></p><p><strong>2.过程二: order by时不 limit,索引失效</strong></p><ul><li>为什么有索引,但是没有 limit,最后执行次查询语句的时候没有使用索引呢?<ul><li><strong>查询优化器认为没有 limit,而且需要查询所有字段(SELECT *), 使用索引后还需要一个个的回表查询所有的字段,性能还没有直接在内存中filieSort 高,所以干脆全表扫描了</strong></li><li><strong>而使用 limit 虽然与索引无关,但是在数据量小之后,利用索引找到前十条数据再进行回表查看数据比直接内存中filesort 效率更高,所以就用索引了</strong></li></ul></li><li>还有其他方案么?<ul><li><strong>满足的索引的索引列 放在 SELECT 查询字段中,而不是 SELECT * </strong></li></ul></li></ul><p><img loading="lazy" alt="image-20220803133814996" src="/assets/images/image-20220803133814996-3fed08ef1848bfd318ff98028e6c37c0.png" width="2850" height="1048" class="img_CujE"></p><p><strong>2.1 覆盖索引避免回表</strong></p><p><img loading="lazy" alt="image-20220803135347457" src="/assets/images/image-20220803135347457-cefd8f688b6765eeb7fe3fd4871e0226.png" width="3126" height="1082" class="img_CujE"></p><p><strong>3.过程三: Order By时顺序出错,索引失效</strong></p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal"># 创建索引(age,classId,stuno) + 已有的索引(age,classId,name)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">INDEX</span><span class="token plain"> idx_age_cid_stuno </span><span class="token keyword" style="color:rgb(12, 150, 155)">ON</span><span class="token plain"> student</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">age</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">classId</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">stuno</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">#以下哪些索引失效</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- ❌</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">from</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">order</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> classId </span><span class="token keyword" style="color:rgb(12, 150, 155)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- ❌</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">from</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">order</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">by</span><span class="token plain"> classId</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">name </span><span class="token keyword" style="color:rgb(12, 150, 155)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- ✅</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">from</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">order</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> age</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">classId</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">stuno </span><span class="token keyword" style="color:rgb(12, 150, 155)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- ✅</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">from</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">order</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> age</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">classId </span><span class="token keyword" style="color:rgb(12, 150, 155)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- ✅</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">from</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">order</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> age </span><span class="token keyword" style="color:rgb(12, 150, 155)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们注意到,后面两个的使用索引的 key_len都是 93</p><p><img loading="lazy" alt="image-20220803141016819" src="/assets/images/image-20220803141016819-1a2d91caa28867c0769428e7b1747b8b.png" width="2880" height="1096" class="img_CujE"></p><p><strong>4.过程四: order by时规则不一致,索引失效</strong></p><ul><li>在 MySQL 8.0 中有降序索引打破这个问题</li></ul><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- ❌</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> age </span><span class="token keyword" style="color:rgb(12, 150, 155)">DESC</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">classId </span><span class="token keyword" style="color:rgb(12, 150, 155)">ASC</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- ❌</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> classId </span><span class="token keyword" style="color:rgb(12, 150, 155)">DESC</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">name </span><span class="token keyword" style="color:rgb(12, 150, 155)">DESC</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- ❌</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> age </span><span class="token keyword" style="color:rgb(12, 150, 155)">ASC</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">classId </span><span class="token keyword" style="color:rgb(12, 150, 155)">DESC</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- ✅</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> age </span><span class="token keyword" style="color:rgb(12, 150, 155)">DESC</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">classId </span><span class="token keyword" style="color:rgb(12, 150, 155)">DESC</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20220803141557094" src="/assets/images/image-20220803141557094-58a7b87f6d8f859b1cb17675bc10b57f.png" width="3374" height="1464" class="img_CujE"></p><p><strong>5.过程五: 没有过滤,不索引</strong></p><ul><li>第三个没有用到索引,发现过滤完还有很多数据,而且需要一个个回表,所以干脆使用文件排序了</li></ul><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- ✅</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> age</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">45</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> classId</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- ✅</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> age</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">45</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> classId</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- ❌</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> classId</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">45</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> age</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- ✅</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> classId</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">45</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> age </span><span class="token keyword" style="color:rgb(12, 150, 155)">limit</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20220803143146972" src="/assets/images/image-20220803143146972-ca3edf04a7ce16ee485d1261322e6f7b.png" width="3324" height="1476" class="img_CujE"></p><p><strong>5.1 为什么第四个走索引了? </strong></p><ul><li><a href="https://dev.mysql.com/doc/refman/8.0/en/limit-optimization.html" target="_blank" rel="noopener noreferrer">官方文档</a></li><li><strong>对于一些单表查询的Order By(Group By) + Limit 查询，MySQL 优化器一般会优先考虑通过Order By(Group By)字段索引进行排序优化</strong><ul><li><code>当where条件不具有较大过滤性时，这种做法往往是比较好的</code></li><li><code>当where条件过滤性较好时，优先通过where条件进行条件过滤优化</code></li></ul></li><li>从MySQL 8.0.21开始，可以通过将<code>optimizer_switch</code>系统变量的<code>prefer_ordering_index</code>标志设置为<code>OFF</code>，来关闭这种优化 </li></ul><p><img loading="lazy" alt="image-20220803144819624" src="/assets/images/image-20220803144819624-b79d317e40c073435bad500597084c67.png" width="3426" height="556" class="img_CujE"></p><h3 class="anchor anchorWithStickyNavbar_loeA" id="filesort-算法">fileSort 算法<a class="hash-link" href="#filesort-算法" title="标题的直接链接">​</a></h3><ul><li><strong>在内存或者磁盘上的排序统一称为 filesort</strong></li><li>排序的字段如果不在索引列上,则 filesort 会有两种算法:<ul><li><code>双路排序</code></li><li><code>单路排序</code></li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_loeA" id="双路排序慢">双路排序(慢)<a class="hash-link" href="#双路排序慢" title="标题的直接链接">​</a></h4><ul><li><code>MySQL4.1 之前使用的双路排序算法</code>,字面意思就是<code>两次扫描磁盘,最终得到数据</code>。读取行指针和<code>order by字段</code>,然后对他们进行排序。然后扫描已经排好序的列表,按照列表中的值重新从列表读取对应的数据</li><li>反馈在磁盘上就是,<code>从磁盘取排序字段 -&gt; 在 buffer 进行排序 -&gt; 再从磁盘获取其他字段</code></li><li><strong>问题</strong> : 需要进行两次磁盘扫描,IO消耗大</li></ul><h5 class="anchor anchorWithStickyNavbar_loeA" id="单路排序快">单路排序(快)<a class="hash-link" href="#单路排序快" title="标题的直接链接">​</a></h5><ul><li><strong>概述</strong><ul><li>从磁盘读取查询需要的<code>所有列</code>,然后在 sort_buffer中对order by 字段进行排序,最后输出数据<ul><li>这样的效率更加的高一点(以空间换时间)</li><li>同时将随机 IO 变成了顺序 IO</li></ul></li></ul></li><li><strong>结论</strong><ul><li>总体上说,单路优于双路</li><li>但是单路有问题:<ul><li>在 sort_buffer中,单路需要比多路<code>占用更多的空间</code>。如果超出了<code>sort_buffer</code>的容量,就需要分批的排序(每批排序需要建立 tmp 文件),最后进行<code>多路合并</code>。本来想省一次 IO,但是最后却带来了<code>大量的 IO</code></li></ul></li></ul></li></ul><h5 class="anchor anchorWithStickyNavbar_loeA" id="优化策略">优化策略<a class="hash-link" href="#优化策略" title="标题的直接链接">​</a></h5><ol><li><p><code>提高 sort_buffer_size</code></p></li><li><p><code>提高 max_length_for_sort_data</code></p></li><li><p><code>Order By时 SELECT * 是一个大忌,最好是查询需要的字段</code></p></li></ol><h2 class="anchor anchorWithStickyNavbar_loeA" id="group-by-优化">Group By 优化<a class="hash-link" href="#group-by-优化" title="标题的直接链接">​</a></h2><ol><li>Group By 使用索引的原则几乎跟Order By一致 ，Group By 即使没有过滤条件用到索引，也可以直接使用索引。</li><li>Group By 先排序再分组，遵照索引建的最佳左前缀法则</li><li>当无法使用索引列，增大 <code>max_length_for_sort_data</code> 和 <code>sort_buffer_size</code> 参数的设置</li><li>WHERE 效率高于 HAVING ,能写在 WHERE 限定的条件就不要写在 HAVING 中了</li><li>减少使用ORDER BY，和业务沟通能不排序就不排序，或将排序放到程序端去做。Order by、group by、distinct这些语句较为耗费CPU，数据库的CPU资源是极其宝贵的</li><li>包含了order by、group by、distinct这些查询的语句，where条件过滤出来的结果集请保持在1000行 以内，否则SQL会很慢 </li></ol><h2 class="anchor anchorWithStickyNavbar_loeA" id="分页优化">分页优化<a class="hash-link" href="#分页优化" title="标题的直接链接">​</a></h2><blockquote><p><strong>一般分页查询时,通过创建覆盖索引可以较好的提高性能</strong></p></blockquote><p><strong>如何优化下面的 分页查询?</strong></p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">explain</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">from</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">limit</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">2000000</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">10</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>优化思路1</strong></p><p><code>在索引上完成排序分页操作，最后根据主键关联回原表查询所需要的其他列内容。</code></p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> student t</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> id </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> id </span><span class="token keyword" style="color:rgb(12, 150, 155)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">2000000</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> a</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> t</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">id </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>优化思路2</strong></p><p><strong>该方案适用于主键自增的表，</strong><code>可以把Limit 查询转换成某个位置的查询</code></p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(12, 150, 155)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">2000000</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">10</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_loeA" id="优先考虑覆盖索引">优先考虑覆盖索引<a class="hash-link" href="#优先考虑覆盖索引" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_loeA" id="什么是覆盖索引">什么是覆盖索引<a class="hash-link" href="#什么是覆盖索引" title="标题的直接链接">​</a></h3><blockquote><p>简单说就是，<code> 索引列+主键</code> 包含 <code>SELECT 到 FROM之间查询的列</code> </p></blockquote><ul><li><strong>理解方式一</strong><ul><li>索引是高效找到行的一个方法，但是一般数据库也能使用索引找到一个列的数据，因此它不必读取整个行。毕竟索引叶子节点存储了它们索引的数据;</li><li>当能通过读取索引就可以得到想要的数据，那就不需要读取行了。 <code>一个索引包含了满足查询结果的数据就叫做覆盖索引</code></li></ul></li><li><strong>理解方式二</strong><ul><li>非聚簇联合索引的一种形式，索引列包含查询里的SELECT、JOIN、WHERE子句用到的所有列 <ul><li><strong>即建索引的字段正好是覆盖查询条件中所涉及的字段</strong></li></ul></li></ul></li><li><code>索引覆盖就是不需要回表!</code></li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>覆盖索引优化</div><div class="admonitionContent_vXIg"><p><strong>为 student 建立索引(age,name)</strong></p><p><strong>示例 1:观察覆盖和非覆盖索引</strong></p><ul><li>没有使用覆盖索引:<ul><li>虽然 age 上有索引,但是失效了。因为where 过滤后的结果很多,还需要一次一次的回表获取所有的字段数据,优化器认为不如直接全表扫描来的快</li></ul></li><li>使用了覆盖索引:<ul><li>通过 Select 限定了获取索引列对应的字段数据,这样就不需要回表了,优化器就可以安心的利用 age 索引进行 &lt; &gt; 的操作</li></ul></li></ul><p><img loading="lazy" alt="image-20220803161240458" src="/assets/images/image-20220803161240458-78e59624b31e2f8edf25140e7579ef8f.png" width="3218" height="994" class="img_CujE"></p><p><strong>示例 2: 模糊匹配,建立单值索引(name)</strong></p><p><img loading="lazy" alt="image-20220803162640483" src="/assets/images/image-20220803162640483-a8e651babe82d9133dd7d589e7c9961a.png" width="3092" height="910" class="img_CujE"></p></div></div><h3 class="anchor anchorWithStickyNavbar_loeA" id="覆盖索引的利弊">覆盖索引的利弊<a class="hash-link" href="#覆盖索引的利弊" title="标题的直接链接">​</a></h3><p><strong>好处</strong></p><ol><li>避免Innodb表进行索引的二次查询(回表)</li><li>可以把随机IO变成顺序IO加快查询效率<ul><li>回表找数据的时候,数据不一定在同一个页,那么要确定的页的位置,就是随机 IO 了</li><li>而不回表的话,由于分配的时候多个页是连续的,所以就是顺序 IO</li></ul></li></ol><p><strong>弊端</strong></p><p><code>索引字段的维护</code>总是有代价的。因此，在建立<strong>冗余索引</strong>来支持覆盖索引时就需要权衡考虑了</p><h2 class="anchor anchorWithStickyNavbar_loeA" id="索引条件下推icp">索引条件下推(ICP)<a class="hash-link" href="#索引条件下推icp" title="标题的直接链接">​</a></h2><blockquote><p>用于减少回表次数</p></blockquote><h3 class="anchor anchorWithStickyNavbar_loeA" id="使用示例与前后对比">使用示例与前后对比<a class="hash-link" href="#使用示例与前后对比" title="标题的直接链接">​</a></h3><ul><li><p><strong>概述</strong></p><ul><li><code>索引条件下推</code>(Index Condition Pushdown)是MySQL 5.6中新特性，是一种<code>在存储引擎层使用索引过滤数据的一种优化方式</code></li><li><strong>ICP可以减少存储引擎访问基表的次数以及MySQL服务器访问存储引擎的次数</strong></li></ul></li><li><mark>ICP 一般来说是对联合索引的,而且存在索引失效的情况</mark></li><li><p><strong>是否开启 ICP 的区别?</strong></p><ul><li><p><strong>没有 ICP</strong></p><ul><li>当进行索引查询的时候,首先根据索引查找记录(<code>进行回表</code>),然后再根据<code>WHERE</code>条件来过滤记录</li></ul></li><li><p><strong>启用 ICP 后</strong></p><ul><li>当进行索引查询的时候,MySQL 在取出索引的同时,判断是否可以按照 WHERE 条件进行过滤,也就是<strong>将 WHERE 的部分过滤放在了存储引擎层</strong>,最后在根据索引查找记录(<code>进行回表</code>)</li></ul></li></ul></li><li><p><strong>好处</strong></p><ul><li>ICP 可以<strong>减少存储引擎必须访问基表的次数和 MySQL 服务器必须访问存储引擎的次数</strong></li></ul></li><li><p><strong>缺点</strong></p><ul><li>ICP 的<code>加速效果</code>取决于在存储引擎中通过<code>ICP 筛选</code>掉的数据比例</li></ul></li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>索引下推的试验</div><div class="admonitionContent_vXIg"><p>这里的<code>index condition</code>就是索引条件下推</p><ul><li>如果没有索引条件下推<ul><li>就是先通过<strong>key_part1 &gt; ‘a’</strong>找到数据后回表,然后利用回表的数据在过滤 <strong>key_part2 like ‘%a’</strong>的</li></ul></li><li>使用索引条件下推<ul><li>就是通过<strong>key_part1 &gt; ‘a’</strong>找到数据后,<code>没有直接回表</code>,而是<strong>再过滤 key_part2 like ‘%a’</strong>的数据,最后在回表<ul><li><mark>注意:由于 common_field不在索引列,所以无法享受 ICP</mark></li></ul></li><li><strong>这种方式需要回表的数量比乜有 ICP 小很多</strong> </li></ul></li></ul><p><img loading="lazy" alt="image-20220803170321729" src="/assets/images/image-20220803170321729-64ba2e9dbe77c11f66f250819f9e5dba.png" width="3356" height="376" class="img_CujE"></p></div></div><h3 class="anchor anchorWithStickyNavbar_loeA" id="icp-开启关闭">ICP 开启/关闭<a class="hash-link" href="#icp-开启关闭" title="标题的直接链接">​</a></h3><p>默认情况下<strong>启用索引条件下推</strong>,可以通过设置系统变量<code>optimizer_switch</code>的<code>index_condition_pushdown</code></p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- 关闭</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">set</span><span class="token plain"> optimizer_switch </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;index_condition_pushdown=off&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- 开启</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">set</span><span class="token plain"> optimizer_switch </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;index_condition_pushdown=on&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20220803171909765" src="/assets/images/image-20220803171909765-dd75f1b320527038aafd86a43b9c12d7.png" width="2516" height="1016" class="img_CujE"></p><h3 class="anchor anchorWithStickyNavbar_loeA" id="使用条件">使用条件<a class="hash-link" href="#使用条件" title="标题的直接链接">​</a></h3><ol><li>表的访问类型需要为<code>range、ref、eq_ref、ref_or_null</code> 可以使用 ICP</li><li>ICP 可以用于<code>InnoDB、MyISAM</code></li><li>对于<code>InnoDB</code>,ICP 仅适用于<code>二级索引</code>。<strong>ICP 的目标是减少回表次数,从而减少 IO 操作次数</strong></li><li><strong>当 SQL 使用索引覆盖时,不支持 ICP</strong></li><li><strong>相关子查询的条件不能使用 ICP</strong></li></ol><h2 class="anchor anchorWithStickyNavbar_loeA" id="普通索引还是唯一索引">普通索引还是唯一索引<a class="hash-link" href="#普通索引还是唯一索引" title="标题的直接链接">​</a></h2><blockquote><p><strong>从性能的角度考虑，你选择唯一索引还是普通索引呢?选择的依据是什么呢?</strong></p><p>假设，我们有一个主键列为ID的表，表中有字段k，并且在k上有索引，假设字段 k 上的值都不重复。</p><p>这个表的建表语句是:</p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">create</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">table</span><span class="token plain"> test</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  id        </span><span class="token keyword" style="color:rgb(12, 150, 155)">int</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">primary</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">key</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    k       </span><span class="token keyword" style="color:rgb(12, 150, 155)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">null</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    name    </span><span class="token keyword" style="color:rgb(12, 150, 155)">varchar</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token number" style="color:rgb(170, 9, 130)">16</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">index</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">k</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token keyword" style="color:rgb(12, 150, 155)">engine</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token keyword" style="color:rgb(12, 150, 155)">InnoDB</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><h3 class="anchor anchorWithStickyNavbar_loeA" id="查询过程">查询过程<a class="hash-link" href="#查询过程" title="标题的直接链接">​</a></h3><blockquote><p>假设，执行查询的语句是 select id from test where k=5</p></blockquote><ol><li><strong>对于普通索引来说</strong><ul><li>查找到满足条件的第一个记录之后,会继续往下查询,直到碰到下一个不满足条件的,因为后面的也不会满足条件了</li></ul></li><li><strong>对于唯一索引来说</strong><ul><li>查找到满足条件的第一个记录之后,就会停止查询了</li></ul></li></ol><mark>但是这种不同的策略带来的性能差距是微乎其微的!</mark><h3 class="anchor anchorWithStickyNavbar_loeA" id="change-buffer">Change buffer<a class="hash-link" href="#change-buffer" title="标题的直接链接">​</a></h3><blockquote><p><strong>缓存更新操作,然后逐步 merge 更新</strong></p></blockquote><p>当需要更新一个数据页时，如果数据页在内存中就直接更新，而如果这个数据页还没有在内存中的话,在不影响数据一致性的前提下, <code>InooDB会将这些更新操作缓存在change buffer中</code>,这样就不需要从磁盘中读入这个数据页了。在下次查询需要访问这个数据页的时候，将数据页读入内存，然后执行change buffer中与这个页有关的操作。<strong>通过这种方式就能保证这个数据逻辑的正确性</strong></p><p>将Change buffer中的操作应用到原数据页，得到最新结果的过程称为<code>merge</code> 。除了<code>访问这个数据页</code> 会触发merge外，系统有 后<code>台线程会定期 merge</code>。在<code>数据正常关闭(shutdown)</code>的过程中，也会执行merge 操作。</p><p>如果能够将更新操作先记录在change buffer,<code>减少读磁盘</code>,语句的执行速度会得到明显的提升。而且，数据读入内存是需要占用 buffer pool 的，所以这种方式还能够<code>避免占用内存</code> ，提高内存利用率。</p><mark>唯一索引的更新就不能使用change buffer ，实际上也只有普通索引可以使用</mark><h2 class="anchor anchorWithStickyNavbar_loeA" id="其他查询优化策略">其他查询优化策略<a class="hash-link" href="#其他查询优化策略" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_loeA" id="exists-和-in">Exists 和 IN<a class="hash-link" href="#exists-和-in" title="标题的直接链接">​</a></h3><blockquote><p><strong>问题: 哪种情况应该使用 Exists,哪种用 IN。选择的标准是看能否使用索引么</strong></p><p><strong>回答:</strong>索引是一个前提,实际上选择与否还是要看表的大小。可以把选择标准理解为<code>小表驱动大表</code></p></blockquote><ul><li><mark>IN 后面加小表,Exists 后面跟大表</mark></li><li><code>A exists B </code><ul><li>A 里面是否包含 B,即 <strong>小表 exists 大表</strong></li><li>执行时循环着从 A 里面取出数据去 B 里面看有没有匹配的</li></ul></li><li><code>A IN B</code> <ul><li>B 里面是否包含 A,即 <strong>大表 IN 小表</strong></li><li>执行时循环着从 B 里面取出数据去 A 里面看有没有匹配的</li></ul></li></ul><p>比如下面的两种 SQL:</p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- 方式 1:使用 IN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> A </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> cc </span><span class="token operator" style="color:rgb(12, 150, 155)">in</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> cc </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> B</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:normal">-- 方式 2:使用 EXISTS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> A </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">EXISTS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> cc </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> B </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> B</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">cc</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain">A</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">cc</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li><p><strong>当 A 小于 B 的时候,使用 EXISTS的方式,因为 Exists 相当于外层循环,实现逻辑相当于</strong></p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">for</span><span class="token plain"> m </span><span class="token operator" style="color:rgb(12, 150, 155)">in</span><span class="token plain"> A</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">for</span><span class="token plain"> n </span><span class="token operator" style="color:rgb(12, 150, 155)">in</span><span class="token plain"> B</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        </span><span class="token keyword" style="color:rgb(12, 150, 155)">if</span><span class="token plain"> m</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain">cc</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain">n</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">cc </span><span class="token keyword" style="color:rgb(12, 150, 155)">then</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>当 A 大于 B 的时候,使用 IN的方式,因为 IN 相当于层层循环,实现逻辑相当于</strong></p><div class="language-sql codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-sql codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">for</span><span class="token plain"> m </span><span class="token operator" style="color:rgb(12, 150, 155)">in</span><span class="token plain"> B</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">for</span><span class="token plain"> n </span><span class="token operator" style="color:rgb(12, 150, 155)">in</span><span class="token plain"> A</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        </span><span class="token keyword" style="color:rgb(12, 150, 155)">if</span><span class="token plain"> m</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain">cc</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain">n</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">cc </span><span class="token keyword" style="color:rgb(12, 150, 155)">then</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h3 class="anchor anchorWithStickyNavbar_loeA" id="count-与-count字段">COUNT(*) 与 COUNT(字段)<a class="hash-link" href="#count-与-count字段" title="标题的直接链接">​</a></h3><blockquote><p><strong>问题:MySQL 中统计标的行数,可以使用 COUNT(1)、COUNT(*)、COUNT(字段),这三种方式查询效率怎样?</strong></p><p><strong>回答: 前提是要统计的是某个字段的非空数据行数,那另当别论</strong></p></blockquote><p><strong>环节 1:</strong></p><p><code>COUNT(1)</code>和<code>COUNT(*)</code>都是对所有结果进行 <code>COUNT</code>,两者没有本质上的区别。</p><p><strong>环节 2:</strong></p><p>如果是 <strong>MyISAM 存储引擎</strong>,那么统计数据表的行数只需要 <code>O(1)</code>的复杂度,因为每张 MyISAM 的数据表都有一个 meta 信息存储了<code>row_count</code>字段,且一致性由<code>表锁</code>保证</p><p>如果是<strong>InnoDB 存储引擎</strong>,因为 InnoDB 支持事务,采用<code>行级锁 + MVCC 机制</code>,无法向 MyISAM 一样维护一个<em>row_count</em>变量,所以需要<code>扫描全表</code></p><p><strong>环节 3</strong></p><p>在 InnoDB 存储引擎中:</p><ul><li>如果使用<code>COUNT(字段)</code>的方式统计行数,应该尽量使用<code>二级索引</code>,因为主键的聚簇索引包含的信息多,占用的空间多,加载的成本高</li><li>如果使用<code>COUNT(1)、COUNT(*)</code>,他们不需要查找具体的行,只是统计行数,优化器会<code>自动选择占用空间更小的二级索引</code>进行统计</li></ul><h3 class="anchor anchorWithStickyNavbar_loeA" id="关于select">关于SELECT(*)<a class="hash-link" href="#关于select" title="标题的直接链接">​</a></h3><p>在表查询中建议明确字段，不要使用 * 作为查询的字段列表。<strong>推荐使用SELECT &lt;字段列表&gt; 查询</strong>。原因如下:</p><ol><li>MySQL 在解析的过程中，会通过 <code>查询数据字典</code> 将&quot;*&quot;按序转换成所有列名，这会大大的耗费资源和时间</li><li>无法使用<code>覆盖索引</code></li></ol><h3 class="anchor anchorWithStickyNavbar_loeA" id="limit-1-对优化的影响">LIMIT 1 对优化的影响<a class="hash-link" href="#limit-1-对优化的影响" title="标题的直接链接">​</a></h3><ol><li><p><strong>针对的是会扫描全表的SQL语句，如果你可以确定结果集只有一条，那么加上LIMIT 1的时候，当找到一条结果的时候就不会继续扫描了，这样会加快查询速度</strong></p></li><li><p>如果数据表已经对字段建立了唯一索引，那就不需要加上 LIMIT 1了</p></li></ol><h3 class="anchor anchorWithStickyNavbar_loeA" id="多用-commit">多用 COMMIT<a class="hash-link" href="#多用-commit" title="标题的直接链接">​</a></h3><ul><li>只要有可能，在程序中尽量多使用 COMMIT，这样程序的性能得到提高，因为 <code>COMMIT 会所释放一些资源</code></li><li>COMMIT 所释放的资源:<ul><li>回滚段上用于恢复数据的信息</li><li>被程序语句获得的锁</li><li>redo log buffer、  undo log buffer 中的空间</li><li>管理上述 3 种资源中的内部花费</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_loeA" id="淘宝数据库主键如何设计">淘宝数据库主键如何设计<a class="hash-link" href="#淘宝数据库主键如何设计" title="标题的直接链接">​</a></h2><blockquote><p>聊一个实际问题:<strong>淘宝的数据库的主键是如何设计的?</strong></p><p>某些错的离谱的答案还在网上年复一年的流传着，甚至还成为了所谓的MySQL军规。其中，一个最明显的错误就是关于MySQL的主键设计。</p><p><strong>大部分人的回答如此自信: 用8字节的 BIGINT 做主键，而不要用INT。 错 !</strong></p><p>这样的回答，只站在了数据库这一层，而没有<code>从业务的角度</code>思考主键。主键就是一个自增ID吗?站在 2022年的新年档口，用自增做主键，架构设计上可能<code>连及格都达不到</code>。</p></blockquote><h3 class="anchor anchorWithStickyNavbar_loeA" id="自增-id-的问题">自增 ID 的问题<a class="hash-link" href="#自增-id-的问题" title="标题的直接链接">​</a></h3><p>自增ID做主键,简单易懂,几乎所有数据库都支持自增类型,只是实现上各自有所不同而已。</p><p>自增ID除了简单，其他都是缺点，总体来看存在以下几方面的问题:</p><ol><li><p><code>可靠性不高</code></p><ul><li><strong>存在自增ID回溯的问题</strong>,这个问题直到最新版本的MySQL 8.0才修复</li></ul></li><li><p><code>安全性不高</code></p><ul><li>对外暴露的接口可以非常容易猜测对应的信息</li><li>比如:/User/1/这样的接口，可以非常容易猜测用户ID的值为多少，总用户数量有多少，也可以非常容易地通过接口进行数据的爬取</li></ul></li><li><p><code>性能差</code></p><ul><li><strong>自增ID的性能较差，需要在数据库服务器端生成</strong></li></ul></li><li><p><code>交互多</code></p><ul><li>业务还需要额外执行一次类似 <code>last_insert_id()</code> 的函数才能知道刚才插入的自增值，这需要多一次的网络交互</li><li>在海量并发的系统中，多1条SQL，就多一次性能上的开销</li></ul></li><li><p><code>局部唯一性</code></p><ul><li>最重要的一点,<strong>自增ID是局部唯一,只在当前数据库实例中唯一,而不是全局唯一</strong>,于目前分布式系统来说，这简直就是噩梦。</li></ul></li></ol><h3 class="anchor anchorWithStickyNavbar_loeA" id="淘宝的主键设计">淘宝的主键设计<a class="hash-link" href="#淘宝的主键设计" title="标题的直接链接">​</a></h3><blockquote><p>在淘宝的电商业务中，订单服务是一个核心业务。请问 <code>订单表的主键</code> 淘宝是如何设计的呢?是自增ID吗?</p></blockquote><p>我们打开淘宝，看一下订单信息:</p><p><img loading="lazy" alt="image-20220803235158379" src="/assets/images/image-20220803235158379-1db087e9e5c31ec13383032faa9faced.png" width="1182" height="748" class="img_CujE"></p><p>从上图可以发现，订单号不是自增ID!我们详细看下上述4个订单号:</p><div class="language-java codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-java codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token number" style="color:rgb(170, 9, 130)">2749132548444</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">644054</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token number" style="color:rgb(170, 9, 130)">2736836496798</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">644054</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token number" style="color:rgb(170, 9, 130)">2735489341599</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">644054</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>订单号是19位的长度，且订单的最后5位都是一样的，都是644054。且订单号的前面14位部分是<code>单调递增</code> 的,我们可以大胆的推测,淘宝的订单 ID 设计应该是:</p><div class="language-init codeBlockContainer_APcc theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_m3Ux"><pre tabindex="0" class="prism-code language-init codeBlock_qGQc thin-scrollbar"><code class="codeBlockLines_p187"><span class="token-line" style="color:#403f53"><span class="token plain">订单ID = 时间 + 去重字段 + 用户ID后6位尾号</span><br></span></code></pre><div class="buttonGroup_6DOT"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_FhaS" aria-hidden="true"><svg class="copyButtonIcon_phi_" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_FfTR" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>这样的设计能做到全局唯一，且对分布式系统查询及其友好。</strong></p><h3 class="anchor anchorWithStickyNavbar_loeA" id="推荐的主键设计">推荐的主键设计<a class="hash-link" href="#推荐的主键设计" title="标题的直接链接">​</a></h3><ul><li><p><code>非核心业务</code></p><ul><li>对应表的主键自增ID，如告警、日志、监控等信息</li></ul></li><li><p><code>核心业务</code></p><ul><li><code>主键设计至少应该是全局唯一且是单调递增</code><ul><li><strong>全局唯一保证在各系统之间都是唯一的，单调递增是希望插入时不影响数据库性能</strong></li></ul></li></ul></li></ul><div class="theme-admonition theme-admonition-tip alert alert--success admonition_WoCw"><div class="admonitionHeading_TMsN"><span class="admonitionIcon_Ibzs"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>建议</div><div class="admonitionContent_vXIg"><p>建议尽量不要用跟业务有关的字段做主键。毕竟我们谁也无法预测在项目的整个生命周期中，哪个业务字段会因为项目的业务需求而有重复，或者重用之类的情况出现</p></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/MagicalZhu/NoteLib/tree/main/docs/Mysql/高级特性/索引与查询优化.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_N_05" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_VsjB"><span class="theme-last-updated">最后<!-- -->由 <b>YuLiang Zhu</b> <!-- -->于 <b><time datetime="2022-12-06T01:19:52.000Z">2022年12月6日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Mysql/高级特性/性能监控工具"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">性能监控工具</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Mysql/高级特性/数据库设计规范"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">数据库设计规范</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_jeP5 thin-scrollbar theme-doc-toc-desktop"><p class="content_nRws">Contents</p><ul class="table-of-contents table-of-contents__left-border"><li><a href="#数据准备" class="table-of-contents__link toc-highlight">数据准备</a></li><li><a href="#索引匹配与失效" class="table-of-contents__link toc-highlight">索引匹配与失效</a><ul><li><a href="#1全值匹配法则" class="table-of-contents__link toc-highlight">1.全值匹配法则</a></li><li><a href="#2最左侧列匹配法则" class="table-of-contents__link toc-highlight">2.最左侧列匹配法则</a></li><li><a href="#3主键插入顺序" class="table-of-contents__link toc-highlight">3.主键插入顺序</a></li><li><a href="#4索引列的计算函数导致索引失效" class="table-of-contents__link toc-highlight">4.索引列的计算、函数导致索引失效</a></li><li><a href="#5类型转换自动或手动导致索引失效" class="table-of-contents__link toc-highlight">5.类型转换(自动或手动)导致索引失效</a></li><li><a href="#6范围条件右边的列索引失效" class="table-of-contents__link toc-highlight">6.范围条件右边的列索引失效</a></li><li><a href="#7不等于-或者--导致索引失效" class="table-of-contents__link toc-highlight">7.不等于(!= 或者 &lt; &gt;)导致索引失效</a></li><li><a href="#8is-null-和-is-not-null" class="table-of-contents__link toc-highlight">8.IS NULL 和 IS NOT NULL</a></li><li><a href="#9like以通配符开头索引" class="table-of-contents__link toc-highlight">9.Like以通配符%开头索引</a></li><li><a href="#10or-前后存在非索引的列" class="table-of-contents__link toc-highlight">10.OR 前后存在非索引的列</a></li><li><a href="#11数据库和表的字符集统一使用utf8mb4" class="table-of-contents__link toc-highlight">11.数据库和表的字符集统一使用utf8mb4</a></li><li><a href="#12-order-by时规则不一致索引失效" class="table-of-contents__link toc-highlight">12. order by时规则不一致,索引失效</a></li><li><a href="#小结" class="table-of-contents__link toc-highlight">小结</a></li></ul></li><li><a href="#关联查询优化" class="table-of-contents__link toc-highlight">关联查询优化</a><ul><li><a href="#数据准备-1" class="table-of-contents__link toc-highlight">数据准备</a></li><li><a href="#连接过程简介" class="table-of-contents__link toc-highlight">连接过程简介</a></li><li><a href="#内外连接" class="table-of-contents__link toc-highlight">内外连接</a><ul><li><a href="#采用外连接" class="table-of-contents__link toc-highlight">采用外连接</a></li><li><a href="#采用内连接" class="table-of-contents__link toc-highlight">采用内连接</a></li></ul></li><li><a href="#join-语句原理" class="table-of-contents__link toc-highlight">join 语句原理</a><ul><li><a href="#驱动表与被驱动表" class="table-of-contents__link toc-highlight">驱动表与被驱动表</a></li><li><a href="#简单嵌套循环连接" class="table-of-contents__link toc-highlight">简单嵌套循环连接</a></li><li><a href="#索引嵌套循环连接" class="table-of-contents__link toc-highlight">索引嵌套循环连接</a></li><li><a href="#块嵌套循环连接" class="table-of-contents__link toc-highlight">块嵌套循环连接</a><ul><li><a href="#概述" class="table-of-contents__link toc-highlight">概述</a></li><li><a href="#参数设置" class="table-of-contents__link toc-highlight">参数设置</a></li></ul></li><li><a href="#小结-1" class="table-of-contents__link toc-highlight">小结</a></li></ul></li></ul></li><li><a href="#子查询优化" class="table-of-contents__link toc-highlight">子查询优化</a></li><li><a href="#排序优化" class="table-of-contents__link toc-highlight">排序优化</a><ul><li><a href="#优化建议" class="table-of-contents__link toc-highlight">优化建议</a></li><li><a href="#测试" class="table-of-contents__link toc-highlight">测试</a></li><li><a href="#filesort-算法" class="table-of-contents__link toc-highlight">fileSort 算法</a><ul><li><a href="#双路排序慢" class="table-of-contents__link toc-highlight">双路排序(慢)</a><ul><li><a href="#单路排序快" class="table-of-contents__link toc-highlight">单路排序(快)</a></li><li><a href="#优化策略" class="table-of-contents__link toc-highlight">优化策略</a></li></ul></li></ul></li></ul></li><li><a href="#group-by-优化" class="table-of-contents__link toc-highlight">Group By 优化</a></li><li><a href="#分页优化" class="table-of-contents__link toc-highlight">分页优化</a></li><li><a href="#优先考虑覆盖索引" class="table-of-contents__link toc-highlight">优先考虑覆盖索引</a><ul><li><a href="#什么是覆盖索引" class="table-of-contents__link toc-highlight">什么是覆盖索引</a></li><li><a href="#覆盖索引的利弊" class="table-of-contents__link toc-highlight">覆盖索引的利弊</a></li></ul></li><li><a href="#索引条件下推icp" class="table-of-contents__link toc-highlight">索引条件下推(ICP)</a><ul><li><a href="#使用示例与前后对比" class="table-of-contents__link toc-highlight">使用示例与前后对比</a></li><li><a href="#icp-开启关闭" class="table-of-contents__link toc-highlight">ICP 开启/关闭</a></li><li><a href="#使用条件" class="table-of-contents__link toc-highlight">使用条件</a></li></ul></li><li><a href="#普通索引还是唯一索引" class="table-of-contents__link toc-highlight">普通索引还是唯一索引</a><ul><li><a href="#查询过程" class="table-of-contents__link toc-highlight">查询过程</a></li><li><a href="#change-buffer" class="table-of-contents__link toc-highlight">Change buffer</a></li></ul></li><li><a href="#其他查询优化策略" class="table-of-contents__link toc-highlight">其他查询优化策略</a><ul><li><a href="#exists-和-in" class="table-of-contents__link toc-highlight">Exists 和 IN</a></li><li><a href="#count-与-count字段" class="table-of-contents__link toc-highlight">COUNT(*) 与 COUNT(字段)</a></li><li><a href="#关于select" class="table-of-contents__link toc-highlight">关于SELECT(*)</a></li><li><a href="#limit-1-对优化的影响" class="table-of-contents__link toc-highlight">LIMIT 1 对优化的影响</a></li><li><a href="#多用-commit" class="table-of-contents__link toc-highlight">多用 COMMIT</a></li></ul></li><li><a href="#淘宝数据库主键如何设计" class="table-of-contents__link toc-highlight">淘宝数据库主键如何设计</a><ul><li><a href="#自增-id-的问题" class="table-of-contents__link toc-highlight">自增 ID 的问题</a></li><li><a href="#淘宝的主键设计" class="table-of-contents__link toc-highlight">淘宝的主键设计</a></li><li><a href="#推荐的主键设计" class="table-of-contents__link toc-highlight">推荐的主键设计</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">前端链接</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://v3.cn.vuejs.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Vue<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_2l9O"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://react.docschina.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">React<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_2l9O"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="http://ts.xcatliu.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TypeScript<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_2l9O"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://developer.mozilla.org/zh-CN/docs/Web" target="_blank" rel="noopener noreferrer" class="footer__link-item">MDN<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_2l9O"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">后端链接</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://spring.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Spring<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_2l9O"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.docker.com/get-started/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docker<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_2l9O"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://kubernetes.io/zh/docs/home/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kubernetes<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_2l9O"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.oracle.com/javase/8/docs/technotes/tools/windows/index.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">JVM<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_2l9O"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://juejin.cn" target="_blank" rel="noopener noreferrer" class="footer__link-item">掘金<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_2l9O"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.infoq.cn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">InfoQ<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_2l9O"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_2l9O"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">文档构建</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.docusaurus.cn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docusaurus<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_2l9O"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://typoraio.cn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Typora<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_2l9O"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 huakucha. Built With Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.bf86732a.js"></script>
<script src="/assets/js/main.98457ee6.js"></script>
</body>
</html>