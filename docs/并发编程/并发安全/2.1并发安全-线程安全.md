---
id: çº¿ç¨‹å®‰å…¨
title: çº¿ç¨‹å®‰å…¨
---
## æ¦‚è¿°

- å¯¹è±¡çš„çŠ¶æ€:<font color='red'>å­˜å‚¨åœ¨çŠ¶æ€å˜é‡(ä¾‹å¦‚å®ä¾‹å˜é‡ã€é™æ€åŸŸ)ä¸­çš„æ•°æ®</font>ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬`å…¶ä»–ä¾èµ–å¯¹è±¡çš„åŸŸ`
  - <font color='red'>æ— çŠ¶æ€å˜é‡çš„å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„!</font> 
- æƒ³ç¼–å†™çº¿ç¨‹å®‰å…¨çš„ä»£ç ï¼Œæ ¸å¿ƒåœ¨äº`å¯¹çŠ¶æ€è®¿é—®æ“ä½œè¿›è¡Œç®¡ç†`ï¼Œç‰¹åˆ«æ˜¯`å…±äº«çš„ã€å¯å˜çš„ çŠ¶æ€çš„è®¿é—®`
  - `å…±äº«`: è¡¨ç¤ºçŠ¶æ€å˜é‡å¯ä»¥ç”±å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®
  - `å¯å˜`: è¡¨ç¤ºçŠ¶æ€å˜é‡çš„å€¼åœ¨ç”Ÿå‘½å‘¨æœŸå†…å¯ä»¥å‘ç”Ÿå˜åŒ–
- ä¸€ä¸ªå¯¹è±¡æ˜¯å¦éœ€è¦æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå–å†³äºå®ƒæ˜¯å¦è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®
  - å¦‚æœéœ€è¦è®©å¯¹è±¡æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œ<font color='red'>éœ€è¦é‡‡ç”¨åŒæ­¥æœºåˆ¶æ¥ååŒå¯¹å¯¹è±¡å¯å˜çŠ¶æ€çš„è®¿é—®</font>
- <font color='red'>å½“å¤šä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªçŠ¶æ€å˜é‡ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹æ‰§è¡Œå†™å…¥æ“ä½œæ—¶ï¼Œå¿…é¡»é‡‡ç”¨åŒæ­¥æœºåˆ¶æ¥ååŒè¿™äº›çº¿ç¨‹å¯¹çŠ¶æ€å˜é‡çš„è®¿é—®</font>

  - `synchronized` -> ç‹¬å çš„åŠ é”æ–¹å¼
  - åŒæ­¥çš„æœ¯è¯­è¿˜åŒ…å«: `æ˜¾å¼é”Lockã€volatileå˜é‡ã€åŸå­å˜é‡`
- å¦‚æœå¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå¯å˜çš„çŠ¶æ€å˜é‡æ—¶ï¼Œæ²¡æœ‰ä½¿ç”¨åˆé€‚çš„åŒæ­¥ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°é”™è¯¯ã€‚æœ‰ä¸‰ç§æ–¹å¼å¯ä»¥ä¿®å¤è¿™ä¸ªé—®é¢˜
  1. <mark>ä¸åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«è¯¥çŠ¶æ€å˜é‡</mark> 
  2. <mark>å°†çŠ¶æ€å˜é‡ä¿®æ”¹ä¸ºä¸å¯å˜çš„å˜é‡(final)</mark>
  3. <mark>åœ¨è®¿é—®çŠ¶æ€å˜é‡æ—¶é‡‡ç”¨åŒæ­¥æœºåˆ¶</mark> 
- éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„å¸¸è§æƒ…å†µ?
  - <font color='red'>è®¿é—®<strong>å…±äº«</strong>çš„å˜é‡æˆ–è€…èµ„æºï¼Œä¼šæœ‰å¹¶å‘é£é™©ã€‚</font>

    - æ¯”å¦‚å¯¹è±¡çš„å±æ€§ã€é™æ€å˜é‡ã€å…±äº«ç¼“å­˜ã€æ•°æ®åº“ç­‰
  
  - <font color='red'>æ‰€æœ‰ä¾èµ–æ—¶åºçš„æ“ä½œï¼Œå³ä½¿æ¯ä¸€æ­¥æ“ä½œéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¿˜æ˜¯å­˜åœ¨å¹¶å‘é—®é¢˜</font>
  
  - <font color='red'>ä¸åŒæ•°æ®ä¹‹é—´å­˜åœ¨æ†ç»‘å…³ç³»çš„æ—¶å€™</font>
  
  - <font color='red'>ä½¿ç”¨å…¶ä»–ç±»æ—¶ï¼Œéœ€è¦è€ƒè™‘å…¶ä»–ç±»æ˜¯å¦æ˜¯çº¿ç¨‹å®‰å…¨çš„</font>

:::danger çº¿ç¨‹å®‰å…¨?

1. <font color='red'>å½“å¤šä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªå¯¹è±¡æ—¶,ä¸ç®¡è¿™äº›çº¿ç¨‹åœ¨è¿è¡Œç¯å¢ƒä¸‹é‡‡ç”¨å“ªç§è°ƒåº¦æ–¹å¼ï¼Œæˆ–è€…è¿™äº›çº¿ç¨‹å¦‚ä½•äº¤æ›¿è¿è¡Œï¼Œå¹¶ä¸”ä¹Ÿä¸ç”¨åœ¨ä¸»è°ƒç”¨ä»£ç ä¸­è¿›è¡Œé¢å¤–çš„åŒæ­¥ã€ååŒï¼Œè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„è¡Œä¸ºæ–¹æ³•éƒ½èƒ½è·å–åˆ°<code>æ­£ç¡®çš„ç»“æœ</code>ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„</font>

   - `æ•°æ®äº‰ç”¨`: æ•°æ®è¯»å†™ç”±äºåŒæ—¶å†™ï¼Œä¼šé€ æˆé”™è¯¯

   - `ç«äº‰æ¡ä»¶`: å³ä½¿ä¸æ˜¯åŒæ—¶å†™æ“ä½œé”™è¯¯æ•°æ®ï¼Œç”±äºé¡ºåºé—®é¢˜ä¾ç„¶ä¼šé€ æˆé”™è¯¯ï¼Œæ¯”å¦‚åœ¨å†™å…¥å‰å°±è¯»å–ï¼Œå¯¼è‡´è¯»å–çš„æ•°æ®ä¸æ˜¯æœ€æ–°çš„

2. å“ªäº›æƒ…å†µä¸‹å›å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜?
   - `è¿è¡Œç»“æœé”™è¯¯`: è‡ªå¢åœ¨å¤šçº¿ç¨‹ä¸‹å‡ºç°é”™è¯¯ç»“æœ
   - `æ´»è·ƒæ€§é—®é¢˜`: æ­»é”ã€æ´»é”ã€é¥¥é¥¿
   - å¯¹è±¡ `å‘å¸ƒ` å’Œ `åˆå§‹åŒ–` çš„æ—¶å€™çš„å®‰å…¨é—®é¢˜

:::

### a++è‡ªå¢é—®é¢˜ï¼ˆç«æ€æ¡ä»¶ï¼‰

a++è‡ªå¢å®è´¨ä¸Šåˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤: <font color='red'>è¯»å–açš„å€¼->å°†å€¼åŠ 1->å°†è®¡ç®—ç»“æœå†™å…¥a</font> , å³`è¯»å–->ä¿®æ”¹->å†™å…¥`

![a++è‡ªå¢é—®é¢˜](./../image/2.å¹¶å‘ç¼–ç¨‹åŸºç¡€/image-20210823212814991.png)

#### ä»£ç æ¼”ç¤º(é”™è¯¯æ•°æ®å®šä½)

```java
/**
 * <b>a++ è®¡æ•°ä¸å‡†ç¡®</b>
 *
 * @author <a href="mailto:zhuyuliangm@gmail.com">zyl</a>
 */
public class ResultError implements Runnable {
    static ResultError instance = new ResultError();
    private static  int index=0;
    // ç»Ÿè®¡æ­£ç¡®çš„å¾ªç¯æ¬¡æ•°
    private static AtomicInteger realCount = new AtomicInteger();
    // ç»Ÿè®¡é”™è¯¯çš„å¾ªç¯æ¬¡æ•°
    private static AtomicInteger errorCount = new AtomicInteger();
    // å®šä¹‰é”™è¯¯çš„æ ‡è®°ä½æ•°ç»„
    private static final boolean[] mark = new boolean[Integer.MAX_VALUE/2];

    static volatile CyclicBarrier cyclicBarrier1 = new CyclicBarrier(2);

    @Override
    public void run() {
        /*   è¿™ç§æ˜¯é”™è¯¯çš„,å› ä¸ºçŠ¶æ€å˜é‡indexå­˜åœ¨a++çš„é—®é¢˜
            while(index<10000) {
                realCount.incrementAndGet();
                index++;
            }
        */
        // 0ç´¢å¼•æ˜¯true
        mark[0] = true;
        // iä¸æ˜¯çŠ¶æ€å˜é‡,æ‰€ä»¥ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜
        for (int i = 0; i < 100_0000; i++) {
            realCount.incrementAndGet();
            // å¦‚æœå±éšœç ´è£‚,é‡ç½®
            if (cyclicBarrier1.isBroken()) {
                cyclicBarrier1.reset();
            }
            try {
                /**
                 * ä½¿ç”¨ å¾ªç¯æ …æ ,ä¿è¯åªæœ‰å½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶åˆ°è¾¾ä¹‹å,æ‰ä¼šè¿›è¡Œ ++è‡ªå¢æ“ä½œ
                 * å¦‚æœä¸ç”¨å¾ªç¯æ …æ :
                 *  å¯èƒ½çº¿ç¨‹Aç»å¸¸èƒ½æŠ¢å åˆ°CPUæ‰§è¡Œæƒ,è€Œçº¿ç¨‹Bä¿®æ”¹indexåæ²¡æœ‰æäº¤;
                 *  å½“çº¿ç¨‹Aæ‰§è¡Œä¸€æ®µæ—¶é—´å°†markä¸€éƒ¨åˆ†æ•°æ®è®¾ç½®ä¸ºtrue,çº¿ç¨‹Bè·å–åˆ°äº†CPUæ‰§è¡Œæƒ,æäº¤æ•°æ®,å¯¼è‡´indexä¸æ­£å¸¸
                 */
                cyclicBarrier1.await();
                index++; // ç”±äº ++è‡ªå¢æ“ä½œä¸æ˜¯åŸå­æ€§æ“ä½œ, è¯»å–çŠ¶æ€å˜é‡ -> ä¿®æ”¹åŸå­çŠ¶æ€å˜é‡çš„å€¼->æ›´æ–°åŸå­å˜é‡çš„å€¼
            } catch (Exception e) {
                e.printStackTrace();
            }
            /**
             * å½“ index++ å¤šçº¿ç¨‹è®¡ç®—ç»“æœå†²çª:
             * markä¹Ÿæ˜¯çŠ¶æ€å˜é‡,è¿™é‡Œä½¿ç”¨ synchronized,ä¿è¯æ“ä½œå¯è§æ€§ -> åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿›å…¥åˆ°åˆ¤æ–­æ ‡è®°ä½ä»¥åŠä¿®æ”¹æ ‡è®°ä½çš„å¤„ç†
             * å¦‚æœä¸ç”¨ä½¿ç”¨synchronized :
             *  çº¿ç¨‹A(index=1) è¿˜æ²¡æœ‰è®¾ç½® mark[index] = true , çº¿ç¨‹B(index=1)è¿è¡Œåˆ° mark[index] åˆ¤æ–­å¤„,ç”±äºæ­¤æ—¶ mark[index]=false,
             *  æ‰€ä»¥ä¸ä¼šå°†è¯¥index++çš„è¿è¡Œå†²çªè®°å½•ä¸‹æ¥,ç„¶åå’Œçº¿ç¨‹Aä¸€æ ·,èµ°äº†mark[index] = trueçš„å¤„ç†.æ‰€ä»¥ä¼šå¯¼è‡´é”™è¯¯æ¬¡æ•°ä¸å‡†ç¡®(å°‘)
             */
            synchronized (instance) {
                // å¦‚æœ å¤šçº¿ç¨‹è®¡ç®—ç»“æœä¸å†²çªï¼Œé‚£ä¹ˆæ¯æ¬¡ä¸¤ä¸ªçº¿ç¨‹æ¯æ¬¡å¾ªç¯ä¹‹åï¼Œindexæ€»æ˜¯å¶æ•°ï¼Œmarkæ€»æ˜¯å¶æ•°ä½æ˜¯true
              	// å¦‚æœå¤šçº¿ç¨‹è®¡ç®—ç»“æœå†²çªï¼Œé‚£ä¹ˆæ¯æ¬¡ä¸¤ä¸ªçº¿ç¨‹æ¯æ¬¡å¾ªç¯ä¹‹åï¼Œindexå¯èƒ½æ˜¯å¥‡æ•°ï¼Œä¹Ÿä¼šæ˜¯å¶æ•°
                if(mark[index] && mark[index-1]) {
                    System.out.println("å‘ç”Ÿé”™è¯¯:" + index);
                    errorCount.incrementAndGet();
                }
                mark[index] = true;
            }
        }
    }
    public static void main(String[] args) throws InterruptedException {
        Thread thread1 = new Thread(instance, "Thread1");
        Thread thread2 = new Thread(instance, "Thread2");
        thread1.start();
        thread2.start();
        thread1.join();
        thread2.join();
        System.out.println("è¡¨é¢çš„æµ‹è¯•ç»“æœ:" + instance.index);
        System.out.println("å®é™…çš„æ­£ç¡®æ¬¡æ•°:" + realCount.get());
        System.out.println("é”™è¯¯æ¬¡æ•°:" + errorCount.get());
    }
}

/*
	å‘ç”Ÿé”™è¯¯:698781
    è¡¨é¢çš„æµ‹è¯•ç»“æœ:1999999
    å®é™…çš„æ­£ç¡®æ¬¡æ•°:2000000
    é”™è¯¯æ¬¡æ•°:1
*/
```



### æ­»é”

#### ä»£ç æ¼”ç¤º

```java
public class DeadLockDemo {
    private static final Object lock1 = new Object();
    private static final Object lock2 = new Object();
    public static void main(String[] args) {
        Thread thread1 = new Thread(() -> {
            synchronized (lock1) {
                try {
                    System.out.println(ThreadUtil.getThreadInfo() + "è·å–åˆ°äº†lock1" + LocalDateTime.now().getNano());
                    TimeUnit.SECONDS.sleep(3);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                synchronized(lock2) {
                    System.out.println(ThreadUtil.getThreadInfo() + "è·å–åˆ°äº†lock2"+ LocalDateTime.now().getNano());
                }
            }
        });

        Thread thread2 = new Thread(() -> {
            synchronized (lock2) {
                try {
                    System.out.println(ThreadUtil.getThreadInfo() + "è·å–åˆ°äº†lock2"+ LocalDateTime.now().getNano());
                    TimeUnit.SECONDS.sleep(3);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                synchronized(lock1) {
                    System.out.println(ThreadUtil.getThreadInfo() + "è·å–åˆ°äº†lock1"+ LocalDateTime.now().getNano());
                }
            }
        });
        thread1.start();
        thread2.start();
    }
}
```



### å‘å¸ƒä¸é€¸å‡º

#### æ¦‚è¿°

1. <mark>ä»€ä¹ˆæ˜¯å‘å¸ƒ(publish)?</mark>

   - `è®©å¯¹è±¡èƒ½å¤Ÿåœ¨å½“å‰ä½œç”¨åŸŸèŒƒå›´ä¹‹å¤–çš„ä»£ç ä¸­ä½¿ç”¨`

     - <font color='red'>å°†ä¸€ä¸ªæŒ‡å‘è¯¥å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åˆ°å…¶ä»–ä»£ç å¯ä»¥è®¿é—®çš„åœ°æ–¹</font>
     - <font color='red'>åœ¨éç§æœ‰æ–¹æ³•ä¸­è¿”å›è¯¥å¯¹è±¡çš„å¼•ç”¨</font>
     - <font color='red'>å°†è¯¥å¯¹è±¡çš„å¼•ç”¨ä¼ å…¥å…¶ä»–ç±»çš„æ–¹æ³•ä¸­</font> 
   - åœ¨å‘å¸ƒå¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ï¼Œé‚£ä¹ˆå°±å¯èƒ½éœ€è¦åŒæ­¥ã€‚å‘å¸ƒå†…éƒ¨çŠ¶æ€ï¼Œå¯èƒ½ä¼šç ´åå°è£…æ€§ã€‚

:::tip <font color='green'>å‘å¸ƒå¯¹è±¡æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯å°†å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åˆ°ä¸€ä¸ªå…¬å…±çš„é™æ€å˜é‡ä¸­,ä»¥ä¾¿ä»»ä½•ç±»å’Œçº¿ç¨‹éƒ½èƒ½çœ‹è§è¯¥å¯¹è±¡</font> 

```java
/*
	åœ¨ initæ–¹æ³•ä¸­åˆ›å»ºä¸€ä¸ª HashSetå¯¹è±¡ï¼Œå¹¶ä¸”å°†è¯¥å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åˆ° knowSecrets ä¸Šæ¥å‘å¸ƒå¯¹è±¡
*/
public static Set<Secret> knowSecrets;
public void init() {
  Set<Secret> knowSecrets = new HashSet<Secret>();
}
```
:::

2. <mark>ä»€ä¹ˆæ˜¯é€¸å‡º(Escape)?</mark>

   - é”™è¯¯å‘å¸ƒçš„æƒ…å†µ,`å½“æŸä¸ªä¸åº”è¯¥è¢«å‘å¸ƒçš„å¯¹è±¡è¢«å‘å¸ƒæ—¶ï¼Œå°±è¢«ç§°ä¸ºé€¸å‡º`

      - <font color='red'>æ–¹æ³•è¿”å›ä¸€ä¸ªprivate å¯¹è±¡</font> 
      - <font color='red'>è¿˜æ²¡æœ‰åˆå§‹åŒ–å®Œæˆ(æ„é€ å‡½æ•°æ²¡æœ‰æ‰§è¡Œå®Œæˆ)ï¼Œå°±æŠŠå¯¹è±¡æä¾›ç»™å¤–ç•Œ</font>

      - `æ„é€ å‡½æ•°ä¸­æœªåˆå§‹åŒ–å®Œæˆå°±å‘å¸ƒthiså¼•ç”¨`
      - `éšå¼é€¸å‡ºï¼Œæ¯”å¦‚æ³¨å†Œç›‘å¬äº‹ä»¶`
      - `æ„é€ å‡½æ•°ä¸­è¿è¡Œçº¿ç¨‹`

   - è§£å†³é€¸å‡ºçš„å¸¸è§æ–¹å¼
     - `è¿”å› "å‰¯æœ¬"`
     - `å·¥å‚æ–¹æ³•`

#### å‡ ç§å¸¸è§çš„é€¸å‡º

##### 1.æ–¹æ³•è¿”å›privateå¯¹è±¡ âŒ

-  <font color='red'>ä¸€ä¸ªå…¬å…±æ–¹æ³•è¿”å›ä¸€ä¸ªå¼•ç”¨ï¼Œé‚£ä¹ˆä¼šå°†è¯¥å¯¹è±¡çš„å¼•ç”¨å‘å¸ƒã€‚</font>
-  <font color='red'>å½“å‘å¸ƒä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œè¯¥å¯¹è±¡å†…éƒ¨çš„ éprivateå¯¹è±¡ ä¹Ÿä¼šè¢«å‘å¸ƒ</font>
-  <font color='red'>å¦‚æœå·²ç»å‘å¸ƒçš„å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡ éprivateçš„å˜é‡æˆ–è€…æ–¹æ³•ï¼Œè®¿é—®åˆ°å…¶ä»–å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™äº›å¯¹è±¡ä¹Ÿä¼šè¢«å‘å¸ƒ</font>

:::danger <font color='red'>å…¬å…±æ–¹æ³•å‘å¸ƒäº†å†…éƒ¨çš„ç§æœ‰å˜é‡ï¼Œä½¿å†…éƒ¨å¯å˜çŠ¶æ€é€¸å‡º</font> ğŸ™…â€â™‚ï¸(ä¸è¦è¿™ä¹ˆåš)

ä»¥ä¸‹çš„ä»£ç ä¸­ï¼Œé€šè¿‡å…¬å…±æ–¹æ³•å‘å¸ƒäº†å†…éƒ¨çš„ç§æœ‰å˜é‡statesï¼Œè¿™æ ·ä»»ä½•è°ƒç”¨è€…éƒ½å¯ä»¥é€šè¿‡å…¬å…±æ–¹æ³•ç¯¡æ”¹è¿™ä¸ªç§æœ‰å˜é‡ã€‚æ¯”å¦‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå…¶ä»–çº¿ç¨‹é€šè¿‡å…¬å…±æ–¹æ³•ä¿®æ”¹äº†å†…éƒ¨çš„ç§æœ‰å˜é‡ï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹è¯»å–åˆ°äº†é”™è¯¯çš„æ•°æ®

```java
class UnSafeStates {
    private String[] states = new String[] {
            "A","B"
    };
    public String[] getStates() {
        return states;
    }
    public void print() {
        System.out.println(Arrays.toString(states));
    }
}
public class Demo3 {
    public static void main(String[] args) {
        UnSafeStates d = new UnSafeStates();
        String[] res = d.getStates();
        res[0] = "remove";
        d.print();			// [remove, B]
    }
}
```

:::

##### 2.æœªåˆå§‹åŒ–å®Œæˆ(æ˜¾å¼é€¸å‡º) âŒ

åœ¨æ„é€ å‡½æ•°è¿˜æ²¡æœ‰æ„é€ å®Œæˆæ—¶ï¼Œå°±å°†thiså¼•ç”¨å‘å¸ƒäº†

```java
/**
 * <b>this å¼•ç”¨é€¸å‡º - æ„é€ å‡½æ•°æœªåˆå§‹åŒ–å®Œæˆå°±æ˜¯ä¼ é€’thiså¼•ç”¨</b>
 * @author <a href="mailto:zhuyuliangm@gmail.com">zyl</a>
 */
public class ThisEscapeDemo {
    static Person person;

    public static void main(String[] args) throws InterruptedException {
        // è¿™é‡Œä½¿ç”¨çº¿ç¨‹åˆ›å»ºå¯¹è±¡
        new Thread(() -> {
            try {
                person = new Person("lili", 22);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
        TimeUnit.MILLISECONDS.sleep(10);
        System.out.println(person.toString());
        // ç­‰å¾… 2s å†æ¬¡è¾“å‡º
        TimeUnit.SECONDS.sleep(2);
        System.out.println(person.toString());
    }
}
class Person {
    private String name;
    private int age;

    public Person(String name, int age) throws InterruptedException {
        this.name = name;
        // è¿™é‡Œå­˜åœ¨é—®é¢˜: æ­¤æ—¶ Personæ„é€ å‡½æ•°å°šæœªåˆå§‹åŒ–å®Œæˆ,å°±å°†thiså¼•ç”¨ä¼ é€’å‡ºå»(å‘å¸ƒ)
        ThisEscapeDemo.person = this;
        TimeUnit.SECONDS.sleep(1);
        this.age = age;
    }

    @Override
    public String toString() {
        return "Person{" +
                "name='" + name + '\'' +
                ", age=" + age +
                '}';
    }
}


```

![æœªåˆå§‹åŒ–å®Œæˆ(æ˜¾å¼é€¸å‡º)](./../image/2.å¹¶å‘ç¼–ç¨‹åŸºç¡€/image-20210828125545826-0126551.png)



##### 3.thiséšå¼é€¸å‡º âŒ

:::caution

- å†…éƒ¨ç±»ã€åŒ¿åå†…éƒ¨ç±»å¯ä»¥è®¿é—®å¤–éƒ¨ç±»çš„å¯¹è±¡çš„åŸŸï¼Œæ˜¯å› ä¸ºå†…éƒ¨ç±»æ„é€ çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨ä¼šæŠŠå¤–éƒ¨ç±»çš„å¯¹è±¡thiséšå¼åœ°ä½œä¸ºä¸€ä¸ªå‚æ•°ä¼ é€’ç»™å†…éƒ¨ç±»çš„æ„é€ æ–¹æ³•ã€‚

- ä¸‹é¢çš„ç¤ºä¾‹ä¸­çš„é—®é¢˜
  - æ„é€ å‡½æ•°ä¸­é¦–å…ˆæ³¨å†Œäº†ä¸€ä¸ªç›‘å¬å™¨(æ“ä½œäº†éšå«çš„thisçŠ¶æ€å˜é‡)ã€‚ç„¶åå¯¹ThisEscapeDemo2 è¿›è¡Œæ„é€ åˆå§‹åŒ–ã€‚
  - åœ¨åˆ›å»ºå¯¹è±¡æ—¶ï¼Œç”±äºæ„é€ éœ€è¦ä¸€æ®µæ—¶é—´ï¼Œæ‰€ä»¥`ThisEscapeDemo2` è¿˜æ²¡æœ‰æ„é€ å®Œæˆï¼Œæ­¤æ—¶å‘é€ä¸€ä¸ªäº‹ä»¶è§¦å‘äº†ç›‘å¬å™¨ä¸­çš„onEventæ–¹æ³•
    - å¯¼è‡´äº†: `ThisEscapeDemo2` æ²¡æœ‰æ„é€ å®Œæˆï¼Œä½†æ˜¯å´é€šè¿‡onEvent() æ“ä½œäº†thisçš„å¼•ç”¨ -> `thiséšå¼é€¸å‡º`

:::

```java

/**
 * <b>thiséšå¼é€¸å‡º - æ³¨å†Œä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨</b>
 * @author <a href="mailto:zhuyuliangm@gmail.com">zyl</a>
 */
public class ThisEscapeDemo2 {
    private static String[] states = null;
    public ThisEscapeDemo2(EventSource source) throws InterruptedException {
        // æ³¨å†Œç›‘å¬å™¨
        source.registerListener(new EventListener() {
            /**
             * è¿™é‡Œå‘å¸ƒäº†åŒ¿åå†…éƒ¨ç±» EventListener
             * åŒ¿åå†…éƒ¨ç±»å¯ä»¥è®¿é—®å¤–çš„å¯¹è±¡çš„åŸŸ,å› ä¸ºthisçš„å¼•ç”¨åœ¨å†…éƒ¨ç±»æ„é€ æ—¶è¢«ä¼ è¿›æ¥äº†
             */
            @Override
            public void onEvent(Event event) {
                // å†…éƒ¨ç±»ä¸­é€šè¿‡å¤–éƒ¨æ¥ä¼ é€’çš„éšå¼thisè®¿é—®å¤–éƒ¨ç±»çš„å¯å˜çŠ¶æ€å˜é‡
                System.out.println("\nå†…éƒ¨ç±»çœ‹åˆ°äº†states:"+ Arrays.toString(states));
            }
        });
        for (int i = 0; i < 100; i++) {
            System.out.print(i+",");
            Thread.sleep(1000);
        }
        states = new String[] {"person1", "person2", "person3"};
    }

    public static void main(String[] args) throws InterruptedException {
        EventSource source = new EventSource();
        new Thread(() -> {
            try {
                Thread.sleep(1);
                // å‘å¸ƒä¸€ä¸ªäº‹ä»¶: ä¸»çº¿ç¨‹è¿˜æ²¡æœ‰å°† ThisEscapeDemo2 åˆå§‹åŒ–å®Œæˆï¼Œå…¶ä»–çº¿ç¨‹å°±å¯ä»¥äº‹ä»¶ç›‘å¬å™¨æ“ä½œ states
                source.publishEvent(new Event() {});
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
        new ThisEscapeDemo2(source);
    }

    static class EventSource {
        private EventListener listener;
        void registerListener(EventListener listener) {
            this.listener = listener;
        }
        void publishEvent(Event e) {
            if (listener != null) {
                listener.onEvent(e);
            } else {
                System.out.println("è¿˜æœªåˆå§‹åŒ–å®Œæ¯•");
            }
        }
    }
    interface Event {}
    interface  EventListener {
        void onEvent(Event event);
    }
}

```



![thiséšå¼é€¸å‡º](./../image/2.å¹¶å‘ç¼–ç¨‹åŸºç¡€/image-20210828144043239-0132844.png)

##### 4.æ„é€ å‡½æ•°ä¸­è¿è¡Œçº¿ç¨‹ âŒ

- å¹¿ä¹‰æ¥è¯´ï¼Œå’Œthiséšå¼å¼•ç”¨é€¸å‡ºä¸€æ ·ï¼Œåœ¨çº¿ç¨‹æ–¹æ³•å†…éƒ¨æŒæœ‰thiså¼•ç”¨ï¼Œå¯ä»¥å¯¹çŠ¶æ€å˜é‡è¿›è¡Œæ“ä½œã€‚å¹¶ä¸”ç”±äºå¤šçº¿ç¨‹æ²¡æœ‰å°†statesåˆå§‹åŒ–å®Œæ¯•ï¼Œæ­¤æ—¶æ“ä½œæ•°æ®ä¼šå‡ºç°ç©ºæŒ‡é’ˆå¼‚å¸¸

```java
public class ThisEscapeDemo3 {
    private static Map<Integer,String> states = new HashMap<>();
    public ThisEscapeDemo3() {
        new Thread(() -> {
            try {
                TimeUnit.SECONDS.sleep(1);
                states.put(1, "names1");
                states.put(2, "names2");
                states.put(3, "names3");
                states.put(4, "names4");
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
    }

    public static void main(String[] args) throws InterruptedException {
        ThisEscapeDemo3 demo3 = new ThisEscapeDemo3();
        System.out.println(states);
        TimeUnit.SECONDS.sleep(2);
        System.out.println(states);
    }
}

```

![æ„é€ å‡½æ•°ä¸­è¿è¡Œçº¿ç¨‹](./../image/2.å¹¶å‘ç¼–ç¨‹åŸºç¡€/image-20210828144607391.png)


#### å®‰å…¨çš„æ„é€ å¯¹è±¡

##### å·¥å‚æ–¹æ³•é˜²æ­¢thiséšå¼é€¸å‡º

:::tip

- ä¸‹é¢ç¤ºä¾‹ä¸­:
  - æ„é€ å‡½æ•°åˆå§‹åŒ–äº†ä¸€ä¸ªç›‘å¬å™¨è¿˜æœ‰ä¸€äº›çŠ¶æ€å˜é‡ï¼Œå¹¶ä¸”ç§æœ‰åŒ–
  - å®šä¹‰å…¬å…±æ–¹æ³•`getInstance()` -> åˆ›å»º`ThisEscapeDemo4` å®ä¾‹ï¼Œç„¶åå†æ³¨å†Œç›‘å¬å™¨(<font color='red'>å‘å¸ƒäº†ç›‘å¬å™¨</font>)ï¼Œæœ€åè¿”å›`ThisEscapeDemo4` å®ä¾‹
    - è¿™æ ·æ“ä½œ: åœ¨æ³¨å†Œç›‘å¬å™¨çš„æ—¶å€™ï¼Œå·²ç»å®Œæˆäº† `ThisEscapeDemo4` çš„æ„é€ ï¼Œæ‰€ä»¥åªæœ‰å‘å¸ƒäº‹ä»¶è§¦å‘ç›‘å¬å™¨æ—¶ï¼Œä¸å­˜åœ¨thisé€¸å‡ºçš„é—®é¢˜

:::

```java
public class ThisEscapeDemo4 {
    private static String[] states = null;
    private final EventListener listener;
    private ThisEscapeDemo4() throws InterruptedException {
        listener = new EventListener() {
            /**
             * è¿™é‡Œå‘å¸ƒäº†åŒ¿åå†…éƒ¨ç±» EventListener
             * åŒ¿åå†…éƒ¨ç±»å¯ä»¥è®¿é—®å¤–çš„å¯¹è±¡çš„åŸŸ,å› ä¸ºthisçš„å¼•ç”¨åœ¨å†…éƒ¨ç±»æ„é€ æ—¶è¢«ä¼ è¿›æ¥äº†
             */
            @Override
            public void onEvent(Event event) {
                // å†…éƒ¨ç±»ä¸­é€šè¿‡å¤–éƒ¨æ¥ä¼ é€’çš„éšå¼thisè®¿é—®å¤–éƒ¨ç±»çš„å¯å˜çŠ¶æ€å˜é‡
                System.out.println("\nå†…éƒ¨ç±»çœ‹åˆ°äº†states:"+ Arrays.toString(states));
            }
        };
        for (int i = 0; i < 100; i++) {
            System.out.print(i + ",");
            Thread.sleep(1000);
        }
        states = new String[] {"person1", "person2", "person3"};
    }
    public static ThisEscapeDemo4 getInstance(EventSource source) throws InterruptedException {
        ThisEscapeDemo4 demo4 = new ThisEscapeDemo4();
        source.registerListener(demo4.listener);
        return demo4;
    }

    public static void main(String[] args) throws InterruptedException {
        EventSource source = new EventSource();
        new Thread(() -> {
            try {
                Thread.sleep(1);
                // å‘å¸ƒä¸€ä¸ªäº‹ä»¶
                source.publishEvent(new Event() {});
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
        ThisEscapeDemo4.getInstance(source);
    }

    static class EventSource {
        private EventListener listener;
        void registerListener(EventListener listener) {
            this.listener = listener;
        }
        void publishEvent(Event e) {
            if (listener != null) {
                listener.onEvent(e);
            } else {
                System.out.println("è¿˜æœªåˆå§‹åŒ–å®Œæ¯•");
            }
        }
    }
    interface Event {}
    interface  EventListener {
        void onEvent(Event event);
    }
}
```

![](./../image/2.å¹¶å‘ç¼–ç¨‹åŸºç¡€/image-20210828155748074.png)

##### å·¥å‚æ–¹æ³•é˜²æ­¢å†…éƒ¨çº¿ç¨‹

```java
public class ThisEscapeDemo31 {
    private static Thread thread;
    private static Map<Integer,String> states = new HashMap<>();
    private ThisEscapeDemo31() {
        thread = new Thread(() -> {
            try {
                TimeUnit.SECONDS.sleep(1);
                states.put(1, "names1");
                states.put(2, "names2");
                states.put(3, "names3");
                states.put(4, "names4");
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
    }

    public static ThisEscapeDemo31 getInstance() {
        ThisEscapeDemo31 thisEscapeDemo31 = new ThisEscapeDemo31();
        thread.start();
        return thisEscapeDemo31;
    }

    public static void main(String[] args) throws InterruptedException {
        ThisEscapeDemo31 demo3 = ThisEscapeDemo31.getInstance();
        TimeUnit.SECONDS.sleep(1);
        System.out.println(states);	// {1=names1, 2=names2, 3=names3, 4=names4}
    }
}
```