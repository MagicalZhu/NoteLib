---
id: Bean
title: Bean
---

## 1. Spring Bean

### 1.1 BeanDefinition

- <font color='red'><code>BeanDefinition</code>Â æ˜¯Springä¸­å®šä¹‰Beançš„é…ç½®å…ƒä¿¡æ¯æ¥å£,ç”¨äºå­˜å‚¨Beançš„å®šä¹‰ä¿¡æ¯ï¼ŒåŒ…å«</font> 

  1. Bean çš„ç±»å
  2. Bean çš„è¡Œä¸ºå…ƒç´ ï¼Œæ¯”å¦‚ä½œç”¨åŸŸã€è‡ªåŠ¨ç»‘å®šçš„æ¨¡å¼ã€ç”Ÿå‘½å‘¨æœŸå›è°ƒ
  3. å…¶ä»–Beançš„å¼•ç”¨ï¼Œä¹Ÿå«åšä¾èµ–ï¼ˆDependenciesï¼‰
  4. é…ç½®è®¾ç½®ï¼Œæ¯”å¦‚Beançš„å±æ€§(Properties)

#### 1.1.2 BeanDefinition å…ƒä¿¡æ¯

| å±æ€§                     | è¯´æ˜                                           |
| ------------------------ | ---------------------------------------------- |
| Class                    | Beanå…¨ç±»åï¼Œå¿…é¡»æ˜¯å…·ä½“ç±»ï¼Œä¸èƒ½æ˜¯æŠ½è±¡ç±»æˆ–è€…æ¥å£ |
| Name                     | Beançš„åç§°/ID                                  |
| Scope                    | Beançš„ä½œç”¨åŸŸ(singletonã€propertype)            |
| Constructor arguments    | Bean æ„é€ å™¨å‚æ•°ï¼ˆç”¨äºä¾èµ–æ³¨å…¥ï¼‰                |
| Properties               | Bean å±æ€§è®¾ç½® ï¼ˆç”¨äºä¾èµ–æ³¨å…¥ï¼‰                 |
| Autowiring mode          | Bean è‡ªåŠ¨ç»‘å®šæ¨¡å¼ï¼ˆæ¯”å¦‚ï¼š é€šè¿‡åç§° byNameï¼‰    |
| Lazy initialazation mode | Bean å»¶è¿Ÿåˆå§‹åŒ–æ¨¡å¼ ï¼ˆå»¶è¿Ÿå’Œéå»¶è¿Ÿï¼‰           |
| Initialization method    | Bean åˆå§‹åŒ–å›è°ƒæ–¹æ³•åç§°                        |
| Destruction method       | Bean é”€æ¯å›è°ƒæ–¹æ³•åç§°                          |



### 1.2 å¦‚ä½•æ„å»ºBeanDefinitionï¼Ÿ

* **åŒ…å«ä»¥ä¸‹çš„å‡ ç§æ–¹å¼æ„å»ºBeanDefinition**
  1. é€šè¿‡ <font color='#f535e8'>`BeanDefinitionBuilder`</font> 
  2. é€šè¿‡ <font color='#f535e8'>`AbstractBeanDefinition` ä»¥åŠæ´¾ç”Ÿç±»</font> 

:::danger æ³¨æ„
 BeanDefinition å¹¶éBeançš„æœ€ç»ˆæ€,è¿˜å¯ä»¥å¯¹Beanè¿›è¡Œé¢å¤–çš„è®¾ç½®

 æ¯”å¦‚: è®¾ç½®Beançš„åˆå§‹åŒ–æ–¹æ³•ã€é”€æ¯æ–¹æ³•ç­‰ç­‰
:::

<br/>

**æ–¹å¼ä¸€ï¼š é€šè¿‡BeanDefinitionBuilder**

:::caution GenericBeanDefinition å’Œ RootBeanDefinitionçš„åŒºåˆ«ï¼Ÿ
- GenericBeanDefinition å¯ä»¥è®¾ç½®parentå±æ€§
- RootBeanDefinition æ˜¯æ ¹éƒ¨ã€é¡¶å±‚çš„Beanå®šä¹‰ä¿¡æ¯ï¼Œæ— æ³•è®¾ç½®parentå±æ€§	
:::

```java
public void BeanDefinitionBuilderDemo(){
  // 1.é€šè¿‡ BeanDefinitionBuilder -> GenericBeanDefinition å¯ä»¥è®¾ç½®parent,è€Œ RootBeanDefinition æ²¡æœ‰parent,å·²ç»æ˜¯é¡¶å±‚çš„bean
  BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(Person.class);
  
  // 2.è¿›è¡Œå±æ€§è®¾ç½®
  builder.addPropertyValue("age",22);
  builder.addPropertyValue("name","yoey");
  
  // 3. è·å–BeanDefinition å®ä¾‹
  GenericBeanDefinition beanDefinition = (GenericBeanDefinition)builder.getBeanDefinition();
  
  // 4.BeanDefinition å¹¶éBeançš„æœ€ç»ˆæ€,è¿˜å¯ä»¥å¯¹Beanè¿›è¡Œé¢å¤–çš„è®¾ç½®
  beanDefinition.setInitMethodName("beanPostCon");
}
```



<br/>

**æ–¹å¼äºŒï¼š é€šè¿‡AbstractBeanDefinition ä»¥åŠæ´¾ç”Ÿç±»**

<font color='red'>GenericBeanDefinition å’ŒRootBeanDefinition éƒ½å±äº AbstractBeanDefinitionçš„å­ç±»</font>

```java
public void AbstractBeanDefinitionDemo(){
  // 1.åˆ›å»ºä¸€ä¸ªAbstractBeanDefinitionå®ç°ç±» -> GenericBeanDefinition
  GenericBeanDefinition definition = new GenericBeanDefinition();

  // 2. è®¾ç½®Beançš„ç±»å‹
  definition.setBeanClass(Person.class);

  // 3.è®¾ç½®Beançš„å±æ€§,é€šè¿‡ MutablePropertyValues è¿›è¡Œæ‰¹é‡çš„è®¾ç½®
  MutablePropertyValues propertyValues = new MutablePropertyValues();
  propertyValues.addPropertyValue("age",22);
  propertyValues.addPropertyValue("name","yoey");
  definition.setPropertyValues(propertyValues);

}
```



### 1.3 SpringBean çš„å‘½åï¼Ÿ

:::tip Beançš„åç§°

- <font color='blue'>æ¯ä¸ªBeanæ‹¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ ‡è¯†ç¬¦(identifiers)ï¼Œè¿™äº›æ ‡è¯†ç¬¦åœ¨Beanæ‰€åœ¨çš„å®¹å™¨å¿…é¡»æ˜¯å”¯ä¸€çš„</font>

  - é€šå¸¸ï¼Œä¸€ä¸ªBeanåªæœ‰ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åˆ«å(Alias) æ‹“å±•
- åœ¨åŸºäºXMLçš„é…ç½®å…ƒä¿¡æ¯ä¸­ï¼Œé€šè¿‡ id/name å±æ€§æŒ‡å®š Beançš„æ ‡è¯†ç¬¦ -> å¹¶éä¸€å®šæ˜¯ æœ¬åœ°çš„Springçš„é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ç½‘ç»œèµ„æº
  - å¦‚æœéœ€è¦è®¾ç½®Beançš„åˆ«åï¼Œå¯åœ¨ Beançš„nameå±æ€§åä½¿ç”¨ é€—å· åˆ†éš”
- Beançš„id/name ä¸æ˜¯å¿…é¡»æŒ‡å®šçš„ï¼Œå®¹å™¨é»˜è®¤ä¼šä¸ºBeanç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„åç§°
  - <font color='#f535e8'>é€šè¿‡ <code>BeanNameGenerator</code>Â çš„å®ç°ç±»ï¼Œæ¯”å¦‚æ³¨è§£æ³¨å†Œä½¿ç”¨ <code>AnnotationBeanNameGenerator</code></font> 

:::



#### 1.3.1 Beançš„åˆ«å

- Beanåˆ«åçš„(Alias)çš„ä»·å€¼
  1. å¤ç”¨ç°æœ‰çš„BeanDefinition
      - <font color='red'>å³: ä½¿ç”¨Beançš„åˆ«åæ—¶ï¼Œä¸€å®šè¦å­˜åœ¨è¿™ä¸ªBeançš„å®šä¹‰</font>
  2. æ›´å…·æœ‰åœºæ™¯åŒ–çš„å‘½åæ–¹æ³•
      - `<alias name="Beanæ ‡è¯†ç¬¦" alias ="åˆ«åA"/>`
      - `<alias name="Beanæ ‡è¯†ç¬¦" alias ="åˆ«åB"/>`

â‘ . é€šè¿‡XMLé…ç½®å…ƒä¿¡æ¯æŒ‡å®šBeanã€é…ç½®Beançš„åˆ«å

```xml
<!-- é€šè¿‡nameå±æ€§åé¢åŠ ä¸Šé€—å·åŒºåˆ†nameå’Œåˆ«å -->
<bean id="person2" class="com.geekbang.demo.BeanInfo.Person" name="person3,yoey2">
  <property name="age" value="18"/>
  <property name="name" value="yoey2"/>
</bean>
<bean id="person" class="com.geekbang.demo.BeanInfo.Person" >
  <property name="age" value="18"/>
  <property name="name" value="yoey"/>
</bean>
<alias name="person" alias="yoey"/>
```



â‘¡. è·å–Bean

```java
public static void main(String[] args) {
  DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
  XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(beanFactory);
  int beanDefinitions = reader.loadBeanDefinitions("classpath:META-INF/application.xml");
  System.err.println("load Beans count:" + beanDefinitions);

  Person person = beanFactory.getBean("person", Person.class);
  Person yoey = beanFactory.getBean("yoey", Person.class);
  System.err.println("personåˆ«åæŒ‡å®šçš„Bean ä¸ personæ˜¯å¦ç›¸ç­‰:"+ (person == yoey));
  String[] names = beanFactory.getBeanNamesForType(Person.class);
  System.err.println("Personç±»å‹çš„Bean"+ Arrays.toString(names));

  Person person2 = beanFactory.getBean("person2", Person.class);
  Person yoey2 = beanFactory.getBean("yoey2", Person.class);
  System.err.println("person2åˆ«åæŒ‡å®šçš„Bean ä¸ person2æ˜¯å¦ç›¸ç­‰:"+ (person2 == yoey2));

}
/*
	load Beans count:3
	personåˆ«åæŒ‡å®šçš„Bean ä¸ personæ˜¯å¦ç›¸ç­‰:true
	Personç±»å‹çš„Bean[person2, person]
	person2åˆ«åæŒ‡å®šçš„Bean ä¸ person2æ˜¯å¦ç›¸ç­‰:true
*/
```



### 1.4 å¦‚ä½•å°†BeanDefinitionæ³¨å†Œåˆ°IOCå®¹å™¨ï¼Ÿ

- æœ‰ä»¥ä¸‹çš„å‡ ç§æ–¹å¼å¯ä»¥å°†BeanDefinitionæ³¨å†Œåˆ°IOCå®¹å™¨

  1. XMLé…ç½®å…ƒä¿¡æ¯
     - `<bean name="xxx"></bean>`
  2. Java æ³¨è§£é…ç½®å…ƒä¿¡æ¯
     - `@Bean`
     - `@Compoment`
     - `@Import`
  3. java api é…ç½®å…ƒä¿¡æ¯ğŸ“Œ -> < color='red'>Springåº”ç”¨ä¸Šä¸‹æ–‡ä¸€èˆ¬éƒ½å®ç°äº† `BeanDefinitionRegistry`
     - å‘½åæ–¹å¼
       - `BeanDefinitionRegistry#registerBeanDefinition(String BeanName,BeanDefinition definition)`
     - éå‘½åæ–¹å¼
       - `BeanDefinitionReaderUtils#registerWithGeneratedName(AbstractBeanDefinition definition, BeanDefinitionRegistry registry)`
     - é…ç½®ç±»æ–¹å¼
       - `AnnotatedBeanDefinitionReader#register(...)`

#### 1.4.1 é€šè¿‡æ³¨è§£çš„æ–¹å¼æ³¨å†Œ

- <font color='red'>æ³¨æ„: åŒä¸€ä¸ªBeanä¸ä¼šè¢«å¤šæ¬¡æ³¨å†Œ!!</font>


  ```java
  @Import(AnnotationBeanDefinitionRegistryDemo.config.class)
  public class AnnotationBeanDefinitionRegistryDemo {
      public static void main(String[] args) {
          // åˆ›å»ºSpring åº”ç”¨ä¸Šä¸‹æ–‡
          AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext();
          // æ³¨å†Œconfig ä¸º ConfigurationClass (é…ç½®ç±»)
          ctx.register(config.class);
          // å¯åŠ¨ Spring åº”ç”¨ä¸Šä¸‹æ–‡ -> è°ƒç”¨å®¹å™¨çš„åˆ·æ–°æ–¹æ³•ï¼Œä¼šå¯¹Beançš„å®šä¹‰ä¿¡æ¯è¿›è¡Œåˆå§‹åŒ–
          ctx.refresh();
  
          // ä¾èµ–æŸ¥æ‰¾
          System.err.println("config ç±»å‹çš„æ‰€æœ‰Beans"+ctx.getBeansOfType(config.class));
          System.err.println("Person ç±»å‹çš„æ‰€æœ‰Beans"+ctx.getBeansOfType(Person.class));
  
          // å…³é—­Spring åº”ç”¨ä¸Šä¸‹æ–‡
          ctx.close();
      }
  
      @Component  /** é‡‡ç”¨@Componentçš„æ–¹å¼æ³¨å†ŒBean */
      public static class  config{
          @Bean
          public Person person(){
              Person person = new Person();
              person.setName("11");
              person.setAge(22);
              return person;
          }
      }
  }
  ```

  

#### 1.4.2 é€šè¿‡apiçš„æ–¹å¼æ³¨å†Œ

:::tip æ³¨æ„ç‚¹

1. DefaultListableBeanFactoryã€GenericApplicationContext å®ç°äº† BeanDefinitionRegistryæ¥å£ï¼Œå…·æœ‰æ³¨å†ŒBeanDefinitionçš„èƒ½åŠ›

2. AnnotationConfigApplicationContext å°±æ˜¯GenericApplicationContextçš„å­ç±»

:::

```java
public class APIBeanDefinitionDemo {
    public static void main(String[] args) {
        // åˆ›å»ºIOCå®¹å™¨
        DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
      
        // é€šè¿‡apiçš„æ–¹å¼æ³¨å†ŒBean -> å½“ç„¶è¿™é‡Œä¹Ÿèƒ½ä¼ å…¥Springåº”ç”¨ä¸Šä¸‹æ–‡å¯¹è±¡
        registryByName(beanFactory,"yoey1");
        registryByType(beanFactory);
        registryByType(beanFactory);
        // ä¾èµ–æŸ¥æ‰¾
        String[] names = beanFactory.getBeanNamesForType(Person.class);
        System.err.println(Arrays.toString(names));
    }

    public static void registryByName(BeanDefinitionRegistry registry,String name){
        BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(Person.class);
        builder.addPropertyValue("age",11);
        builder.addPropertyValue("name","yoey1");
        registry.registerBeanDefinition(name,builder.getBeanDefinition());
    }

    public static void registryByType(BeanDefinitionRegistry registry){
        BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(Person.class);
        builder.addPropertyValue("age",22);
        builder.addPropertyValue("name","yoey2");
        BeanDefinitionReaderUtils.registerWithGeneratedName(builder.getBeanDefinition(),registry);
    }
}

/*
	[yoey1, com.geekbang.demo.BeanInfo.Person#0, com.geekbang.demo.BeanInfo.Person#1]
*/ 
```



#### 1.4.3 æ³¨å†Œå¤–éƒ¨å•ä½“å¯¹è±¡

- å°†åˆ›å»ºçš„å¯¹è±¡æ³¨å†Œåˆ°IOCå®¹å™¨ä¸­

```java
public class OutBeanDemo {
    public static void main(String[] args) {
        // å®šä¹‰ä¸€ä¸ªå¤–éƒ¨çš„å•ä½“ç±»
        Person person = new Person();
        person.setName("11");
        person.setAge(22);

        // é€šè¿‡IOCå®¹å™¨çš„ registerSingleton æ³¨å†Œ -> æˆ–è€…é€šè¿‡Springåº”ç”¨ä¸Šä¸‹æ–‡è·å–åº•å±‚IOCå®¹å™¨
        DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
        beanFactory.registerSingleton("person",person);

        //ä¾èµ–æŸ¥æ‰¾
        Person bean = beanFactory.getBean("person", Person.class);
        System.out.println(bean);
    }
}
```



### 1.5 Beançš„å®ä¾‹åŒ–æ–¹å¼æœ‰å‡ ç§ï¼Ÿ

:::warning æ³¨æ„

1ã€ä½¿ç”¨Springåº”ç”¨ä¸Šä¸‹æ–‡æ³¨å†Œçš„BeanDefinitionï¼Œåªæœ‰é€šè¿‡è°ƒç”¨ä¸Šä¸‹æ–‡çš„`refresh()` æ–¹æ³•æ‰èƒ½å¯¹Beanè¿›è¡Œåˆå§‹åŒ–/å®ä¾‹åŒ–

2ã€ClassPathXmlApplicationContext åŠ è½½Xmlé…ç½®å…ƒä¿¡æ¯æ—¶ï¼Œå†…éƒ¨ä¼šè°ƒç”¨ä¸Šä¸‹æ–‡çš„åˆ·æ–°æ–¹æ³•å®ç°Beançš„å®ä¾‹åŒ–

:::

- <font color='red'>å¸¸è§„æ–¹å¼:</font> 

  1. é€šè¿‡æ„é€ å™¨ 	  ã€ é…ç½®å…ƒä¿¡æ¯:XMLã€javaæ³¨è§£ å’Œ java api ã€‘
  2. é€šè¿‡é™æ€å·¥å‚æ–¹æ³•  ã€ é…ç½®å…ƒä¿¡æ¯:XML å’Œ java api ã€‘
  3. é€šè¿‡Beanå·¥å‚æ–¹æ³• ã€ é…ç½®å…ƒä¿¡æ¯:XML å’Œ java api  ã€‘
  4. é€šè¿‡FactoryBean ã€ é…ç½®å…ƒä¿¡æ¯:XMLã€javaæ³¨è§£ å’Œ java api ã€‘
- <font color='red'>ç‰¹æ®Šæ–¹å¼</font>

  1. é€šè¿‡<font color='#f535e8'>`ServiceLoaderFactoryBean`</font>  ã€ é…ç½®å…ƒä¿¡æ¯:XMLã€javaæ³¨è§£ å’Œ java api ã€‘
     - ä¹Ÿæ˜¯FactoryBean çš„ä¸€ç§æ–¹å¼
  2. é€šè¿‡ <font color='#f535e8'>`AutowireCapableBeanFactory#createBeanï¼ˆClassï¼Œintï¼Œboolï¼‰`</font>  
  3. é€šè¿‡<font color='#f535e8'>`BeanDefinitionRegistry#registryBeanDefinition(String,BeanDefinition)`</font> å‘å®¹å™¨æ³¨å†ŒBeanDefinitionï¼Œç”±å®¹å™¨å®ä¾‹åŒ–

#### 1.5.0 é€šè¿‡æ„é€ å™¨ã€Setteræ³¨å…¥

```xml
<!--é€šè¿‡å±æ€§Setter æ³¨å…¥-->
<bean id="yoey" class="com.geekbang.MyDemo1.Pojo.User">
  <property name="age" value="2"/>
  <property name="name" value="Yoey"/>
</bean>

<!-- é€šè¿‡æ„é€ å™¨æ³¨å…¥ -->
<bean id="yoey2" class="com.geekbang.MyDemo1.Pojo.User">
  <constructor-arg name="age"  value="22"/>
  <constructor-arg name="name"  value="yoey"/>
</bean>
```



#### 1.5.1 é™æ€å·¥å‚æ–¹æ³•

- æ“ä½œæ­¥éª¤
  1. åœ¨Beanç±»ä¸­å®šä¹‰é™æ€æ–¹æ³•ï¼Œç”¨äºè¿”å›ä¸€ä¸ªBean
  2. ä¸ºBeanæŒ‡å®šä¸€ä¸ª <font color='#f535e8'>`factory-method`</font> 

â‘ ã€ Beanç±»ä¸­æŒ‡å®šé™æ€æ–¹æ³•ï¼Œè¿”å›Beanå¯¹è±¡

```java
public class Person {
    String name;
    Integer age;
  
    public static Person createUser(){
        Person person = new Person();
        person.setName("11");
        person.setAge(22);
        return person;
    }
}
```

â‘¡ã€ XMLé…ç½®å…ƒä¿¡æ¯æ—¶,é€šè¿‡ `factory-method` æŒ‡å®š é™æ€æ–¹æ³•

```xml
<!--é™æ€æ–¹æ³•-->
<bean id="static-person" class="com.geekbang.demo.BeanInfo.Person" factory-method="createUser"/>
```



#### 1.5.2 Bean + å·¥å‚æ–¹æ³•

- æ“ä½œæ­¥éª¤
  1. åˆ›å»ºä¸€ä¸ªå·¥å‚ç±»ï¼Œå…¶ä¸­å®šä¹‰è¿”å›Beançš„æ–¹æ³•
  2. é…ç½®å·¥å‚ç±»çš„Bean
  3. åœ¨Beançš„ <font color='#f535e8'>`factory-bean`Â </font>æŒ‡å®šå·¥å‚ç±»çš„Beanï¼Œ<font color='#f535e8'>`factory-method`</font> æŒ‡å®šå·¥å‚ç±»ä¸­è¿”å›Beançš„æ–¹æ³•

â‘ ã€ åˆ›å»ºä¸€ä¸ªå·¥å‚ç±»ï¼Œå…¶ä¸­å®šä¹‰è¿”å›Beanå¯¹è±¡çš„æ–¹æ³•

```java
public interface PersonFactory {

    default Person createPerson(){
        return Person.createUser();
    }
}
```

â‘¡ã€ é…ç½®å·¥å‚ç±»çš„Beanï¼Œå¹¶ä¸” åœ¨Beançš„`factory-bean` æŒ‡å®šå·¥å‚ç±»çš„Beanï¼Œ`factory-method` æŒ‡å®šå·¥å‚ç±»ä¸­è¿”å›Beançš„æ–¹æ³•

```xml
<!--Beanå·¥å‚-->
<bean class="com.geekbang.demo.Definition.Factory.DefaultPersonFactory" id="factory"/>
<bean id="beanFactoryPerson" factory-bean="factory" factory-method="createPerson"/>
```



#### 1.5.3 FactoryBean

- æ“ä½œæ–¹å¼
  1. åˆ›å»ºä¸€ä¸ªç±»å®ç° <font color='#f535e8'>`FactoryBean<T>`</font> æ¥å£
  2. å°†ä¸Šè¿°çš„ç±»æ³¨å…¥åˆ°å®¹å™¨ä¸­
  3. å¦‚æœéœ€è¦é€šè¿‡ç±»å‹è·å–Beanæ—¶ï¼Œè¿™ä¸ªç±»å‹å°±æ˜¯ `T`

â‘ ã€ åˆ›å»ºä¸€ä¸ªç±»å®ç°`FactoryBean<T>`
```java
public class PersonFactoryBean implements FactoryBean<Person> {
    @Override
    public Person getObject() throws Exception {
        Person person = new Person();
        person.setName("yoey");
        person.setAge(11);
        return person;
    }
    @Override
    public Class<?> getObjectType() {
        return null;
    }

    @Override
    public boolean isSingleton() {
        return true;
    }
}
```

â‘¡ã€ é€šè¿‡XMLé…ç½®å…ƒä¿¡æ¯çš„æ–¹å¼å°†FactoryBeançš„å®ç°æ³¨å…¥åˆ°å®¹å™¨ä¸­

```xml
<!--æ³¨å…¥FactoryBeançš„å®ç°-->
<bean id="personFactoryBean" class="com.geekbang.demo.Definition.PersonFactoryBean"/>
```

â‘¢ã€ è·å–FactoryBeançš„å®ç°(ç±»å‹å°±æ˜¯FactoryBean çš„æ³›å‹ç±»å‹)

```java
public class FactoryBeanDemo {
    public static void main(String[] args) {
        ClassPathXmlApplicationContext ctx = new ClassPathXmlApplicationContext("classpath:/META-INF/application.xml");
        ctx.refresh();
        Person factoryBean = (Person)ctx.getBean("personFactoryBean");
        System.out.println(factoryBean);
    }
}
/*
	Person{name='yoey', age=11}
*/
```





#### 1.5.4 Javaä¸­çš„ServiceLoader

- æ“ä½œæ­¥éª¤
  1. åœ¨classpathä¸‹åˆ›å»º <font color='#f535e8'>`/META-INF/services`</font> ç›®å½•
  2. åœ¨ä¸Šè¿°çš„ç›®å½•ä¸­å®šä¹‰æ²¡æœ‰åç¼€çš„æ–‡ä»¶ï¼Œæ–‡ä»¶åæ˜¯æ¥å£çš„å…¨ç±»å
  3. åœ¨ä¸Šè¿°çš„æ–‡ä»¶ä¸­é…ç½®è¯¥æ¥å£çš„å®ç°ç±»(å…¨ç±»å)
  4. é€šè¿‡ <font color='#f535e8'>`ServiceLoader`</font>  åŠ è½½ç±»å¯¹è±¡

â‘ ã€ åœ¨`/META-INF/services` ä¸­åˆ›å»ºæ–‡ä»¶

![image-20210123150532593](./image/2.Bean/image-20210123150532593.png)

â‘¡ã€ ä½¿ç”¨ ServiceLoaderåŠ è½½ç±»å¯¹è±¡

```java
 public static void main(String[] args) {
        ServiceLoader<PersonFactory> load = ServiceLoader.load(PersonFactory.class, ServiceLoaderFactoryBeanDemo.class.getClassLoader());
        Iterator<PersonFactory> iterator = load.iterator();
        while (iterator.hasNext()){
            PersonFactory next = iterator.next();
            System.out.println(next.createPerson());
        }
 }

/*
	Person{name='11', age=22}
*/

```



#### 1.5.5 ServiceLoaderFactoryBean

:::danger æ³¨æ„

ServiceLoaderFactoryBean ä¹Ÿæ˜¯FactoryBean æ¥å£çš„ä¸€ä¸ªå®ç°ç±»ï¼Œå…¶ä¸­è¿”å›çš„ç±»å‹å°±æ˜¯ `ServiceLoader`

:::

- æ“ä½œæ–¹å¼
  - åœ¨classpathä¸‹åˆ›å»º <font color='#f535e8'>`/META-INF/services`</font> ç›®å½•
  - åœ¨ä¸Šè¿°çš„ç›®å½•ä¸­å®šä¹‰æ²¡æœ‰åç¼€çš„æ–‡ä»¶ï¼Œæ–‡ä»¶åæ˜¯æ¥å£çš„å…¨ç±»å
  - åœ¨ä¸Šè¿°çš„æ–‡ä»¶ä¸­é…ç½®è¯¥æ¥å£çš„å®ç°ç±»(å…¨ç±»å)
  - åœ¨XMLé…ç½®å…ƒä¿¡æ¯ä¸­æŒ‡å®š<font color='#f535e8'>`ServiceLoaderFactoryBean`</font> çš„Beanï¼Œå¹¶ä¸”é…ç½® <font color='#f535e8'>`serviceType`</font> å±æ€§
  - è·å– ServiceLoaderFactoryBean çš„Beanè¿›è¡Œæ“ä½œ

â‘ ã€ XMLé…ç½®å…ƒä¿¡æ¯

```xml
<!--ServiceLoadFactoryBean-->
<bean id="personServiceLoader" class="org.springframework.beans.factory.serviceloader.ServiceLoaderFactoryBean">
  <property name="serviceType" value="com.geekbang.demo.Definition.Factory.PersonFactory"/>
</bean>
```

â‘¡ã€ ä»å®¹å™¨ä¸­è·å–ServiceLoader

```java
public static void main(String[] args) {
  ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext("classpath:/META-INF/application-slh.xml");
  ServiceLoader<PersonFactory> loader = context.getBean("personServiceLoader", ServiceLoader.class);
  Iterator<PersonFactory> iterator = loader.iterator();
  while (iterator.hasNext()){
    PersonFactory next = iterator.next();
    System.out.println(next.createPerson());
  }
}
```



### 1.6 Beançš„åˆå§‹åŒ–æ–¹å¼æœ‰å‡ ç§ï¼Ÿ

:::tip tip

- Beançš„ç”Ÿå‘½å‘¨æœŸ( Bean çš„åˆ›å»º -> åˆå§‹åŒ– -> é”€æ¯ )

  - åˆ›å»º Bean å®ä¾‹
  - ä¸º Bean çš„å±æ€§è®¾ç½®å€¼å’Œå¯¹å…¶ä»– Bean çš„å¼•ç”¨

  - <font color='blue'>è°ƒç”¨ Bean çš„åˆå§‹åŒ–æ–¹æ³•</font> 
  - Bean å¯ä»¥ä½¿ç”¨äº†
  - å½“å®¹å™¨å…³é—­æ—¶, è°ƒç”¨ Bean çš„é”€æ¯æ–¹æ³•

- Bean çš„åˆ›å»º ?

  - å•ä¾‹çš„
    - ä¼šåœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™åˆ›å»º Bean å¯¹è±¡ , åŒæ—¶ä¼šè°ƒç”¨åˆå§‹åŒ–æ–¹æ³•

  - å¤šå®ä¾‹çš„  
    - ä¼šåœ¨æ¯æ¬¡è·å– Bean çš„æ—¶å€™åˆ›å»º
    - åŒæ—¶ä¹Ÿä¼šåœ¨ è·å–æ—¶è°ƒç”¨åˆå§‹åŒ–æ–¹æ³• ,ä½†æ˜¯å®¹å™¨ä¸ä¼šå°†å…¶è¿›è¡Œé”€æ¯

:::

- Beançš„åˆå§‹åŒ–(Initialization)
  1. `@PostConstruct` æ ‡æ³¨æ–¹æ³• -> åŸºäºAnnotationConfigApplicationContext è°ƒç”¨
  2. å®ç°`InitializingBean`æ¥å£çš„afterPropertiesSet()
  3. è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•
     - XMLé…ç½®: `<bean init-method="xxx"/>`
     - java æ³¨è§£: `@Bean(initMethod=â€œxxxâ€)`
     - java api: `AbstractBeanDefinition#setInitMethodName(String)`

:::danger æ³¨æ„:Beanå„ä¸ªåˆå§‹åŒ–æ–¹æ³•çš„æ‰§è¡Œé¡ºåº

<font color='blue'>@PostConstruct -> å®ç°InitializingBean -> è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•</font>

:::



â‘ ã€ Beanå¯¹è±¡

```java
public class Person implements InitializingBean {
    String name;
    Integer age;
    public static Person createUser(){
        Person person = new Person();
        person.setName("11");
        person.setAge(22);
        return person;
    }

    /**
     * ä½¿ç”¨ {@link @PostConstruct} æ³¨è§£æ ‡è¯†çš„Bean åˆå§‹åŒ–æ–¹æ³•
     */
    @PostConstruct
    public void init(){
        System.err.println("ä½¿ç”¨@PostConstruct æ³¨è§£...");
    }

    public void  beanPostCon(){
        System.err.println("è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•:@Bean initMethod...");
    }
	
 	 // å®ç° InitializingBeançš„ afterPropertiesSetæ–¹æ³•
    @Override
    public void afterPropertiesSet() throws Exception {
        System.err.println("å®ç°SpringInitializingBean ...");
    }
}
```



â‘¡ã€ é€šè¿‡æ³¨è§£æ–¹å¼æ³¨å…¥Beanå¯¹è±¡

```java
public class BeanConstructDemo {
    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªæ³¨è§£é©±åŠ¨çš„Springåº”ç”¨ä¸Šä¸‹æ–‡
        AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext();
        context.register(BeanConstructDemo.class);
        context.refresh();
        //ä¾èµ–æŸ¥æ‰¾
        Person bean = context.getBean(Person.class);
        System.out.println(bean);
        context.close();
    }

   // è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•é€šè¿‡@Bean çš„nameå±æ€§æŒ‡å®šåˆå§‹åŒ–æ–¹æ³•
    @Bean(initMethod = "beanPostCon")
    public Person person(){
        Person person = new Person();
        person.setAge(22);
        person.setName("Yoey22");
        return person;
    }
}

/*
	ä½¿ç”¨@PostConstruct æ³¨è§£...
  å®ç°SpringInitializingBean ...
  è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•:@Bean initMethod...
*/
```



#### 1.6.1 å»¶è¿Ÿåˆå§‹åŒ–çš„Bean

- <mark>Beançš„å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆLazy Initializationï¼‰</mark>

  1. XML é…ç½®: `<bean  lasy-init="true|false"/>`
  2. java æ³¨è§£: `@Lazy(true)`

:::danger å»¶è¿Ÿåˆå§‹åŒ–ä¸éå»¶è¿Ÿåˆå§‹åŒ–çš„åŒºåˆ«ï¼Ÿ

- å»¶è¿Ÿåˆå§‹åŒ–çš„Bean
  - **åªæœ‰åœ¨è·å– Bean çš„æ—¶å€™è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•**
  - å¦‚æœæœ‰å…¶ä»–éå»¶è¿ŸåŠ è½½çš„Beanä¾èµ–äºè¿™ä¸ªBeanï¼Œä¹Ÿä¼šç«‹å³å¯¹è¿™ä¸ªBeanåˆå§‹åŒ–
- éå»¶è¿Ÿåˆå§‹åŒ–
  - åœ¨Springåº”ç”¨ä¸Šä¸‹æ–‡å¯åŠ¨å®Œæˆå,å°±ä¼šè°ƒç”¨åˆå§‹åŒ–æ–¹æ³•

:::

**å»¶è¿ŸåŠ è½½çš„Bean**

å¯ä»¥çœ‹åˆ°ï¼Œå®¹å™¨åˆ·æ–°çš„æ—¶å€™æ²¡æœ‰å¯¹Beanè¿›è¡Œåˆå§‹åŒ–,åªæ˜¯å°†Beanæ³¨å†Œåˆ°å®¹å™¨ï¼Œå½“å°è¯•ä»å®¹å™¨ä¸­è·å–Beançš„æ—¶å€™æ‰ä¼šå¯¹Beanè¿›è¡Œåˆå§‹åŒ–

```java
public class AnnotationBeanFactoryDemo {
    public static void main(String[] args) {
        AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext();
        ctx.register(AnnotationBeanFactoryDemo.class);
        System.out.println("refresh start...");
        ctx.refresh();
        System.out.println("refresh end...");
        Iterator<String> iterator = ctx.getBeanFactory().getBeanNamesIterator();
        while (iterator.hasNext()){
            String next = iterator.next();
            System.out.println(next);
        }
        System.out.println("-----");
        User user = (User)ctx.getBean("user");
        ctx.close();

    }
    @Lazy //Bean çš„æ‡’åŠ è½½
    @Bean
    public User user(){
        User user  = new User(33,"create by DefaultUserFactory");
        user.setName("create by DefaultUserFactory");
        user.setAge(33);
        return user;
    }
}

/*
refresh start...
refresh end...
org.springframework.context.annotation.internalConfigurationAnnotationProcessor
org.springframework.context.annotation.internalAutowiredAnnotationProcessor
org.springframework.context.annotation.internalCommonAnnotationProcessor
org.springframework.context.event.internalEventListenerProcessor
org.springframework.context.event.internalEventListenerFactory
annotationBeanFactoryDemo
user
environment
systemProperties
systemEnvironment
org.springframework.context.annotation.ConfigurationClassPostProcessor.importRegistry
messageSource
applicationEventMulticaster
lifecycleProcessor
-----
User æœ‰å‚æ„é€ å™¨è°ƒç”¨...
åˆå§‹åŒ– User name å±æ€§...
åˆå§‹åŒ– User age å±æ€§...
@PostConstruct ....
afterPropertiesSet ....
*/
```



### 1.7 Beançš„é”€æ¯

- Beançš„é”€æ¯
  1. `@PreDestroy`æ ‡æ³¨æ–¹æ³•
  2. å®ç°`DisposableBean`æ¥å£çš„ destroy()æ–¹æ³•
  3. è‡ªå®šä¹‰é”€æ¯æ–¹æ³•
     - XMLé…ç½®: `<bean destroy="xxx"/>`
     - java æ³¨è§£: `@Bean(destroy="xxx")`
     - Java api: `AbstractBeanDefinition#setDestroyMethodName(String)`

:::danger æ³¨æ„:Beanå„ä¸ªé”€æ¯æ–¹æ³•çš„æ‰§è¡Œé¡ºåº

<font color='blue'>@PreDestroy -> å®ç°DisposableBean -> è‡ªå®šä¹‰é”€æ¯æ–¹æ³•</font>

:::



### 1.8 IOCå®¹å™¨çš„Beanèƒ½å¤Ÿè¢«åƒåœ¾å›æ”¶å—ï¼Ÿ

- å¯ä»¥ï¼Œé€šè¿‡<font color='red'>å…³é—­Springå®¹å™¨(åº”ç”¨ä¸Šä¸‹æ–‡)</font>





