---
id: Bean
title: Bean
---



## BeanDefinition

- `BeanDefinition` æ˜¯ **Spring ä¸­å®šä¹‰ Beançš„ é…ç½®å…ƒä¿¡æ¯æ¥å£,ç”¨äºå­˜å‚¨Beançš„å®šä¹‰ä¿¡æ¯**,åŒ…å«:
  1. Bean çš„ç±»å
  2. Bean çš„è¡Œä¸ºå…ƒç´ ï¼Œæ¯”å¦‚<mark>ä½œç”¨åŸŸã€è‡ªåŠ¨ç»‘å®šçš„æ¨¡å¼ã€ç”Ÿå‘½å‘¨æœŸå›è°ƒ</mark> 
  3. å…¶ä»– Bean çš„å¼•ç”¨ï¼Œä¹Ÿå«åšä¾èµ–ï¼ˆDependenciesï¼‰
  4. é…ç½®è®¾ç½®, æ¯”å¦‚Beançš„å±æ€§(Properties)

### BeanDefinition å…ƒä¿¡æ¯

| å±æ€§                         | è¯´æ˜                                           |
| ---------------------------- | ---------------------------------------------- |
| **Class**                    | Beanå…¨ç±»åï¼Œå¿…é¡»æ˜¯å…·ä½“ç±»ï¼Œä¸èƒ½æ˜¯æŠ½è±¡ç±»æˆ–è€…æ¥å£ |
| **Name**                     | Beançš„åç§°/ID                                  |
| **Scope**                    | Beançš„ä½œç”¨åŸŸ(singletonã€propertypeâ€¦)           |
| **Constructor arguments**    | Bean æ„é€ å™¨å‚æ•°ï¼ˆç”¨äºä¾èµ–æ³¨å…¥ï¼‰                |
| **Properties**               | Bean å±æ€§è®¾ç½® ï¼ˆç”¨äºä¾èµ–æ³¨å…¥ï¼‰                 |
| **Autowiring mode**          | Bean è‡ªåŠ¨ç»‘å®šæ¨¡å¼ï¼ˆæ¯”å¦‚ï¼š é€šè¿‡åç§° byNameï¼‰    |
| **Lazy initialazation mode** | Bean å»¶è¿Ÿåˆå§‹åŒ–æ¨¡å¼ ï¼ˆå»¶è¿Ÿå’Œéå»¶è¿Ÿï¼‰           |
| **Initialization method**    | Bean åˆå§‹åŒ–å›è°ƒæ–¹æ³•åç§°                        |
| **Destruction method**       | Bean é”€æ¯å›è°ƒæ–¹æ³•åç§°                          |



### å¦‚ä½•æ„å»ºBeanDefinitionï¼Ÿ

> é™¤äº†é€šè¿‡ XML å’Œæ³¨è§£çš„æ–¹å¼æ¥å®šä¹‰ BeanDefinition,è¿˜å¯ä»¥æ‰‹åŠ¨çš„åˆ›å»º BeanDefinition

* **åŒ…å«ä»¥ä¸‹çš„å‡ ç§æ–¹å¼æ„å»ºBeanDefinition**
  1. é€šè¿‡ `BeanDefinitionBuilder`
  2. é€šè¿‡ `AbstractBeanDefinition` ä»¥åŠ**æ´¾ç”Ÿç±»**

:::danger æ³¨æ„
 BeanDefinition å¹¶éBeançš„æœ€ç»ˆæ€,è¿˜å¯ä»¥å¯¹Beanè¿›è¡Œé¢å¤–çš„è®¾ç½®, æ¯”å¦‚: **è®¾ç½®Beançš„åˆå§‹åŒ–æ–¹æ³•ã€é”€æ¯æ–¹æ³•ç­‰ç­‰**
:::

####  BeanDefinitionBuilder

:::caution GenericBeanDefinition å’Œ RootBeanDefinitionçš„åŒºåˆ«ï¼Ÿ
- GenericBeanDefinition å¯ä»¥è®¾ç½® **parent** å±æ€§
- RootBeanDefinition æ˜¯æ ¹éƒ¨ã€é¡¶å±‚çš„ Bean å®šä¹‰ä¿¡æ¯ï¼Œæ— æ³•è®¾ç½® parent å±æ€§	

:::

```java
public class BeanDefinitionCreateDemo {
    public static void main(String[] args) {
        // 1.é€šè¿‡ BeanDefinitionBuilder æ„å»º
        BeanDefinitionBuilder beanDefinitionBuilder = BeanDefinitionBuilder.genericBeanDefinition(User.class);

        // 2. é€šè¿‡å±æ€§è®¾ç½®,è¿™ç§æ–¹å¼ä¸ XML é…ç½®ç±»ä¼¼
        beanDefinitionBuilder.addPropertyValue("id", 33);
        beanDefinitionBuilder.addPropertyValue("name", "athu");

        // 3.è·å– BeanDefinition çš„å®ä¾‹
        GenericBeanDefinition genericBeanDefinition =(GenericBeanDefinition)beanDefinitionBuilder.getBeanDefinition();

        // 4. æ­¤æ—¶BeanDefinition å¹¶ä¸æ˜¯ Bean çš„æœ€ç»ˆçŠ¶æ€,è¿˜å¯ä»¥å¯¹ Beanè¿›è¡Œé¢å¤–çš„è®¾ç½®
        genericBeanDefinition.setInitMethodName("initMethod");
    }
}
```

#### AbstractBeanDefinition ä»¥åŠæ´¾ç”Ÿç±»

> GenericBeanDefinition å’Œ RootBeanDefinition éƒ½å±äº AbstractBeanDefinitionçš„å­ç±»,æ‰€ä»¥å¯ä»¥ç›´æ¥åˆ›å»º GenericBeanDefinition æˆ– RootBeanDefinition ç±»å‹çš„å®ä¾‹å¯¹è±¡

```java
/**
 * <b>é€šè¿‡ AbstractBeanDefinition çš„æ´¾ç”Ÿç±»åˆ›å»º BeanDefinition</b>
 *
 * @author <a href="mailto:zhuyuliangm@gmail.com">yuliang zhu</a>
 */
public class AbstractBeanDefinitionCreateDemo {
    public static void main(String[] args) {
        // 1. åˆ›å»º AbstractBeanDefinition çš„æ´¾ç”Ÿç±» => GenericBeanDefinition
        GenericBeanDefinition beanDefinition = new GenericBeanDefinition();
        // 2. è®¾ç½® BeanDefinition çš„ BeanClass ä¿¡æ¯
        beanDefinition.setBeanClass(User.class);
        
        // 3. è®¾ç½® Bean çš„å±æ€§ä¿¡æ¯
        MutablePropertyValues mutablePropertyValues = new MutablePropertyValues();
        mutablePropertyValues
                .add("id", 33)
                .add("name", "athu");
        beanDefinition.setPropertyValues(mutablePropertyValues);
        
        // 4. å’ŒBeanDefinitionBuilder ç±»ä¼¼çš„,è¿˜å¯ä»¥è®¾ç½® BeanDefinition çš„ init-method æ–¹æ³•
        beanDefinition.setInitMethodName("initMethod");
    }
}
```



## å‘½å Spring Bean

### Beançš„åç§°

- **æ¯ä¸ªBeanæ‹¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ ‡è¯†ç¬¦(identifiers)ï¼Œè¿™äº›æ ‡è¯†ç¬¦åœ¨Beanæ‰€åœ¨çš„å®¹å™¨å¿…é¡»æ˜¯å”¯ä¸€çš„**
  - é€šå¸¸ï¼Œä¸€ä¸ªBeanåªæœ‰ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åˆ«å (Alias) æ‹“å±•

- åœ¨åŸºäº XML çš„é…ç½®ä¸­(å¹¶éä¸€å®šæ˜¯ æœ¬åœ°çš„ Spring çš„é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ç½‘ç»œèµ„æº)ï¼Œé€šè¿‡ **id/name** å±æ€§æŒ‡å®š Beançš„æ ‡è¯†ç¬¦
  - é€šå¸¸ Bean çš„æ ‡è¯†ç¬¦ç”±å­—ç¬¦ç»„æˆ,å…è®¸å‡ºç°*ç‰¹æ®Šå­—ç¬¦*
- Bean çš„ id/name ä¸æ˜¯å¿…é¡»æŒ‡å®šçš„ï¼Œ**å®¹å™¨é»˜è®¤ä¼šä¸º Bean ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„åç§°**
  - é€šè¿‡ `BeanNameGenerator` çš„å®ç°ç±»æ¥ç”Ÿæˆï¼Œæ¯”å¦‚æ³¨è§£æ³¨å†Œä½¿ç”¨ `AnnotationBeanNameGenerator`



### Beançš„åˆ«å

- Beanåˆ«åçš„ä»·å€¼
  1. å¤ç”¨ç°æœ‰çš„BeanDefinition
      - å³: **ä½¿ç”¨Beançš„åˆ«åæ—¶ï¼Œä¸€å®šè¦å­˜åœ¨è¿™ä¸ªBeançš„å®šä¹‰**
  2. æ›´å…·æœ‰åœºæ™¯åŒ–çš„å‘½åæ–¹æ³•,å¯¹äºåŒä¸€ä¸ª Bean åœ¨ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ä¸‹ä½¿ç”¨ä¸åŒçš„åˆ«å
      - `<alias name="Beanæ ‡è¯†ç¬¦" alias ="åˆ«åA"/>`
      - `<alias name="Beanæ ‡è¯†ç¬¦" alias ="åˆ«åB"/>`
- å¦‚ä½•é…ç½® Bean çš„åˆ«å
  1. åœ¨ **<bean /> name å±æ€§**åä½¿ç”¨ **é€—å·ã€åˆ†å·** è¿›è¡Œåˆ†éš”
  2. åˆ©ç”¨ **<alias/> æ ‡ç­¾**è¿›è¡Œé…ç½®

â‘ . é€šè¿‡XMLé…ç½®å…ƒä¿¡æ¯æŒ‡å®šBeanã€é…ç½®Beançš„åˆ«å

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <!--
				å¯¼å…¥ç¬¬ä¸‰æ–¹ Spring XMLé…ç½®æ–‡ä»¶ dependency-look-up.xml,å…¶ä¸­å®šä¹‰äº†ä¸¤ä¸ª User ç±»å‹çš„ Bean
				1:
          <bean class="ioc.overview.Domain.User"
                  id="user">
                <property name="name" value="atu"/>
                <property name="id" value="10000"/>
    			</bean>
				2:
          <bean class="ioc.overview.Domain.SuperUser"
                id="superUser"
                parent="user"
                primary="true">
              <property name="address" value="å¸¸å·"/>
    			</bean>
		-->
    <import resource="classpath:META-INF/dependency-look-up.xml"/>

    <!-- è®¾ç½®åˆ«åçš„æ–¹å¼1: åœ¨æ³¨å†Œ Bean çš„æ—¶å€™, é€šè¿‡åœ¨ name å±æ€§åé¢ç”¨é€—å·è¿›è¡Œåˆ†å‰²-->
    <bean class="ioc.overview.Domain.User" name="user2, lisi2">
        <property name="name" value="atu"/>
        <property name="id" value="10000"/>
    </bean>

    <!--
    è®¾ç½®åˆ«åçš„æ–¹å¼2: åˆ©ç”¨ alias æ ‡ç­¾è¿›è¡Œé…ç½®
    å³: å°† Spring å®¹å™¨ä¸­ name/id ä¸º user çš„ Bean å»ºç«‹åˆ«åalias
		-->
    <alias name="user" alias="lisi"/>
</beans>
```



â‘¡. è·å–Bean

å¯ä»¥çœ‹åˆ°é€šè¿‡ name/id è·å–åˆ°çš„ Bean ç»„ä»¶å’Œé€šè¿‡åˆ«åè·å–åˆ°çš„ Bean ç»„ä»¶æ˜¯åŒä¸€ä¸ª

```java
/**
 * <b>æµ‹è¯• Beançš„åˆ«å</b>
 *
 * @author <a href="mailto:zhuyuliangm@gmail.com">yuliang zhu</a>
 */
public class BeanAlias {
    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ª BeanFactory
        BeanFactory beanFactory = new ClassPathXmlApplicationContext("MATE-INF/bean-definitions-context.xml");

        // é€šè¿‡ name ä¸åˆ«ååˆ†åˆ«è·å– name=user çš„Bean ç»„ä»¶
        User user = beanFactory.getBean("user", User.class);
        User lisiUser = beanFactory.getBean("lisi", User.class);
        System.out.println(user == lisiUser); // out: true

        User user2 = beanFactory.getBean("user2", User.class);
        User lisi2User = beanFactory.getBean("lisi2", User.class);
        System.out.println(user2 == lisi2User); // out: true

        // æŸ¥çœ‹Spring å®¹å™¨ä¸­ç±»å‹æ˜¯ User çš„Beanä¸€å…±æœ‰å‡ ä¸ª
        if (beanFactory instanceof ListableBeanFactory) {
            ListableBeanFactory factory = (ListableBeanFactory)beanFactory;
          
            Map<String, User> users = factory.getBeansOfType(User.class);
            // out: å¯ä»¥çœ‹åˆ°é™¤äº†å¯¼å…¥çš„ dependency-look-up.xml ä¸­æ³¨å…¥çš„ä¸¤ä¸ª User ç±»å‹çš„ Bean,åªæœ‰ä¸€ä¸ªæ–°å»ºçš„ Bean
            // {
            //      user=User{id=10000, name='atu'}, 
            //      superUser=SuperUser{address='å¸¸å·'} User{id=10000, name='atu'}, 
            //      user2=User{id=10000, name='atu'}
            // }
            System.out.println("æŒ‰ç±»å‹å®æ—¶æŸ¥è¯¢é›†åˆ Bean å¯¹è±¡:"+users);
        }
    }
}

```



## BeanDefinition æ³¨å†Œåˆ°IOCå®¹å™¨

> åœ¨ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°äº†å¯ä»¥é‡‡ç”¨ XML çš„æ–¹å¼å®šä¹‰ BeanDefinition å¹¶å°†å…¶æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­,é‚£ä¹ˆé™¤äº†è¿™ç§æ–¹å¼,Spring è¿˜æœ‰å…¶ä»–çš„æ–¹å¼å¯ä»¥å®ç°
>
> 1. Java æ³¨è§£
> 2. Java api

- åœ¨ Spring ä¸­æœ‰ä»¥ä¸‹çš„å‡ ç§æ–¹å¼å¯ä»¥å°† BeanDefinition æ³¨å†Œåˆ°IOCå®¹å™¨

  1. XMLé…ç½®å…ƒä¿¡æ¯
     - `<bean name="xxx"></bean>`
  2. Java æ³¨è§£é…ç½®å…ƒä¿¡æ¯
     - `@Bean`
     - `@Compoment`
     - `@Import`
  3. java api é…ç½®å…ƒä¿¡æ¯ğŸ“Œ -> Spring çš„ ApplicationContext ä¸€èˆ¬éƒ½å®ç°äº† `BeanDefinitionRegistry`
     - **å‘½åæ–¹å¼**
       - `BeanDefinitionRegistry#registerBeanDefinition(String BeanName,BeanDefinition definition)`
     - **éå‘½åæ–¹å¼**
       - `BeanDefinitionReaderUtils#registerWithGeneratedName(AbstractBeanDefinition definition, BeanDefinitionRegistry registry)`
     - **é…ç½®ç±»æ–¹å¼**
       - `AnnotatedBeanDefinitionReader#register(...)`

:::tip å…³äº BeanDefinitionRegistry çš„è¯´æ˜

1. DefaultListableBeanFactoryã€GenericApplicationContext å®ç°äº† BeanDefinitionRegistryæ¥å£ï¼Œå…·æœ‰æ³¨å†ŒBeanDefinitionçš„èƒ½åŠ›

2. AnnotationConfigApplicationContext å°±æ˜¯GenericApplicationContextçš„å­ç±»

:::

### åŸºäº XML

> è¿™ç§æ–¹å¼å°±æ˜¯å‰é¢ä¸€ç›´ä½¿ç”¨çš„,åªéœ€è¦é…ç½® XML ç„¶åè¯»å– XML é…ç½®æ–‡ä»¶å³å¯

### åŸºäºæ³¨è§£

#### @Bean + é…ç½®ç±»

> è¿™ç§æ–¹å¼éœ€è¦æä¾›ä¸€ä¸ªé…ç½®ç±»,ç„¶åç”¨ Spring åº”ç”¨ä¸Šä¸‹æ–‡å°†é…ç½®ç±»æ³¨å†Œåˆ° Spring çš„å®¹å™¨ä¸­,åŒæ—¶ä¹Ÿä¼šå°†é…ç½®ç±»ä¸­å®šä¹‰çš„ Bean ç»„ä»¶ä¸€èµ·æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­

```java
public class AnnotationBeanDefinitionDemo {
    public static void main(String[] args) {
        // 1. åˆ›å»ºä¸€ä¸ªåŸºäºæ³¨è§£çš„ Spring åº”ç”¨ä¸Šä¸‹æ–‡
        AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext();

        // 2. æ³¨å†Œç»„ä»¶ç±»,æ¯”å¦‚= Configuration Class (é…ç½®ç±») => ç›¸å½“äºç”¨ ä¸€ä¸ªå®ä½“çš„ Class å¯¹è±¡ä»£æ›¿  XML é…ç½®ä¿¡æ¯
        ctx.register(UserBeanConfig.class);

        // 3. åˆ·æ–° Spring åº”ç”¨ä¸Šä¸‹æ–‡
        ctx.refresh();

        // 4. è·å– Bean ä¿¡æ¯
      	/*
      		out: 
      		UserBeanConfig ç±»å‹çš„æ‰€æœ‰Beans
      			{
      					annotationBeanDefinitionDemo.UserBeanConfig=
      					bean.definition.AnnotationBeanDefinitionDemo$UserBeanConfig@687080dc
      			}
					User ç±»å‹çš„æ‰€æœ‰Beans{user=User{id=22, name='huakucha'}}
      	*/
        System.out.println("UserBeanConfig ç±»å‹çš„æ‰€æœ‰Beans"+ctx.getBeansOfType(UserBeanConfig.class));
        System.out.println("User ç±»å‹çš„æ‰€æœ‰Beans"+ctx.getBeansOfType(User.class));

        // 5. å…³é—­Spring åº”ç”¨ä¸Šä¸‹æ–‡
        ctx.close();
    }

    public static class UserBeanConfig {
        // ä½¿ç”¨ @Bean æ³¨è§£
      	// å®é™…ä¸Šä¹Ÿæ˜¯ BeanDefinition çš„ä¸€ç§å‘ˆç°å½¢å¼
        @Bean(name = {"user", "athu"})
        public User user() {
           User user = new User();
           user.setId(22L);
           user.setName("huakucha");
           return user;
        }
    }
}
```



#### @Compoment + é…ç½®ç±»

> è¿™ç§æ–¹å¼ä¹Ÿéœ€è¦ä¸€ä¸ªé…ç½®ç±»,ä½†æ˜¯é‡‡ç”¨ç»„ä»¶æ‰«æçš„æ–¹å¼å°†é…ç½®ç±»æ‰«æåˆ° Spring å®¹å™¨ä¸­,åŒæ—¶ä¹Ÿä¼šå°†é…ç½®ç±»ä¸­å®šä¹‰çš„ Bean ç»„ä»¶ä¸€èµ·æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­



```java
public class AnnotationBeanDefinitionDemo2 {
    public static void main(String[] args) {
        // 1. åˆ›å»ºä¸€ä¸ªåŸºäºæ³¨è§£çš„ Spring åº”ç”¨ä¸Šä¸‹æ–‡
        AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext();

        // 2. æ‰«æ Component ç»„ä»¶
        ctx.scan("bean.definition");

        // 3. åˆ·æ–° Spring åº”ç”¨ä¸Šä¸‹æ–‡
        ctx.refresh();

        // 4. è·å– Bean ä¿¡æ¯
      	/*
      		UserBeanConfig ç±»å‹çš„æ‰€æœ‰Beans
      		 {
              annotationBeanDefinitionDemo2.UserBeanConfig=
              bean.definition.AnnotationBeanDefinitionDemo2$UserBeanConfig@710726a3
      		 	}
					User ç±»å‹çš„æ‰€æœ‰Beans{user=User{id=22, name='huakucha'}}
      	*/
        System.out.println("UserBeanConfig ç±»å‹çš„æ‰€æœ‰Beans"+ctx.getBeansOfType(UserBeanConfig.class));
        System.out.println("User ç±»å‹çš„æ‰€æœ‰Beans"+ctx.getBeansOfType(User.class));

        // 5. å…³é—­Spring åº”ç”¨ä¸Šä¸‹æ–‡
        ctx.close();
    }

  	// å®é™…ä¸Šä¹Ÿæ˜¯ BeanDefinition çš„ä¸€ç§å‘ˆç°å½¢å¼
    @Component
    public static class UserBeanConfig {
        // ä½¿ç”¨ @Bean æ³¨è§£
        @Bean(name = {"user", "athu"})
        public User user() {
           User user = new User();
           user.setId(22L);
           user.setName("huakucha");
           return user;
        }
    }
}
```



#### @Import + é…ç½®ç±»

> è¿™ç§æ–¹å¼ä¹Ÿéœ€è¦ä¸€ä¸ªé…ç½®ç±»,ä½†æ˜¯é‡‡ç”¨çš„æ˜¯ @Import æ³¨è§£å°†é…ç½®ç±»å¯¼å…¥åˆ° Spring å®¹å™¨ä¸­

```java
@Import({AnnotationBeanDefinitionDemo3.UserBeanConfig.class})
public class AnnotationBeanDefinitionDemo3 {
    public static void main(String[] args) {
        // 1. åˆ›å»ºä¸€ä¸ªåŸºäºæ³¨è§£çš„ Spring åº”ç”¨ä¸Šä¸‹æ–‡
        AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext();

        // 2. å°†å½“å‰ç±»æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­,åŒæ—¶ä¼šå°†@Import å¯¼å…¥çš„é…ç½®ç±»ä¹Ÿæ³¨å†Œåˆ°Spring å®¹å™¨ä¸­
        ctx.register(AnnotationBeanDefinitionDemo3.class);

        // 3. åˆ·æ–° Spring åº”ç”¨ä¸Šä¸‹æ–‡
        ctx.refresh();

        // 4. è·å– Bean ä¿¡æ¯
      	/*
        UserBeanConfig ç±»å‹çš„æ‰€æœ‰Beans
                  {bean.definition.AnnotationBeanDefinitionDemo4$UserBeanConfig=
                  bean.definition.AnnotationBeanDefinitionDemo4$UserBeanConfig@cb51256}
				User ç±»å‹çš„æ‰€æœ‰Beans{user=User{id=22, name='huakucha'}}
      	*/
        System.out.println("UserBeanConfig ç±»å‹çš„æ‰€æœ‰Beans"+ctx.getBeansOfType(UserBeanConfig.class));
        System.out.println("User ç±»å‹çš„æ‰€æœ‰Beans"+ctx.getBeansOfType(User.class));

        // 5. å…³é—­Spring åº”ç”¨ä¸Šä¸‹æ–‡
        ctx.close();
    }

  	// å®é™…ä¸Šä¹Ÿæ˜¯ BeanDefinition çš„ä¸€ç§å‘ˆç°å½¢å¼
    public static class UserBeanConfig {
        // ä½¿ç”¨ @Bean æ³¨è§£
        @Bean(name = {"user", "athu"})
        public User user() {
           User user = new User();
           user.setId(22L);
           user.setName("huakucha");
           return user;
        }
    }
}
```

:::caution æ³¨æ„ç‚¹

**æ³¨æ„: åŒä¸€ä¸ªBeanä¸ä¼šè¢«å¤šæ¬¡æ³¨å†Œ!!**


  ```java
  public class AnnotationBeanDefinitionDemo4 {
      public static void main(String[] args) {
          // 1. åˆ›å»ºä¸€ä¸ªåŸºäºæ³¨è§£çš„ Spring åº”ç”¨ä¸Šä¸‹æ–‡
          AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext();
  
          // 2. æ‰«æ Component ç»„ä»¶
          ctx.register(UserBeanConfig.class);
          ctx.scan("bean.definition");
  
          // 3. åˆ·æ–° Spring åº”ç”¨ä¸Šä¸‹æ–‡
          ctx.refresh();
  
          // 4. è·å– Bean ä¿¡æ¯
        	/*
        	UserBeanConfig ç±»å‹çš„æ‰€æœ‰Beans
        	 {
        	 		annotationBeanDefinitionDemo4.UserBeanConfig=
        	 			bean.definition.AnnotationBeanDefinitionDemo4$UserBeanConfig@78186a70
        	 	}
  				User ç±»å‹çš„æ‰€æœ‰Beans{user=User{id=22, name='huakucha'}}
  
        	*/
          System.out.println("UserBeanConfig ç±»å‹çš„æ‰€æœ‰Beans"+ctx.getBeansOfType(UserBeanConfig.class));
          System.out.println("User ç±»å‹çš„æ‰€æœ‰Beans"+ctx.getBeansOfType(User.class));
  
          // 5. å…³é—­Spring åº”ç”¨ä¸Šä¸‹æ–‡
          ctx.close();
      }
  
      @Component
      public static class UserBeanConfig {
          // ä½¿ç”¨ @Bean æ³¨è§£
          @Bean(name = {"user", "athu"})
          public User user() {
             User user = new User();
             user.setId(22L);
             user.setName("huakucha");
             return user;
          }
      }
  }
  ```



:::

### åŸºäº API

```java
public class APIBeanDefinitionDemo {
    public static void main(String[] args) {
        // åˆ›å»ºIOCå®¹å™¨
        DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
      
        // é€šè¿‡apiçš„æ–¹å¼æ³¨å†ŒBean -> å½“ç„¶è¿™é‡Œä¹Ÿèƒ½ä¼ å…¥Springåº”ç”¨ä¸Šä¸‹æ–‡å¯¹è±¡
        registryByName(beanFactory,"yoey1");
        registryByType(beanFactory);
        registryByType(beanFactory);
        // ä¾èµ–æŸ¥æ‰¾
        String[] names = beanFactory.getBeanNamesForType(Person.class);
        System.err.println(Arrays.toString(names));
    }

  	// å‘½åçš„æ–¹å¼
    public static void registryByName(BeanDefinitionRegistry registry,String name){
       // æ‰‹åŠ¨åˆ›å»ºäº† BeanDefinition
        BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(Person.class);
        builder.addPropertyValue("age",11);
        builder.addPropertyValue("name","yoey1");
        registry.registerBeanDefinition(name,builder.getBeanDefinition());
    }
		// éå‘½åçš„æ–¹å¼
    public static void registryByType(BeanDefinitionRegistry registry){
        BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(Person.class);
        builder.addPropertyValue("age",22);
        builder.addPropertyValue("name","yoey2");
        BeanDefinitionReaderUtils.registerWithGeneratedName(builder.getBeanDefinition(),registry);
    }
}

/*
	[yoey1, com.geekbang.demo.BeanInfo.Person#0, com.geekbang.demo.BeanInfo.Person#1]
*/ 
```



### æ³¨å†Œå¤–éƒ¨å•ä½“å¯¹è±¡

> æ‰€è°“çš„å¤–éƒ¨å¯¹è±¡å°±æ˜¯è¿™ä¸ªå¯¹è±¡æ‰‹åŠ¨å»åˆ›å»º,ä¸”å®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸ç”± Spring æ¥ç®¡ç†,ä½†æ˜¯å¯ä»¥äº¤ç”± Spring æ‰˜ç®¡è¿™ä¸ªå¯¹è±¡

- å°†åˆ›å»ºçš„å¯¹è±¡æ³¨å†Œåˆ°IOCå®¹å™¨ä¸­

```java
public class OutBeanDemo {
    public static void main(String[] args) {
        // å®šä¹‰ä¸€ä¸ªå¤–éƒ¨çš„å•ä½“ç±»
        Person person = new Person();
        person.setName("11");
        person.setAge(22);

        // é€šè¿‡IOCå®¹å™¨çš„ registerSingleton æ³¨å†Œ -> æˆ–è€…é€šè¿‡Springåº”ç”¨ä¸Šä¸‹æ–‡è·å–åº•å±‚IOCå®¹å™¨
        DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
        beanFactory.registerSingleton("person",person);

        //ä¾èµ–æŸ¥æ‰¾
        Person bean = beanFactory.getBean("person", Person.class);
        System.out.println(bean);
    }
}
```



##  Bean çš„å®ä¾‹åŒ–æ–¹å¼

> ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°,æˆ‘ä»¬å¯ä»¥é€‰æ‹©ç”±æ¡†æ¶æ¥æ³¨å†Œ BeanDefinition,ä¹Ÿå¯ä»¥é€‰æ‹©è‡ªå·±æ‰‹åŠ¨æ³¨å†ŒBeanDefinitionã€‚é‚£ä¹ˆæ³¨å†Œå®Œæˆå,Spring æ¡†æ¶å¦‚ä½•å°†BeanDefinition å®ä¾‹åŒ–ä¸ºå¯¹è±¡å‘¢?
>
> **Springé»˜è®¤é‡‡ç”¨æ„é€ å™¨çš„æ–¹å¼,å½“ç„¶ä¹Ÿæ”¯æŒä¾‹å¦‚é™æ€å·¥å‚æ–¹æ³•ã€å·¥å‚æ–¹æ³•å’Œ FactoryBean ç­‰çš„æ–¹å¼**

:::warning æ³¨æ„

1ã€ä½¿ç”¨Springåº”ç”¨ä¸Šä¸‹æ–‡æ³¨å†Œçš„BeanDefinitionï¼Œåªæœ‰é€šè¿‡è°ƒç”¨ä¸Šä¸‹æ–‡çš„`refresh()` æ–¹æ³•æ‰èƒ½å¯¹Beanè¿›è¡Œåˆå§‹åŒ–/å®ä¾‹åŒ–

2ã€ClassPathXmlApplicationContext åŠ è½½Xmlé…ç½®å…ƒä¿¡æ¯æ—¶ï¼Œå†…éƒ¨ä¼šè°ƒç”¨ä¸Šä¸‹æ–‡çš„åˆ·æ–°æ–¹æ³•å®ç°Beançš„å®ä¾‹åŒ–

:::

- **å¸¸è§„æ–¹å¼:**
  1. é€šè¿‡**æ„é€ å™¨** 	  	ã€ é…ç½®å…ƒä¿¡æ¯:XMLã€javaæ³¨è§£ å’Œ java api ã€‘
  2. é€šè¿‡**Bean é™æ€å·¥å‚æ–¹æ³•**  ã€ é…ç½®å…ƒä¿¡æ¯:XML å’Œ java api ã€‘
  3. é€šè¿‡ **Bean å®ä¾‹å·¥å‚æ–¹æ³•** ã€ é…ç½®å…ƒä¿¡æ¯:XML å’Œ java api  ã€‘
  4. é€šè¿‡ **FactoryBean** ã€ é…ç½®å…ƒä¿¡æ¯:XMLã€javaæ³¨è§£ å’Œ java api ã€‘
- **ç‰¹æ®Šæ–¹å¼**
  1. é€šè¿‡<font color='#f535e8'>`ServiceLoaderFactoryBean`</font>  ã€ é…ç½®å…ƒä¿¡æ¯:XMLã€javaæ³¨è§£ å’Œ java api ã€‘
     - ä¹Ÿæ˜¯FactoryBean çš„ä¸€ç§æ–¹å¼
  2. é€šè¿‡ <font color='#f535e8'>`AutowireCapableBeanFactory#createBeanï¼ˆClassï¼Œintï¼Œboolï¼‰`</font>  
  3. é€šè¿‡<font color='#f535e8'>`BeanDefinitionRegistry#registryBeanDefinition(String,BeanDefinition)`</font> å‘å®¹å™¨æ³¨å†ŒBeanDefinitionï¼Œç”±å®¹å™¨å®ä¾‹åŒ–

### é€šè¿‡æ„é€ å™¨ã€Setter

> è¿™é‡Œä½¿ç”¨çš„æ˜¯ XML é…ç½®å…ƒä¿¡æ¯,ä¹Ÿå¯ä»¥é€‰æ‹©æ³¨è§£æˆ–è€… java api

æ„é€ å™¨æˆ–è€… Setter çš„æ–¹å¼ä¸‹,ä¼šç›´æ¥è°ƒç”¨ Pojo çš„ æ„é€ å™¨ã€Setteræ–¹æ³•å®ç°å¯¹è±¡çš„å®ä¾‹åŒ–

```xml
<!-- Setter çš„æ–¹å¼-->
<bean id="yoey" class="com.geekbang.MyDemo1.Pojo.User">
  <property name="age" value="2"/>
  <property name="name" value="Yoey"/>
</bean>

<!-- æ„é€ å™¨çš„æ–¹å¼ -->
<bean id="yoey2" class="com.geekbang.MyDemo1.Pojo.User">
  <constructor-arg name="age"  value="22"/>
  <constructor-arg name="name"  value="yoey"/>
</bean>
```

### å·¥å‚æ¨¡å¼

#### Bean é™æ€å·¥å‚æ–¹æ³•

> ä¸€èˆ¬æƒ…å†µä¸‹,é€šè¿‡æ„é€ å™¨ã€Setter çš„æ–¹å¼æ¥å®ä¾‹åŒ–ä¸€ä¸ª Bean,Spring è¿˜æ”¯æŒ**å°†å®ä¾‹åŒ–æ–¹æ³•å®šä¹‰ä¸º Bean å†…éƒ¨çš„é™æ€æ–¹æ³•(factory-method)**

- æ“ä½œæ­¥éª¤
  1. åœ¨Beanç±»ä¸­å®šä¹‰é™æ€æ–¹æ³•ï¼Œç”¨äºè¿”å›ä¸€ä¸ªBean
  2. ä¸ºBeanæŒ‡å®šä¸€ä¸ª <font color='#f535e8'>`factory-method`</font> 

â‘ ã€ Beanç±»ä¸­æŒ‡å®šé™æ€æ–¹æ³•ï¼Œè¿”å›Beanå¯¹è±¡

```java
public class Person {
    String name;
    Integer age;
  
  	// é™æ€æ–¹æ³•
    public static Person createUser(){
        Person person = new Person();
        person.setName("11");
        person.setAge(22);
        return person;
    }
}
```

â‘¡ã€ XMLé…ç½®å…ƒä¿¡æ¯æ—¶,é€šè¿‡ `factory-method` æŒ‡å®š **é™æ€æ–¹æ³•**

```xml
<!--é™æ€æ–¹æ³•-->
<bean id="static-person" class="com.geekbang.demo.BeanInfo.Person" factory-method="createUser"/>
```

:::caution æ³¨æ„

åœ¨ä»¥ XML ä¸ºé…ç½®ä¿¡æ¯ä¸­,å¦‚æœæ—¢æŒ‡å®šäº†  **factory-method**,è¿˜æŒ‡å®šäº† setter æˆ–è€…æ„é€ å™¨å‚æ•°,é‚£ä¹ˆä»¥åè€…ä¸ºä¸»

```xml
    <bean id="create-by-static-factory-method"
          class="ioc.overview.Domain.User"
          factory-method="createUserStatic">
      <!-- è¿™é‡Œçš„ createUserStatic ä¸ä¼šèµ·æ•ˆ,è€Œæ˜¯ä»¥ä¸‹é¢çš„ setter æ³¨å…¥çš„å‚æ•°ä¸ºä¸»-->
        <property name="id" value="11"/>
        <property name="name" value="user11"/>
    </bean>
```



:::

####  Bean å®ä¾‹å·¥å‚æ–¹æ³•

> é™¤äº†å¯ä»¥åœ¨ Bean çš„å†…éƒ¨å®šä¹‰ä¸€ä¸ªé™æ€æ–¹æ³•,Spring è¿˜æ”¯æŒ**å°†å®ä¾‹åŒ–æ–¹æ³•å®šä¹‰ä¸ºå…¶ä»–ç±»ä¸­çš„å®ä¾‹æ–¹æ³•,æˆ‘ä»¬ç§°è¿™ä¸ªç±»ä¸º â€œå·¥å‚ç±»â€**
>
> 1. å°†å·¥å‚æ–¹æ³•æ‰€åœ¨ç±»å®šä¹‰ä¸º Bean => **factory-bean**
> 2. åœ¨å·¥å‚ Bean ä¸­å®šä¹‰å®ä¾‹çš„å·¥å‚æ–¹æ³• => **factory-method**
>
> å¯ä»¥è¯´,[é™æ€å·¥å‚æ–¹æ³•](Bean#é™æ€å·¥å‚æ–¹æ³•) å°±æ˜¯ å·¥å‚Bean + å·¥å‚æ–¹æ³• çš„**ç‰¹æ®Šå‘ˆç°å½¢å¼**

- æ“ä½œæ­¥éª¤
  1. åˆ›å»ºä¸€ä¸ªå·¥å‚ç±»ï¼Œå…¶ä¸­å®šä¹‰è¿”å›Beançš„æ–¹æ³•
  2. é…ç½®å·¥å‚ç±»çš„Bean
  3. åœ¨Beançš„ <font color='#f535e8'>`factory-bean`Â </font>æŒ‡å®šå·¥å‚ç±»çš„Beanï¼Œ<font color='#f535e8'>`factory-method`</font> æŒ‡å®šå·¥å‚ç±»ä¸­å¯ä»¥è¿”å›Beançš„å®ä¾‹æ–¹æ³•

â‘ ã€ åˆ›å»ºä¸€ä¸ªå·¥å‚ç±»ï¼Œå…¶ä¸­å®šä¹‰è¿”å› Bean å¯¹è±¡çš„å®ä¾‹æ–¹æ³•

```java
/**
 * <b>Userçš„å·¥å‚ç±»</b>
 * @author <a href="mailto:zhuyuliangm@gmail.com">yuliang zhu</a>
 */
public class UserFactory {
    public User createUser() {
        User user = new User();
        user.setId(22L);
        user.setName("lisi");
        return user;
    }
}
```

â‘¡ã€ é…ç½®å·¥å‚ç±»çš„Beanï¼Œå¹¶ä¸” åœ¨Beançš„`factory-bean` æŒ‡å®šå·¥å‚ç±»çš„Beanï¼Œ`factory-method` æŒ‡å®šå·¥å‚ç±»ä¸­è¿”å›Beançš„å®ä¾‹æ–¹æ³•

```xml
<!--æ³¨å†Œä¸€ä¸ª Bean çš„å·¥å‚ç±»-->
<bean id="userFactory"  class="bean.factory.UserFactory"/>

<!--åˆ©ç”¨  Bean çš„å·¥å‚ç±»ä¸­çš„å·¥å‚æ–¹æ³•å®ä¾‹åŒ– User çš„ Bean-->
<bean id="create-by-factory-method"
      class="ioc.overview.Domain.User"
      factory-bean="userFactory"
      factory-method="createUser"
/>
```

â‘¢ã€æµ‹è¯•ä½¿ç”¨ Bean å®ä¾‹å·¥å‚æ–¹æ³•

```java
/**
 * <b>åˆ©ç”¨ Bean çš„å®ä¾‹å·¥å‚æ–¹æ³•å®ä¾‹åŒ–ä¸€ä¸ª Bean</b>
 *
 * @author <a href="mailto:zhuyuliangm@gmail.com">yuliang zhu</a>
 */
public class BeanCreationDemo2 {
    public static void main(String[] args) {
        BeanFactory factory = new ClassPathXmlApplicationContext("MATE-INF/bean-creation-context.xml");
        User user = factory.getBean("create-by-factory-method", User.class);
      	// out: User{id=22, name='lisi'} 
        System.out.println(user);
    }
}

```



#### FactoryBean

> ä¸Šé¢ Bean å®ä¾‹å·¥å‚æ–¹æ³•ä¸­,ä¸ä»…éœ€è¦æ³¨å†Œä¸€ä¸ªå·¥å‚ç±»çš„ Bean,è¿˜è¦åœ¨ Bean ä¸­æŒ‡å®š **factory-beanã€factory-method**, è€Œ FactoryBean çš„æ–¹å¼åˆ™å¯ä»¥çœç•¥å¾ˆå¤§éƒ¨åˆ†æ“ä½œ,ä»…ä»…éœ€è¦å®ç°FactoryBeanæ¥å£çš„ getObject()æ–¹æ³•å³å¯

- æ“ä½œæ–¹å¼
  1. åˆ›å»ºä¸€ä¸ªç±»å®ç° `FactoryBean<T>` æ¥å£,ä¸»è¦å®ç° **getObject()**
  2. å°†ä¸Šè¿°çš„ç±»æ³¨å…¥åˆ°å®¹å™¨ä¸­
  3. å¦‚æœéœ€è¦é€šè¿‡ç±»å‹è·å–Beanæ—¶ï¼Œè¿™ä¸ªç±»å‹å°±æ˜¯ `T`

â‘ ã€ åˆ›å»ºä¸€ä¸ªç±»å®ç°`FactoryBean<T>`
```java
/**
 * <b>User çš„FactoryBean</b>
 * @author <a href="mailto:zhuyuliangm@gmail.com">yuliang zhu</a>
 */
public class UserFactoryBean implements FactoryBean<User> {
    @Override
    public User getObject() throws Exception {
        System.out.println("call UserFactoryBean#getObject");
        User user = new User();
        user.setId(33L);
        user.setName("UserFactoryBean");
        return user;
    }

    @Override
    public Class<?> getObjectType() {
        return User.class;
    }
}
```

â‘¡ã€ é€šè¿‡XMLé…ç½®å…ƒä¿¡æ¯çš„æ–¹å¼å°†FactoryBeançš„å®ç°æ³¨å…¥åˆ°å®¹å™¨ä¸­

```xml
<!--
   åˆ›å»ºä¸€ä¸ª User çš„ FactoryBean 
   è¿™ç§æ¨¡å¼ä¸‹,factory-bean FactoryBean å®ç°ç±»æœ¬èº«, ä¸” factory-method æ˜¯å›ºå®šçš„ getObject
 -->
<bean id="userFactoryBean"  class="bean.factory.UserFactoryBean"/>
```

â‘¢ã€ è·å–FactoryBeançš„å®ç°(ç±»å‹å°±æ˜¯FactoryBean çš„æ³›å‹ç±»å‹)

```java
/**
 * <b>æµ‹è¯• User çš„ FactoryBean</b>
 * @author <a href="mailto:zhuyuliangm@gmail.com">yuliang zhu</a>
 */
public class BeanCreationDemo3 {
    public static void main(String[] args) throws Exception {
        BeanFactory factory = new ClassPathXmlApplicationContext("MATE-INF/bean-creation-context.xml");
        User user = factory.getBean("userFactoryBean", User.class);
      	/*
      		out: 
      		call UserFactoryBean#getObject
					User{id=33, name='UserFactoryBean'}
      	*/
        System.out.println(user);
    }
}
```

:::caution æ³¨æ„ç‚¹

è¿™ç§FactoryBean çš„æ–¹å¼ä¸‹,è¿›è¡Œä¾èµ–æŸ¥æ‰¾çš„æ—¶å€™,ç±»å‹æ˜¯ FactoryBean#getObjectType æ–¹æ³•è¿”å›çš„å¯¹è±¡ç±»å‹

:::



### ServiceLoader

#### SPI

- SPI å¯ä»¥å‚è€ƒè¿™ä¸ª[åšæ–‡](https://blog.huakucha.top/posts/java-basic/spi)
- æ“ä½œæ­¥éª¤
  1. åœ¨classpathä¸‹åˆ›å»º <font color='#f535e8'>`/META-INF/services`</font> ç›®å½•
  2. åœ¨ä¸Šè¿°çš„ç›®å½•ä¸­å®šä¹‰æ²¡æœ‰åç¼€çš„æ–‡ä»¶ï¼Œæ–‡ä»¶åæ˜¯æ¥å£çš„å…¨ç±»å
  3. åœ¨ä¸Šè¿°çš„æ–‡ä»¶ä¸­é…ç½®è¯¥æ¥å£çš„å®ç°ç±»(å…¨ç±»å)
  4. é€šè¿‡ <font color='#f535e8'>`ServiceLoader`</font>  åŠ è½½ç±»å¯¹è±¡

â‘ ã€ åœ¨`/META-INF/services` ä¸­åˆ›å»ºæ–‡ä»¶: MATE-INF/services/bean.factory.UserFactoryInterface

```txtÂ title=â€œMATE-INF/services/bean.factory.UserFactoryInterfaceâ€
bean.factory.UserFactoryImpl
```

â‘¡ã€ ä½¿ç”¨ ServiceLoaderåŠ è½½ç±»å¯¹è±¡

```java
/**
 * <b>SPIçš„æ¼”ç¤º</b>
 * @author <a href="mailto:zhuyuliangm@gmail.com">yuliang zhu</a>
 */
public class SpiDemo {
    public static void main(String[] args) {
        ServiceLoader<UserFactoryInterface> users = ServiceLoader.load(UserFactoryInterface.class);
        Iterator<UserFactoryInterface> iterator = users.iterator();
        while(iterator.hasNext()) {
            UserFactoryInterface userFactoryInterface = iterator.next();
            // out: spi create==>User{id=22, name='lisi'}
            userFactoryInterface.createUser();
        }
    }
}
```



#### ServiceLoaderFactoryBean

:::danger æ³¨æ„

1. ServiceLoaderFactoryBean ä¹Ÿæ˜¯FactoryBean æ¥å£çš„ä¸€ä¸ªå®ç°ç±»ï¼Œå…¶ä¸­è¿”å›çš„ç±»å‹å°±æ˜¯ `ServiceLoader`
2. å¯ä»¥æŸ¥çœ‹ **org.springframework.beans.factory.serviceloader.AbstractServiceLoaderBasedFactoryBean** äº†è§£å…¶åŒ…å«çš„å±æ€§
   - `serviceType`
   - `beanClassLoader`

:::

- æ“ä½œæ–¹å¼
  - åœ¨classpathä¸‹åˆ›å»º <font color='#f535e8'>`/META-INF/services`</font> ç›®å½•
  - åœ¨ä¸Šè¿°çš„ç›®å½•ä¸­å®šä¹‰æ²¡æœ‰åç¼€çš„æ–‡ä»¶ï¼Œæ–‡ä»¶åæ˜¯æ¥å£çš„å…¨ç±»å
  - åœ¨ä¸Šè¿°çš„æ–‡ä»¶ä¸­é…ç½®è¯¥æ¥å£çš„å®ç°ç±»(å…¨ç±»å)
  - åœ¨XMLé…ç½®å…ƒä¿¡æ¯ä¸­æŒ‡å®š<font color='#f535e8'>`ServiceLoaderFactoryBean`</font> çš„Beanï¼Œå¹¶ä¸”é…ç½® <font color='#f535e8'>`serviceType`</font> å±æ€§æ¥åˆ¶å®š ServiceLoader è¿”å›çš„ç±»å‹
    - æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªåŠ¨æ„å»º BeanDefinition å¹¶æ³¨å†Œåˆ° IOC å®¹å™¨ä¸­
  - è·å– ServiceLoader Bean ç»„ä»¶è¿›è¡Œæ“ä½œ

â‘ ã€ XMLé…ç½®å…ƒä¿¡æ¯

```xml
<!--ServiceLoadFactoryBean-->
<bean id="bean-specialCreation-context"
      class="org.springframework.beans.factory.serviceloader.ServiceLoaderFactoryBean"
      >
    <property name="serviceType" value="bean.factory.UserFactoryInterface"/>
</bean>
```

â‘¡ã€ ä»å®¹å™¨ä¸­è·å–ServiceLoader

```java
/**
 * <b>Bean çš„ä¸€ç§ç‰¹æ®Šå®ä¾‹åŒ–æ–¹æ³• => SPI-> ServiceLoaderFactoryBean</b>
 * @author <a href="mailto:zhuyuliangm@gmail.com">yuliang zhu</a>
 */
public class SpecialBeanInstantiationDemo {
    static final String xmlPath = "META-INF/bean-specialCreation-context.xml";

    public static void main(String[] args) throws Exception {
        BeanFactory beanFactory = new ClassPathXmlApplicationContext(xmlPath);
        ServiceLoader serviceLoader = beanFactory.getBean("bean-specialCreation-context", ServiceLoader.class);

        Iterator<UserFactoryInterface> iterator = serviceLoader.iterator();
        while(iterator.hasNext()) {
            UserFactoryInterface userFactoryInterface = iterator.next();
            // out: spi create==>User{id=22, name='lisi'}
            userFactoryInterface.createUser();
        }
    }
}
```



## Beançš„åˆå§‹åŒ–æ–¹å¼

### åŸºæœ¬è¯´æ˜

- Beançš„ç”Ÿå‘½å‘¨æœŸ( Bean çš„åˆ›å»º -> åˆå§‹åŒ– -> é”€æ¯ )

  - å®ä¾‹åŒ–ä¸€ä¸ª Bean
  - ä¸º Bean çš„å±æ€§è®¾ç½®å€¼å’Œå¯¹å…¶ä»– Bean çš„å¼•ç”¨

  - **è°ƒç”¨ Bean çš„åˆå§‹åŒ–æ–¹æ³•**
  - Bean å¯ä»¥ä½¿ç”¨äº†
  - å½“å®¹å™¨å…³é—­æ—¶, è°ƒç”¨ Bean çš„é”€æ¯æ–¹æ³•

- Bean çš„åˆ›å»ºæ¨¡å¼

  - å•ä¾‹çš„
    - ä¼šåœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™åˆ›å»º Bean å¯¹è±¡ , åŒæ—¶ä¼šè°ƒç”¨åˆå§‹åŒ–æ–¹æ³•

  - å¤šå®ä¾‹çš„  
    - ä¼šåœ¨æ¯æ¬¡è·å– Bean çš„æ—¶å€™åˆ›å»º
    - åŒæ—¶ä¹Ÿä¼šåœ¨ è·å–æ—¶è°ƒç”¨åˆå§‹åŒ–æ–¹æ³• ,ä½†æ˜¯å®¹å™¨ä¸ä¼šå°†å…¶è¿›è¡Œé”€æ¯

- Beançš„åˆå§‹åŒ–(Initialization)
  1. æ³¨è§£æ ‡æ³¨æ–¹æ³•
     - `@PostConstruct` æ ‡æ³¨æ–¹æ³•,ä½†æ˜¯è¿™ä¸ªéœ€è¦åŸºäºæ³¨è§£çš„ AnnotationConfigApplicationContext è°ƒç”¨
  2. å®ç° `InitializingBean`æ¥å£çš„ afterPropertiesSet()
     - è¡¨ç¤ºåœ¨å®Œæˆäº† Bean çš„å±æ€§è®¾ç½®ä¹‹åæ‰§è¡Œ
     - InitializingBean ç”± Spring æ¡†æ¶æä¾›,æ—¢â€œæ”¯æŒâ€ ClassPathXmlApplicationContext, ä¹Ÿâ€œæ”¯æŒâ€ AnnotationConfigApplicationContext
  3. æ‰‹åŠ¨é…ç½®åˆå§‹åŒ–æ–¹æ³•
     - XMLé…ç½®: `<bean init-method="xxx"/>`
     - java æ³¨è§£: `@Bean(initMethod=â€œxxxâ€)`
     - java api: `AbstractBeanDefinition#setInitMethodName(String)`

### @PostConstruct

> @PostConstruct æ³¨è§£æ˜¯ java æä¾›çš„æ ‡å‡†æ³¨è§£,ä¸æ˜¯ spring æä¾›çš„ã€‚

**1. å®šä¹‰ Bean å¯¹è±¡**

```java
public class UserFactoryImpl implements UserFactoryInterface{
    @Override
    public User createUser() {
        User user = new User();
        user.setId(22L);
        user.setName("lisi");
        System.out.println("spi create==>"+user);
        return user;
    }
		
    // åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸Šæ ‡è®° @PostConstruct æ³¨è§£
    @PostConstruct
    public void init() {
        System.out.println("PostConstruct UserFactoryImpl#init...");
    }
}
```

**2.æµ‹è¯•**

```java
public class PostConstructAnnotationDemo {
    public static void main(String[] args) {
        AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext();
        // æ³¨å†Œé…ç½®ç±»
        ctx.register(PostConstructAnnotationDemo.class);
        // å¯åŠ¨ Spring åº”ç”¨ä¸Šä¸‹æ–‡
        ctx.refresh();
            
        // å…³é—­ Spring åº”ç”¨ä¸Šä¸‹æ–‡
        ctx.close();
    }

    @Bean
    public UserFactoryImpl userFactory() {
        return new UserFactoryImpl();
    }
}
// è¾“å‡º: PostConstruct UserFactoryImpl#init...
```

### å®ç°InitializingBean

> è¿™é‡Œä¸»è¦ä½¿ç”¨çš„æ˜¯åŸºäº XML çš„æ–¹å¼,å¦‚æœæ˜¯æ³¨è§£çš„è¯,å’Œä¸Šé¢çš„ [@PostCostruct](Bean#postconstruct)æ“ä½œæ˜¯ç±»ä¼¼çš„,ä¸è¿‡ä¸éœ€è¦åŠ ä¸Š @PostConstruct æ³¨è§£äº†

**1ã€Bean å¯¹è±¡å®ç° InitializingBean**

```java
public class UserFactoryImpl implements UserFactoryInterface, InitializingBean {
    @Override
    public User createUser() {
        User user = new User();
        user.setId(22L);
        user.setName("lisi");
        System.out.println("spi create==>"+user);
        return user;
    }

    // å®ç°äº† InitializingBean æ¥å£çš„afterPropertiesSet()æ–¹æ³•
    @Override
    public void afterPropertiesSet() throws Exception {
        System.out.println("InitializingBean UserFactoryImpl#afterPropertiesSet...");
    }
}
```

**2.é…ç½® XML**

```xml
<bean id="bean-initializing"
      class="bean.factory.UserFactoryImpl">
</bean>
```

**3.æµ‹è¯•**

```java
public class BeanInitializingDemo {
    static final String xmlPath = "META-INF/bean-initializing-context.xml";

    public static void main(String[] args) throws Exception {
        BeanFactory beanFactory = new ClassPathXmlApplicationContext(xmlPath);
    }
}
// è¾“å‡º: InitializingBean UserFactoryImpl#afterPropertiesSet...
```



### ä¸åŒåˆå§‹åŒ–æ–¹å¼æ‰§è¡Œé¡ºåº

:::tip Beanå„ä¸ªåˆå§‹åŒ–æ–¹æ³•çš„æ‰§è¡Œé¡ºåº

**@PostConstruct æ³¨è§£æ ‡æ³¨-> å®ç°InitializingBean -> æ‰‹åŠ¨é…ç½®åˆå§‹åŒ–æ–¹æ³•**

:::

**1. Beanå¯¹è±¡**

```java
public class Person implements InitializingBean {
    String name;
    Integer age;
    public static Person createUser(){
        Person person = new Person();
        person.setName("11");
        person.setAge(22);
        return person;
    }

    /**
     * ä½¿ç”¨ {@link @PostConstruct} æ³¨è§£æ ‡è¯†çš„Bean åˆå§‹åŒ–æ–¹æ³•
     */
    @PostConstruct
    public void init(){
        System.err.println("ä½¿ç”¨@PostConstruct æ³¨è§£...");
    }

    public void  beanPostCon(){
        System.err.println("è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•:@Bean initMethod...");
    }
	
 	 // å®ç° InitializingBeançš„ afterPropertiesSetæ–¹æ³•
    @Override
    public void afterPropertiesSet() throws Exception {
        System.err.println("å®ç°SpringInitializingBean ...");
    }
}
```



**2. é€šè¿‡æ³¨è§£æ–¹å¼æ³¨å…¥Beanå¯¹è±¡**

```java
public class BeanConstructDemo {
    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªæ³¨è§£é©±åŠ¨çš„Springåº”ç”¨ä¸Šä¸‹æ–‡
        AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext();
        context.register(BeanConstructDemo.class);
        context.refresh();
        //ä¾èµ–æŸ¥æ‰¾
        Person bean = context.getBean(Person.class);
        System.out.println(bean);
        context.close();
    }

   // è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•é€šè¿‡@Bean çš„nameå±æ€§æŒ‡å®šåˆå§‹åŒ–æ–¹æ³•
    @Bean(initMethod = "beanPostCon")
    public Person person(){
        Person person = new Person();
        person.setAge(22);
        person.setName("Yoey22");
        return person;
    }
}

/*
	ä½¿ç”¨@PostConstruct æ³¨è§£...
  å®ç°SpringInitializingBean ...
  è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•:@Bean initMethod...
*/
```



### å»¶è¿Ÿåˆå§‹åŒ–çš„Bean

- <mark>Beançš„å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆLazy Initializationï¼‰</mark>
  1. XML é…ç½®: `<bean  lasy-init="true|false"/>`
  2. java æ³¨è§£: `@Lazy(true)`
  3. java api

:::danger å»¶è¿Ÿåˆå§‹åŒ–ä¸éå»¶è¿Ÿåˆå§‹åŒ–çš„åŒºåˆ«ï¼Ÿ

- å»¶è¿Ÿåˆå§‹åŒ–çš„Bean
  - **åªæœ‰åœ¨è·å– Bean çš„æ—¶å€™è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•**
  - å¦‚æœæœ‰å…¶ä»–éå»¶è¿ŸåŠ è½½çš„Beanä¾èµ–äºè¿™ä¸ªBeanï¼Œä¹Ÿä¼šç«‹å³å¯¹è¿™ä¸ªBeanåˆå§‹åŒ–
- éå»¶è¿Ÿåˆå§‹åŒ–
  - åœ¨Springåº”ç”¨ä¸Šä¸‹æ–‡å¯åŠ¨å®Œæˆå,å°±ä¼šè°ƒç”¨åˆå§‹åŒ–æ–¹æ³•

:::

**å»¶è¿ŸåŠ è½½çš„Bean**

å¯ä»¥çœ‹åˆ°ï¼Œå®¹å™¨åˆ·æ–°çš„æ—¶å€™æ²¡æœ‰å¯¹Beanè¿›è¡Œåˆå§‹åŒ–,åªæ˜¯å°†Beanæ³¨å†Œåˆ°å®¹å™¨ï¼Œå½“å°è¯•ä»å®¹å™¨ä¸­è·å–Beançš„æ—¶å€™æ‰ä¼šå¯¹Beanè¿›è¡Œåˆå§‹åŒ–

```java
public class AnnotationBeanFactoryDemo {
    public static void main(String[] args) {
        AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext();
        ctx.register(AnnotationBeanFactoryDemo.class);
        System.out.println("refresh start...");
        ctx.refresh();
        System.out.println("refresh end...");
        Iterator<String> iterator = ctx.getBeanFactory().getBeanNamesIterator();
        while (iterator.hasNext()){
            String next = iterator.next();
            System.out.println(next);
        }
        System.out.println("-----");
        User user = (User)ctx.getBean("user");
        ctx.close();

    }
    @Lazy //Bean çš„æ‡’åŠ è½½
    @Bean
    public User user(){
        User user  = new User(33,"create by DefaultUserFactory");
        user.setName("create by DefaultUserFactory");
        user.setAge(33);
        return user;
    }
}

/*
refresh start...
refresh end...
org.springframework.context.annotation.internalConfigurationAnnotationProcessor
org.springframework.context.annotation.internalAutowiredAnnotationProcessor
org.springframework.context.annotation.internalCommonAnnotationProcessor
org.springframework.context.event.internalEventListenerProcessor
org.springframework.context.event.internalEventListenerFactory
annotationBeanFactoryDemo
user
environment
systemProperties
systemEnvironment
org.springframework.context.annotation.ConfigurationClassPostProcessor.importRegistry
messageSource
applicationEventMulticaster
lifecycleProcessor
-----
// è¿™ç±»å¯ä»¥çœ‹åˆ°ä½¿ç”¨äº† @Lazy å¯¹ Bean çš„åˆå§‹åŒ–è¿›è¡Œå»¶è¿Ÿå,åªæœ‰åœ¨è¿›è¡Œä¾èµ–æŸ¥æ‰¾çš„æ—¶å€™æ‰ä¼šè¿›è¡Œ Bean çš„å®ä¾‹åŒ–+åˆå§‹åŒ–
User æœ‰å‚æ„é€ å™¨è°ƒç”¨...
åˆå§‹åŒ– User name å±æ€§...
åˆå§‹åŒ– User age å±æ€§...
@PostConstruct ....
afterPropertiesSet ....
*/
```



## Beançš„é”€æ¯æ–¹å¼

> ä¸Bean çš„åˆå§‹åŒ–ç›¸å¯¹åº”çš„æœ‰ Bean çš„é”€æ¯,åœ¨ä½¿ç”¨æ–¹å¼ä¸Šä¸ Bean çš„åˆå§‹åŒ–åŸºæœ¬ç±»ä¼¼

- Beançš„é”€æ¯
  1. æ³¨è§£æ ‡æ³¨æ–¹æ³•
     - ä½¿ç”¨`@PreDestroy`æ³¨è§£æ ‡æ³¨æ–¹æ³•
  2. å®ç°`DisposableBean`æ¥å£çš„ destroy()æ–¹æ³•
  3. æ‰‹åŠ¨é…ç½®é”€æ¯æ–¹æ³•
     - XMLé…ç½®: `<bean destroy="xxx"/>`
     - java æ³¨è§£: `@Bean(destroy="xxx")`
     - Java api: `AbstractBeanDefinition#setDestroyMethodName(String)`
- Beanå„ä¸ªé”€æ¯æ–¹æ³•çš„æ‰§è¡Œé¡ºåº
  - **@PreDestroy -> å®ç°DisposableBean -> æ‰‹åŠ¨é…ç½®é”€æ¯æ–¹æ³•**
  

:::caution IOCå®¹å™¨çš„Beanèƒ½å¤Ÿè¢«åƒåœ¾å›æ”¶å—ï¼Ÿ

å¯ä»¥ï¼Œé€šè¿‡**å…³é—­Springå®¹å™¨(åº”ç”¨ä¸Šä¸‹æ–‡)**

åƒåœ¾å›æ”¶çš„æ­¥éª¤:

1. å…³é—­ Spring å®¹å™¨(ä¸Šä¸‹æ–‡)
2. æ‰§è¡Œ GC
3. Spring Bean è¦†ç›– finalize æ–¹æ³•è¢«å›è°ƒ

:::





