---
id: Web MVC 核心
title: Web MVC 核心
cssclasses:
  - wide-page
---
## SpringMvc 架构

### 基础架构-Servlet

![Servlet架构](./image/Mvc/Servlet架构.webp)

Servlet 有以下的特点:

1. 请求模式: 请求/响应式(Request/Response)
2. 会屏蔽网络通信的细节,无需关注底层请求的处理
3. 包含完整的生命周期

Servlet 有以下的职责:

1. 处理请求
2. 资源管理 (连接数据库,处理本地资源...)
3. 视图的渲染

### 核心架构-前端控制器

> SpringMvc 核心架构使用 *前端控制器(FrontController)* 的模式

![前端控制器](./image/Mvc/前端控制器.webp)

- 大致流程
  - 首先客户端发送请求给前端控制器(FrontController)
  - 然后前端控制器将请求"委派"给应用控制器(ApplicationController)处理
  - 应用控制器收到请求后会将请求转发给具体的视图(View),同时还可能会执行某个服务,并将该服务产生的数据给到视图去"渲染"
- SpringMVC 中的具体实现类: `DispatcherServlet`

### SpringMvc 架构

![SpringMvc 架构](./image/Mvc/SpringMvc架构.webp)

## 认识 SpringMvc

### 一般认识

一般情况下,我们需要通过以下步骤来处理一个 http 请求:

1. 实现 Controller
2. 配置 Web MVC 组件
    - ComponentScan
    - RequestMappingHandlerMapping
    - RequestMappingHandlerAdapter
    - InternalResourceViewResolver
3. 部署 DispatcherServlet

首先需要创建一个 Controller:

```java
@Controller  
public class AddressController {  
    /**  
     * 返回一个 View 的字符串名称  
     */  
    @GetMapping("")  
    public String index() {  
        return "index";  
    }  
}
```

然后在 webapp 目录下创建 WEB-INF/jsp 目录,用于存放 jsp 文件,然后新建 `WEB-INF/app-context.xml` 文件,也就是 MVC 的应用上下文配置文件

```xml
<?xml version="1.0" encoding="UTF-8"?>  
<beans xmlns="http://www.springframework.org/schema/beans"  
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"  
       xmlns:context="http://www.springframework.org/schema/context"  
       xsi:schemaLocation="  
        http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://www.springframework.org/schema/context        http://www.springframework.org/schema/context/spring-context.xsd">  
  
    <!--配置组件扫描-->  
    <context:component-scan base-package="com.pacos"/>  
  
    <!--配置 RequestMappingHandler-->    <bean class="org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping"/>  
    <bean class="org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter"/>  
  
    <!--配置视图解析器:jsp-->  
    <bean class="org.springframework.web.servlet.view.InternalResourceViewResolver">  
        <!-- 相对于 webapp 目录下-->  
        <property name="prefix" value="/WEB-INF/jsp/"/>  
        <property name="suffix" value=".jsp"/>  
    </bean>  
</beans>
```

最后在 webapp 下新建 web.xml, 来配置 `DispatcherServlert`

```xml
<web-app>
    <servlet>
        <servlet-name>app</servlet-name>
        <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
        <load-on-startup>1</load-on-startup>
        <init-param>
            <param-name>contextConfigLocation</param-name>
            <param-value>/WEB-INF/app-context.xml</param-value>
        </init-param>
    </servlet>
    <servlet-mapping>
        <servlet-name>app</servlet-name>
        <url-pattern>/</url-pattern>
    </servlet-mapping>
</web-app>
```

### 重新认识

#### 核心组件

1. 处理器管理
    - 映射: `HandlerMapping`
    - 适配器: `HandlerAdapter`
    - 执行链: `HandlerExecutionChain`
2. 页面渲染
    - 视图解析: `ViewResolver`
    - 国际化: `LocaleResolver`、`LocalContextResolver`
    - 个性化: `ThemeResolver`
3. 异常处理
    - 异常解析: `HandlerExceptionResolver`

下面是组件的说明:

1. [HandlerMapping](https://docs.spring.io/spring/docs/5.2.2.RELEASE/spring-framework-reference/web.html#mvc-handlermapping)
   - 请求(Request) 与 处理器(Handler)和拦截器 (HandlerInterceptor) 的映射列表，其映射关系基于不同的 `HandlerMapping` 有不同的实现细节
     - Handler 就是自定义的处理方法
   - 有两种主要的 HandlerMapping 实现:
     - `RequestMappingHandlerMapping` :支持标注 `@RequestMapping` 的方法
     - SimpleUrlHandlerMapping:  维护精确的URI 路径与处理器的映射
2. HandlerAdapter
   - 帮助 `DispatcherServlet` 调用请求处理器(Handler), 无需关注其中实际的调用细节。比如，调用注解实现的 Controller 需要解析其关联的注解
   - **HandlerAdapter 的主要目的是为了屏蔽与 `DispatcherServlet` 之间的诸多细节**
3. [HandlerExceptionResolver](https://docs.spring.io/spring/docs/5.2.2.RELEASE/spring-framework-reference/web.html#mvc-exceptionhandlers)
   - 解析异常
   - 可能策略是将异常处理映射到其他处理器(Handlers), 或到某个 HTML 错误页面,或者其他
4. [ViewResolver](https://docs.spring.io/spring/docs/5.2.2.RELEASE/spring-framework-reference/web.html#mvc-viewresolver)
   - 从处理器(Handler)返回字符类型的逻辑视图名称解析出实际的 `View` 对象,该对象将渲染后的内容输出到HTTP 响应中
5. LocaleResolver、LocaleContextResolver
   - 从客户端解析出 `Locale`, 为其实现国际化视图
6. [MultipartResolver](https://docs.spring.io/spring/docs/5.2.2.RELEASE/spring-framework-reference/web.html#mvc-multipart)
   - 解析多部分请求(如 Web 浏览器文件上传)的抽象实现

组件之间的交互在 `DispatcherServlet#doDispatch`,其中的大致流程如下:

![交互流程](./image/Mvc/交互流程.webp)

#### 注解驱动

> 注解驱动下, 通过以下的注解、类来拓展 SpringMvc

1. 配置注解: `@Configuration`
2. 组件激活: `@EnableWebMvc`
    - 该注解会注册一些核心组件,比如*RequestMappingHandlerMapping*、*RequestMappingHandlerAdapter*...
3. 自定义组件: WebMvcConfiguration,用于注册核心组件

下面是 @EnableWebMvc 注解的基本处理功能:

```java
// @EnableWebMvc 注解
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
@Documented
@Import(DelegatingWebMvcConfiguration.class)
public @interface EnableWebMvc {
}

// DelegatingWebMvcConfiguration 类
@Bean
public RequestMappingHandlerMapping requestMappingHandlerMapping(...) {
  // ... [注册 RequestMappingHandlerMapping]
}

@Bean
@Nullable
public HandlerMapping viewControllerHandlerMapping() {
  // ... [注册 HandlerMapping]
}

@Bean
public RequestMappingHandlerAdapter requestMappingHandlerAdapter(...){
  // ... [注册 RequestMappingHandlerAdapter]
}

// ...
```

下面使用注解的方式修改[代码](Web%20MVC%20核心#一般认识):

首先定义一个 SpringMvc 的配置注解类,@EnableWebMvc 默认 注册的 ViewResolver 没有配置 prefix 和 suffix,需要调整:

```java
/**
 * SpringMvc 的配置注解类
 *
 * @author <a href="mailto:zhuyuliangm@gmail.com">yuliang zhu</a>
 *
 * @see Configuration
 * @see EnableWebMvc
 */

@Configuration
@EnableWebMvc
public class WebMvcConfig {
    @Bean
    public ViewResolver viewResolver() {
        InternalResourceViewResolver viewResolver = new InternalResourceViewResolver();
        viewResolver.setPrefix("/WEB-INF/jsp/");
        viewResolver.setSuffix(".jsp");
        return viewResolver;
    }
}
```

然后在 WEB-INF 下 的 SpringMvc 应用上下文配置文件中,配置启用包扫描(也会启用注解功能)

```xml
<!--配置组件扫描-->
<context:component-scan base-package="com.pacos"/>
```
